---
title: "7.4. ArgoCD y GitOps"
description: "Despliegue continuo declarativo con ArgoCD en Kubernetes"
icon: "arrows-rotate"
---

## ğŸ¯ DescripciÃ³n General

ArgoCD es la herramienta de **GitOps** que gestiona el despliegue continuo de aplicaciones en el cluster EKS. Garantiza que el estado del cluster siempre refleje lo definido en Git.

<Info>
**GitOps**: Git como Ãºnica fuente de verdad. Cualquier cambio en los manifiestos se aplica automÃ¡ticamente al cluster.
</Info>

## ğŸ“¦ VersiÃ³n Instalada

- **ArgoCD**: v2.9.3
- **InstalaciÃ³n**: Helm Chart
- **Namespace**: `argocd`
- **Acceso**: https://retrogamehub.games/argocd

## ğŸ” AutenticaciÃ³n

### OAuth2 con GitHub
ArgoCD estÃ¡ protegido con autenticaciÃ³n OAuth2 usando GitHub:

```yaml
server:
  ingress:
    annotations:
      nginx.ingress.kubernetes.io/auth-signin: "https://oauth2.retrogamehub.games/oauth2/start"
      nginx.ingress.kubernetes.io/auth-url: "https://oauth2.retrogamehub.games/oauth2/auth"
```

**Usuarios autorizados**: Definidos en OAuth2 Proxy ConfigMap

### Credenciales Admin

<Warning>
Credenciales solo para emergencias. Usa GitHub OAuth2 para acceso normal.
</Warning>

```bash
# Usuario
admin

# Password (obtener)
kubectl get secret argocd-initial-admin-secret -n argocd \
  -o jsonpath="{.data.password}" | base64 -d
```

## ğŸ—ï¸ Aplicaciones Desplegadas

### Backend Application
```yaml
# argocd/apps/backend-app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: backend
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/retrogamecloud/infrastructure.git
    targetRevision: main
    path: k8s/backend
  destination:
    server: https://kubernetes.default.svc
    namespace: retrogame
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas
```

**CaracterÃ­sticas**:
- âœ… Auto-sync habilitado (polling cada 3 minutos)
- âœ… Self-heal: Revierte cambios manuales
- âœ… Prune: Elimina recursos borrados del Git
- âœ… Ignora diferencias en rÃ©plicas (permite escalado manual temporal)

### Frontend Application
```yaml
# argocd/apps/frontend-app.yaml
metadata:
  name: frontend
spec:
  source:
    path: k8s/frontend
  # Resto similar a backend
```

### Kong Gateway Application
```yaml
# argocd/apps/kong-app.yaml
metadata:
  name: kong
spec:
  source:
    path: k8s/kong
  # Resto similar a backend
```

## ğŸ¥ Health Checks Personalizados

ArgoCD usa health checks personalizados para detectar mejor el estado de los Deployments:

```yaml
# argocd/health-checks/argocd-cm-health.yaml
data:
  resource.customizations.health.apps_Deployment: |
    hs = {}
    hs.status = "Progressing"
    
    if obj.status.conditions then
      for i, condition in ipairs(obj.status.conditions) do
        -- Detectar fallo de deployment
        if condition.type == "Progressing" and 
           condition.reason == "ProgressDeadlineExceeded" then
          hs.status = "Degraded"
          hs.message = condition.message
          return hs
        end
        
        -- Detectar deployment exitoso
        if condition.type == "Progressing" and 
           condition.reason == "NewReplicaSetAvailable" then
          hs.status = "Healthy"
          return hs
        end
      end
    end
    
    -- Verificar que todas las rÃ©plicas estÃ¡n listas
    if obj.status.replicas == obj.status.updatedReplicas and
       obj.status.availableReplicas == obj.status.replicas then
      hs.status = "Healthy"
      hs.message = "All replicas are ready"
    end
    
    return hs
    
  timeout.reconciliation: "180s"
```

**Mejoras**:
- âœ… Detecta `ProgressDeadlineExceeded` â†’ Estado `Degraded`
- âœ… Verifica que todas las rÃ©plicas estÃ©n realmente listas
- âœ… Timeout de 180s para deployments lentos

## ğŸ“¢ Notificaciones a Slack

ArgoCD envÃ­a notificaciones automÃ¡ticas al canal `#argocdretrogame`:

### ConfiguraciÃ³n
```yaml
# argocd/notifications/argocd-notifications-cm.yaml
data:
  service.slack: |
    apiURL: https://hooks.slack.com/services/T09UHLJLU1E/B09UJS3DR6Y/...
  
  # 3 Triggers configurados
  trigger.on-deployed: |
    - send: [app-deployed]
      when: app.status.operationState.phase == 'Succeeded' and 
            app.status.health.status == 'Healthy'
  
  trigger.on-sync-failed: |
    - send: [app-sync-failed]
      when: app.status.operationState.phase in ['Error', 'Failed']
  
  trigger.on-health-degraded: |
    - send: [app-health-degraded]
      when: app.status.health.status == 'Degraded'
```

### Tipos de Notificaciones

<CardGroup cols={3}>
  <Card title="âœ… Deployed" icon="check" color="#2eb886">
    AplicaciÃ³n desplegada exitosamente
  </Card>
  <Card title="âŒ Sync Failed" icon="xmark" color="#e01e5a">
    Fallo en la sincronizaciÃ³n
  </Card>
  <Card title="âš ï¸ Degraded" icon="triangle-exclamation" color="#ecb22e">
    AplicaciÃ³n en estado degradado
  </Card>
</CardGroup>

## ğŸ”„ Flujo GitOps

```mermaid
sequenceDiagram
    participant Dev as Developer
    participant Git as GitHub
    participant ArgoCD
    participant K8s as Kubernetes
    participant Slack
    
    Dev->>Git: 1. Push cambios a main
    Note over Git: k8s/backend/deployment.yaml
    
    Note over ArgoCD: 2. Polling cada 3 min
    ArgoCD->>Git: Check for changes
    Git-->>ArgoCD: New commit detected
    
    ArgoCD->>ArgoCD: 3. Compare Git vs Cluster
    Note over ArgoCD: Diff detected
    
    ArgoCD->>K8s: 4. Apply manifests
    K8s->>K8s: Rolling update
    
    alt Deployment OK
        K8s-->>ArgoCD: Sync successful
        ArgoCD->>Slack: âœ… Deployed notification
    else Deployment Failed
        K8s-->>ArgoCD: Sync failed
        ArgoCD->>K8s: Rollback
        ArgoCD->>Slack: âŒ Failed notification
    end
```

## ğŸ“ Estructura de Repositorio

```bash
infrastructure/
â”œâ”€â”€ argocd/
â”‚   â”œâ”€â”€ apps/
â”‚   â”‚   â”œâ”€â”€ backend-app.yaml       # Backend application
â”‚   â”‚   â”œâ”€â”€ frontend-app.yaml      # Frontend application
â”‚   â”‚   â””â”€â”€ kong-app.yaml          # Kong gateway application
â”‚   â”œâ”€â”€ health-checks/
â”‚   â”‚   â””â”€â”€ argocd-cm-health.yaml  # Custom health checks
â”‚   â””â”€â”€ notifications/
â”‚       â”œâ”€â”€ argocd-notifications-cm.yaml    # Slack config
â”‚       â””â”€â”€ README.md                       # Setup guide
â””â”€â”€ k8s/
    â”œâ”€â”€ backend/
    â”‚   â”œâ”€â”€ deployment.yaml
    â”‚   â”œâ”€â”€ service.yaml
    â”‚   â””â”€â”€ secrets.yaml
    â”œâ”€â”€ frontend/
    â”‚   â”œâ”€â”€ deployment.yaml
    â”‚   â””â”€â”€ service.yaml
    â””â”€â”€ kong/
        â”œâ”€â”€ deployment.yaml
        â”œâ”€â”€ service.yaml
        â””â”€â”€ configmap.yaml
```

## ğŸ› ï¸ Comandos Ãštiles

### Ver Estado de Aplicaciones
```bash
# CLI
kubectl get applications -n argocd

# Salida
# NAME       SYNC STATUS   HEALTH STATUS
# backend    Synced        Healthy
# frontend   Synced        Healthy
# kong       Synced        Healthy
```

### Forzar SincronizaciÃ³n Manual
```bash
# Desde UI: Click en "SYNC" en la aplicaciÃ³n

# Desde CLI (si instalas argocd CLI)
argocd app sync backend --force
```

### Ver Logs de ArgoCD
```bash
# Application Controller
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-application-controller

# Notifications Controller
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-notifications-controller

# Server
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-server
```

### Reiniciar Componentes
```bash
# Restart all ArgoCD
kubectl rollout restart deployment -n argocd

# Solo server (UI)
kubectl rollout restart deployment argocd-server -n argocd

# Solo notifications
kubectl rollout restart deployment argocd-notifications-controller -n argocd
```

## ğŸ”§ ConfiguraciÃ³n vs Terraform

<Warning>
Los recursos de Kubernetes antes gestionados por Terraform ahora estÃ¡n **comentados** en `terraform/eks/kubernetes.tf` para evitar conflictos con ArgoCD.
</Warning>

### Recursos Comentados (Gestionados por ArgoCD)
- âœ… `kubernetes_deployment.backend`
- âœ… `kubernetes_service.backend`
- âœ… `kubernetes_deployment.frontend`
- âœ… `kubernetes_service.frontend`
- âœ… `kubernetes_deployment.kong`
- âœ… `kubernetes_service.kong`

### Recursos en Terraform (No gestionados por ArgoCD)
- âœ… `kubernetes_namespace.retrogame`
- âœ… `kubernetes_secret.jwt_secret`
- âœ… `kubernetes_config_map.frontend_replacer`
- âœ… Ingresses y Route53
- âœ… RDS, S3, CloudFront

**Rollback**: Descomentar recursos en `kubernetes.tf` y ejecutar:
```bash
cd terraform/eks
terraform apply
```

## ğŸ¯ Ventajas de GitOps con ArgoCD

<CardGroup cols={2}>
  <Card title="ğŸ”„ SincronizaciÃ³n AutomÃ¡tica" icon="arrows-rotate">
    Cambios en Git se aplican automÃ¡ticamente cada 3 minutos
  </Card>
  <Card title="ğŸ”™ Rollback FÃ¡cil" icon="clock-rotate-left">
    Revert del commit = rollback automÃ¡tico
  </Card>
  <Card title="ğŸ‘ï¸ Visibilidad Completa" icon="eye">
    UI visual del estado real vs deseado
  </Card>
  <Card title="ğŸ” AuditorÃ­a" icon="file-shield">
    Todo cambio queda registrado en Git
  </Card>
  <Card title="ğŸ›¡ï¸ Self-Healing" icon="shield">
    Revierte cambios manuales no autorizados
  </Card>
  <Card title="ğŸ“¢ Notificaciones" icon="bell">
    Alertas en Slack de cada deployment
  </Card>
</CardGroup>

## ğŸ› Troubleshooting

### AplicaciÃ³n OutOfSync

**Problema**: La aplicaciÃ³n muestra estado `OutOfSync`

**SoluciÃ³n**:
```bash
# Ver diferencias
kubectl get application backend -n argocd -o yaml

# Sincronizar manualmente
kubectl patch application backend -n argocd \
  --type merge -p '{"operation":{"sync":{"revision":"HEAD"}}}'
```

### Self-Heal No Funciona

**Verificar sync policy**:
```bash
kubectl get application backend -n argocd -o jsonpath='{.spec.syncPolicy.automated}'
# Debe mostrar: {"prune":true,"selfHeal":true}
```

### Notificaciones No Llegan

**Ver logs**:
```bash
kubectl logs -n argocd -l app.kubernetes.io/name=argocd-notifications-controller --tail=50
```

**Probar webhook manualmente**:
```bash
curl -X POST https://hooks.slack.com/services/... \
  -H 'Content-Type: application/json' \
  -d '{"text":"Test desde ArgoCD"}'
```

## ğŸ“š Referencias

- [ArgoCD Documentation](https://argo-cd.readthedocs.io/)
- [GitOps Principles](https://opengitops.dev/)
- [Health Assessment](https://argo-cd.readthedocs.io/en/stable/operator-manual/health/)
- [Notifications Catalog](https://argo-cd.readthedocs.io/en/stable/operator-manual/notifications/catalog/)

<Note>
**PrÃ³ximas mejoras**: ApplicationSets para gestionar mÃºltiples aplicaciones, Argo Rollouts para progressive delivery.
</Note>
