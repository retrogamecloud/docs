---
title: 4.3. Cluster EKS
description: Configuración detallada del cluster de Kubernetes en AWS
icon: dharmachakra
---

## 4.3.1. Visión General

El cluster EKS es el corazón de la infraestructura de Retro Game Hub. Proporciona orquestación de contenedores, auto-escalado y alta disponibilidad para todos los servicios de la plataforma.

## 4.3.2. Especificaciones del Cluster

<CardGroup cols={2}>
  <Card title="Versión Kubernetes" icon="dharmachakra">
    **v1.34**

    Última versión estable con soporte extendido de AWS
  </Card>

  <Card title="Región" icon="globe">
    **eu-west-1 (Irlanda)**

    Latencia óptima para Europa
  </Card>

  <Card title="Zonas de Disponibilidad" icon="server">
    **3 AZs**

    eu-west-1a, eu-west-1b, eu-west-1c
  </Card>

  <Card title="Endpoint" icon="link">
    **Privado + Público**

    Accesible desde VPC e Internet
  </Card>
</CardGroup>

## 4.3.3. Configuración de Terraform

<CodeGroup>

```hcl eks.tf
module "eks" {
  source  = "terraform-aws-modules/eks/aws"
  version = "~> 19.0"

  cluster_name    = var.cluster_name
  cluster_version = var.k8s_version

  # Endpoint de acceso
  cluster_endpoint_public_access  = true
  cluster_endpoint_private_access = true

  # Encriptación de secretos con KMS
  cluster_encryption_config = {
    provider_key_arn = aws_kms_key.eks.arn
    resources        = ["secrets"]
  }

  # Logging del cluster
  cluster_enabled_log_types = [
    "api",
    "audit",
    "authenticator",
    "controllerManager",
    "scheduler"
  ]

  # VPC y subredes
  vpc_id                   = module.vpc.vpc_id
  subnet_ids               = module.vpc.private_subnets
  control_plane_subnet_ids = module.vpc.private_subnets

  # Addons del cluster
  cluster_addons = {
    coredns = {
      most_recent = true
    }
    kube-proxy = {
      most_recent = true
    }
    vpc-cni = {
      most_recent = true
    }
    aws-ebs-csi-driver = {
      most_recent              = true
      service_account_role_arn = aws_iam_role.ebs_csi_driver.arn
    }
  }

  # Node groups
  eks_managed_node_groups = {
    main = {
      min_size     = 2
      max_size     = 10
      desired_size = 3

      instance_types = ["t3.medium"]
      capacity_type  = "ON_DEMAND"

      k8s_labels = {
        Environment = var.environment
        NodeGroup   = "main"
      }

      update_config = {
        max_unavailable_percentage = 25
      }

      tags = {
        ExtraTag = "eks-node-group-main"
      }
    }

    gaming = {
      min_size     = 1
      max_size     = 5
      desired_size = 2

      instance_types = ["c5.large"]
      capacity_type  = "SPOT"

      k8s_labels = {
        Environment = var.environment
        NodeGroup   = "gaming"
        Workload    = "game-servers"
      }

      taints = {
        dedicated = {
          key    = "gaming"
          value  = "true"
          effect = "NO_SCHEDULE"
        }
      }
    }
  }

  tags = var.tags
}
```

```hcl variables.tf
variable "cluster_name" {
  description = "Nombre del cluster EKS"
  type        = string
  default     = "retro-game-hub"
}

variable "k8s_version" {
  description = "Versión de Kubernetes"
  type        = string
  default     = "1.34"
}

variable "environment" {
  description = "Entorno de despliegue"
  type        = string
  default     = "production"
}
```

```hcl kms.tf
resource "aws_kms_key" "eks" {
  description             = "EKS Secret Encryption Key"
  deletion_window_in_days = 7
  enable_key_rotation     = true

  tags = merge(var.tags, {
    Name = "${var.cluster_name}-eks-key"
  })
}

resource "aws_kms_alias" "eks" {
  name          = "alias/${var.cluster_name}-eks"
  target_key_id = aws_kms_key.eks.key_id
}
```

</CodeGroup>

## 4.3.4. Node Groups

### 4.3.4.1. Main Node Group

<Card title="Configuración Principal" icon="server">
- **Tipo de instancia**: t3.medium
- **Capacidad**: 2-10 nodos (3 deseados)
- **Tipo de capacidad**: ON_DEMAND
- **Propósito**: Cargas de trabajo generales
</Card>

### 4.3.4.2. Gaming Node Group

<Card title="Configuración de Gaming" icon="gamepad">
- **Tipo de instancia**: c5.large
- **Capacidad**: 1-5 nodos (2 deseados)
- **Tipo de capacidad**: SPOT
- **Propósito**: Servidores de juegos dedicados
</Card>

## 4.3.5. Addons del Cluster

<CardGroup cols={2}>
  <Card title="CoreDNS" icon="dns">
    **Resolución DNS**

    DNS interno para servicios de Kubernetes
  </Card>

  <Card title="VPC CNI" icon="network-wired">
    **Networking**

    Plugin de red nativo de AWS
  </Card>

  <Card title="Kube-proxy" icon="share">
    **Proxy de red**

    Balanceo de carga interno
  </Card>

  <Card title="EBS CSI Driver" icon="hard-drive">
    **Almacenamiento**

    Volúmenes persistentes con EBS
  </Card>
</CardGroup>

## 4.3.6. Seguridad y Acceso

### 4.3.6.1. RBAC

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: retro-game-hub-admin
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: retro-game-hub-admin-binding
subjects:
- kind: User
  name: admin@retrogamehub.com
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: retro-game-hub-admin
  apiGroup: rbac.authorization.k8s.io
```

### 4.3.6.2. Service Accounts

<CodeGroup>

```yaml aws-load-balancer-controller.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aws-load-balancer-controller
  namespace: kube-system
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/AmazonEKSLoadBalancerControllerRole
```

```yaml external-dns.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-dns
  namespace: kube-system
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/ExternalDNSRole
```

</CodeGroup>

## 4.3.7. Logging y Monitoreo

### 4.3.7.1. CloudWatch Logs

El cluster EKS envía logs a CloudWatch en los siguientes grupos:

- `/aws/eks/{cluster-name}/cluster/api`
- `/aws/eks/{cluster-name}/cluster/audit`
- `/aws/eks/{cluster-name}/cluster/authenticator`
- `/aws/eks/{cluster-name}/cluster/controllerManager`
- `/aws/eks/{cluster-name}/cluster/scheduler`

### 4.3.7.2. Métricas

<Card title="Container Insights" icon="chart-line">
**AWS Container Insights** proporciona métricas detalladas de:
- CPU y memoria por nodo y pod
- Utilización de red
- Almacenamiento
- Performance de aplicaciones
</Card>

## 4.3.8. Auto-escalado

### 4.3.8.1. Cluster Autoscaler

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-autoscaler
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cluster-autoscaler
  template:
    metadata:
      labels:
        app: cluster-autoscaler
    spec:
      serviceAccountName: cluster-autoscaler
      containers:
      - image: k8s.gcr.io/autoscaling/cluster-autoscaler:v1.34.0
        name: cluster-autoscaler
        resources:
          limits:
            cpu: 100m
            memory: 300Mi
          requests:
            cpu: 100m
            memory: 300Mi
        command:
        - ./cluster-autoscaler
        - --v=4
        - --stderrthreshold=info
        - --cloud-provider=aws
        - --skip-nodes-with-local-storage=false
        - --expander=least-waste
        - --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/retro-game-hub
```

### 4.3.8.2. Horizontal Pod Autoscaler

<Info>
HPA se configura por aplicación usando métricas de CPU, memoria y métricas personalizadas basadas en la carga de jugadores activos.
</Info>

## 4.3.9. Disaster Recovery

### 4.3.9.1. Backups

- **Velero**: Backup automatizado de recursos de Kubernetes
- **EBS Snapshots**: Backup de volúmenes persistentes
- **Configuración**: Respaldada en Git y Terraform state

### 4.3.9.2. Procedimiento de Recuperación

<Steps>
  <Step title="Recrear Cluster">
    Ejecutar `terraform apply` para recrear la infraestructura
  </Step>
  <Step title="Restaurar Aplicaciones">
    Usar Velero para restaurar aplicaciones y datos
  </Step>
  <Step title="Verificar Servicios">
    Validar que todos los servicios estén funcionando correctamente
  </Step>
  <Step title="Actualizar DNS">
    Verificar y actualizar registros DNS si es necesario
  </Step>
</Steps>

## 4.3.10. Costos Estimados

<CardGroup cols={3}>
  <Card title="Control Plane" icon="dollar-sign">
    **$73/mes**

    Por cluster (fijo)
  </Card>

  <Card title="Node Groups" icon="calculator">
    **$150-500/mes**

    Basado en utilización
  </Card>

  <Card title="Almacenamiento" icon="database">
    **$20-80/mes**

    EBS y snapshots
  </Card>
</CardGroup>

<Warning>
Los costos pueden variar significativamente basados en la utilización real y el número de jugadores activos. Se recomienda monitorear y optimizar regularmente.
</Warning>