---
title: 5.1. Autenticación OAuth2 con GitHub
description: Protección de herramientas de monitoreo con OAuth2-Proxy y GitHub usando Authorization Code Grant con PKCE
icon: lock
---

## Arquitectura de Autenticación

Retro Game Hub protege el acceso a Grafana, Prometheus y AlertManager usando **OAuth2-Proxy** con autenticación de GitHub, permitiendo solo usuarios autorizados de la organización `retrogamecloud`.

<CardGroup cols={3}>
  <Card title="OAuth2-Proxy" icon="shield-halved">
    **Capa de Auth**

    Intercepta requests
  </Card>

  <Card title="GitHub OAuth" icon="github">
    **Identity Provider**

    Valida usuarios
  </Card>

  <Card title="Ingress NGINX" icon="route">
    **Routing**

    Annotations para auth
  </Card>
</CardGroup>

## Flujo OAuth2 Authorization Code Grant con PKCE

### Flujo Completo de Autenticación

```mermaid
sequenceDiagram
    participant U as Usuario
    participant F as Frontend/OAuth2-Proxy
    participant N as Ingress NGINX
    participant G as GitHub OAuth
    participant M as Monitoreo (Grafana)

    Note over U,M: 1. Inicio del proceso de autenticación

    U->>F: Click "Login" en https://grafana.retrogamehub.com
    
    Note over F: 2. Generación PKCE
    F->>F: code_verifier = random(128 chars)
    F->>F: code_challenge = SHA256(code_verifier)
    F->>F: method = "S256"

    Note over F,G: 3. Authorization Request con PKCE

    F-->>U: 302 Redirect → GitHub Authorization
    Note right of F: https://github.com/login/oauth/authorize<br/>?response_type=code<br/>&client_id=CLIENT_ID<br/>&redirect_uri=CALLBACK_URL<br/>&scope=user:email,read:org<br/>&state=CSRF_TOKEN<br/>&code_challenge=CODE_CHALLENGE<br/>&code_challenge_method=S256

    Note over U,G: 4. Autorización del usuario

    U->>G: GET /login/oauth/authorize (con parámetros)
    G-->>U: Formulario de login GitHub
    U->>G: Credenciales GitHub
    G-->>U: Página de autorización de la app
    U->>G: Autoriza aplicación

    Note over G,F: 5. Authorization Code Response

    G-->>U: 302 Redirect → /oauth2/callback
    Note right of G: ?code=AUTHORIZATION_CODE<br/>&state=CSRF_TOKEN
    U->>F: GET /oauth2/callback?code=AUTH_CODE&state=STATE

    Note over F: 6. Validaciones de seguridad
    F->>F: Valida state = CSRF_TOKEN
    F->>F: Extrae code_verifier del storage

    Note over F,G: 7. Token Exchange con PKCE

    F->>G: POST /login/oauth/access_token
    Note right of F: Content-Type: application/x-www-form-urlencoded<br/>grant_type=authorization_code<br/>&code=AUTHORIZATION_CODE<br/>&redirect_uri=CALLBACK_URL<br/>&client_id=CLIENT_ID<br/>&code_verifier=CODE_VERIFIER

    Note over G: 8. Verificación PKCE
    G->>G: Recalcula: SHA256(code_verifier) == code_challenge
    G->>G: Valida authorization_code

    G-->>F: 200 OK + JSON Response
    Note left of G: {<br/>  "access_token": "ACCESS_TOKEN",<br/>  "token_type": "bearer",<br/>  "expires_in": 28800,<br/>  "refresh_token": "REFRESH_TOKEN",<br/>  "scope": "user:email,read:org"<br/>}

    Note over F: 9. Almacenamiento seguro de tokens
    F->>F: Guarda tokens en httpOnly cookie/session
    F->>F: Limpia code_verifier del storage

    Note over F,G: 10. Validación de usuario

    F->>G: GET /user (con access_token)
    G-->>F: Información del usuario
    F->>G: GET /user/orgs (con access_token)
    G-->>F: Organizaciones del usuario

    F->>F: Valida pertenencia a "retrogamecloud"

    Note over F,M: 11. Acceso autorizado

    F-->>U: 302 Redirect → https://grafana.retrogamehub.com
    U->>N: GET / (con auth cookie)
    N->>F: auth-url: /oauth2/auth
    F-->>N: 200 OK + Headers (X-User, X-Email)
    N->>M: Proxy request con headers de usuario
    M-->>N: Grafana Dashboard
    N-->>U: Dashboard renderizado

    Note over U,M: 12. Requests posteriores con token válido

    loop Requests autenticadas
        U->>N: GET /api/dashboards
        N->>F: auth-url: /oauth2/auth
        F->>F: Valida access_token (no expirado)
        F-->>N: 200 OK + User Headers
        N->>M: Proxy request
        M-->>U: Response
    end

    Note over F,G: 13. Refresh de token expirado

    U->>N: GET /api/alerts
    N->>F: auth-url: /oauth2/auth
    F->>F: access_token EXPIRADO
    
    F->>G: POST /login/oauth/access_token
    Note right of F: grant_type=refresh_token<br/>&refresh_token=REFRESH_TOKEN<br/>&client_id=CLIENT_ID

    G-->>F: Nuevo access_token + refresh_token
    F->>F: Actualiza tokens en session
    F-->>N: 200 OK + User Headers
    N->>M: Proxy request
    M-->>U: Response

    Note over U,G: 14. Logout y revocación

    U->>F: GET /oauth2/sign_out
    F->>G: POST /applications/CLIENT_ID/token
    Note right of F: access_token=ACCESS_TOKEN
    G-->>F: 200 OK (token revocado)
    
    F->>F: Elimina tokens de session
    F->>F: Elimina cookies de auth
    F-->>U: 302 Redirect → Login page
```

### Detalles de Implementación PKCE

<CardGroup cols={2}>
  <Card title="Code Verifier" icon="key">
    ```bash
    # Genera string aleatorio de 128 caracteres
    code_verifier=$(openssl rand -base64 96 | tr -d "=+/" | cut -c1-128)
    ```
  </Card>

  <Card title="Code Challenge" icon="lock">
    ```bash
    # SHA256 del verifier, codificado en base64url
    code_challenge=$(echo -n $code_verifier | sha256sum | cut -d' ' -f1 | xxd -r -p | base64 | tr -d "=" | tr '/+' '_-')
    ```
  </Card>
</CardGroup>

## Configuración OAuth2-Proxy

### ConfigMap con PKCE habilitado

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth2-proxy-config
  namespace: monitoring
data:
  oauth2_proxy.cfg: |
    provider = "github"
    github_org = "retrogamecloud"
    
    # PKCE Configuration
    code_challenge_method = "S256"
    force_code_challenge_method = true
    
    # GitHub OAuth App
    client_id = "your-github-app-client-id"
    
    # Security
    cookie_secure = true
    cookie_httponly = true
    cookie_samesite = "lax"
    cookie_expire = "8h"
    
    # Token refresh
    refresh_token = true
    
    # Scopes necesarios
    scope = "user:email read:org"
    
    # URLs
    redirect_url = "https://grafana.retrogamehub.com/oauth2/callback"
    
    # Session storage
    session_store_type = "redis"
    redis_connection_url = "redis://redis-service:6379"
```

### Ingress con Annotations de Auth

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana-ingress
  annotations:
    # OAuth2-Proxy Authentication
    nginx.ingress.kubernetes.io/auth-url: "http://oauth2-proxy.monitoring.svc.cluster.local:4180/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "http://oauth2-proxy.monitoring.svc.cluster.local:4180/oauth2/start"
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email,X-Auth-Request-Access-Token"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      auth_request_set $auth_user $upstream_http_x_auth_request_user;
      auth_request_set $auth_email $upstream_http_x_auth_request_email;
      proxy_set_header X-User $auth_user;
      proxy_set_header X-Email $auth_email;
spec:
  rules:
  - host: grafana.retrogamehub.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana-service
            port:
              number: 3000
```

## Seguridad y Mejores Prácticas

### Validaciones de Seguridad

<CardGroup cols={2}>
  <Card title="PKCE Protection" icon="shield-check">
    - **Code Verifier**: String aleatorio de 128 caracteres
    - **Code Challenge**: SHA256 hash del verifier
    - **Verificación**: GitHub valida que SHA256(verifier) = challenge
    - **Previene**: Intercepción de authorization codes
  </Card>

  <Card title="State Parameter" icon="fingerprint">
    - **CSRF Token**: Previene ataques CSRF
    - **Validación**: Estado debe coincidir en callback
    - **Entropía**: Valor aleatorio único por request
    - **Almacenamiento**: Session storage temporal
  </Card>
</CardGroup>

### Manejo de Tokens

```yaml
# Token Storage en Redis
apiVersion: v1
kind: Secret
metadata:
  name: oauth2-proxy-tokens
type: Opaque
data:
  # Configuración de expiración
  access-token-ttl: "28800"  # 8 horas
  refresh-token-ttl: "2592000"  # 30 días
  
  # Rotation policy
  token-rotation-enabled: "true"
  refresh-threshold: "900"  # 15 minutos antes de expirar
```

### Revocación y Logout

```mermaid
graph TD
    A[Usuario hace Logout] --> B[OAuth2-Proxy recibe /oauth2/sign_out]
    B --> C[Revoca access_token en GitHub]
    C --> D[Elimina refresh_token]
    D --> E[Limpia session storage]
    E --> F[Elimina auth cookies]
    F --> G[Redirect a página de login]
    
    H[Token Expirado] --> I[Intenta refresh automático]
    I --> J{Refresh exitoso?}
    J -->|Sí| K[Continúa con nuevo token]
    J -->|No| L[Fuerza re-autenticación]
```

Este flujo OAuth2 con PKCE proporciona una capa robusta de seguridad para el acceso a las herramientas de monitoreo, asegurando que solo miembros autorizados de la organización puedan acceder a información sensible del sistema.