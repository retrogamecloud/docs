---
title: "6.3. Base de Datos Completa"
description: "Documentación completa de la base de datos PostgreSQL: esquema, migraciones, configuración y administración"
icon: "database"
---

# 6.3. Base de Datos Completa

Esta guía consolidada cubre todos los aspectos de la base de datos PostgreSQL utilizada en RetroGameCloud, incluyendo configuración, esquema, migraciones y administración.

## Configuración de Base de Datos

### Amazon RDS PostgreSQL

<Note>
RetroGameCloud utiliza Amazon RDS PostgreSQL 14.x con configuración Multi-AZ para alta disponibilidad.
</Note>

<Tabs>
<Tab title="Configuración RDS">
```yaml
# infrastructure/rds-config.yml
Database:
  Engine: postgres
  Version: "14.9"
  InstanceClass: db.r6g.large
  AllocatedStorage: 100
  StorageType: gp3
  MultiAZ: true
  BackupRetentionPeriod: 7
  DeletionProtection: true
  
ParameterGroup:
  shared_preload_libraries: "pg_stat_statements"
  max_connections: 200
  work_mem: "16MB"
  maintenance_work_mem: "256MB"
  checkpoint_completion_target: 0.9
```
</Tab>
<Tab title="Variables de Entorno">
```bash
# Configuración común
DATABASE_URL=postgresql://username:password@host:5432/retrogame_db
DB_HOST=retrogame-postgres.cluster-xxx.eu-west-1.rds.amazonaws.com
DB_PORT=5432
DB_NAME=retrogame_db
DB_SSL_MODE=require

# Por microservicio
AUTH_DB_NAME=retrogame_auth
USER_DB_NAME=retrogame_users
GAME_DB_NAME=retrogame_games
SCORE_DB_NAME=retrogame_scores
```
</Tab>
</Tabs>

### Configuración de Conexiones

```javascript
// config/database.js
const { Pool } = require('pg');

const dbConfig = {
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  ssl: {
    rejectUnauthorized: false
  },
  max: 20, // máximo de conexiones en el pool
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
};

const pool = new Pool(dbConfig);
module.exports = pool;
```

## Esquema de Base de Datos

### Diagrama de Relaciones

```mermaid
erDiagram
    users ||--o{ user_profiles : has
    users ||--o{ game_sessions : plays
    users ||--o{ scores : achieves
    users ||--o{ rankings : participates
    users ||--o{ user_achievements : earns
    
    games ||--o{ game_sessions : supports
    games ||--o{ scores : records
    games ||--o{ game_categories : belongs_to
    games ||--o{ achievements : defines
    
    categories ||--o{ game_categories : contains
    achievements ||--o{ user_achievements : tracks
    
    scores ||--o{ rankings : generates
```

### Tablas del Microservicio Auth

<Tabs>
<Tab title="users">
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    role user_role DEFAULT 'player',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP WITH TIME ZONE
);

-- Índices
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_active ON users(is_active);
```
</Tab>
<Tab title="user_sessions">
```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    session_token VARCHAR(255) UNIQUE NOT NULL,
    refresh_token VARCHAR(255) UNIQUE,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    ip_address INET,
    user_agent TEXT
);

-- Índices
CREATE INDEX idx_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_sessions_token ON user_sessions(session_token);
CREATE INDEX idx_sessions_expires ON user_sessions(expires_at);
```
</Tab>
<Tab title="Tipos y Enums">
```sql
-- Tipos personalizados
CREATE TYPE user_role AS ENUM ('player', 'admin', 'moderator');
CREATE TYPE session_status AS ENUM ('active', 'expired', 'revoked');
```
</Tab>
</Tabs>

### Tablas del Microservicio User

<Tabs>
<Tab title="user_profiles">
```sql
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL,
    display_name VARCHAR(100),
    avatar_url VARCHAR(500),
    bio TEXT,
    country VARCHAR(2), -- ISO 3166-1 alpha-2
    timezone VARCHAR(50),
    preferred_language VARCHAR(10) DEFAULT 'es-ES',
    privacy_settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Índices
CREATE INDEX idx_profiles_user_id ON user_profiles(user_id);
CREATE INDEX idx_profiles_display_name ON user_profiles(display_name);
CREATE INDEX idx_profiles_country ON user_profiles(country);
```
</Tab>
<Tab title="user_preferences">
```sql
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID UNIQUE NOT NULL,
    theme VARCHAR(20) DEFAULT 'dark',
    sound_enabled BOOLEAN DEFAULT TRUE,
    notifications_enabled BOOLEAN DEFAULT TRUE,
    auto_save BOOLEAN DEFAULT TRUE,
    preferred_controls JSONB DEFAULT '{}',
    display_settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_preferences_user_id ON user_preferences(user_id);
```
</Tab>
</Tabs>

### Tablas del Microservicio Game Catalog

<Tabs>
<Tab title="games">
```sql
CREATE TABLE games (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(200) UNIQUE NOT NULL,
    description TEXT,
    release_year INTEGER,
    developer VARCHAR(100),
    publisher VARCHAR(100),
    platform game_platform NOT NULL,
    genre VARCHAR(50),
    rom_file_url VARCHAR(500),
    thumbnail_url VARCHAR(500),
    screenshot_urls JSONB DEFAULT '[]',
    game_metadata JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT TRUE,
    download_count INTEGER DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 0.00,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Índices
CREATE INDEX idx_games_title ON games(title);
CREATE INDEX idx_games_slug ON games(slug);
CREATE INDEX idx_games_platform ON games(platform);
CREATE INDEX idx_games_genre ON games(genre);
CREATE INDEX idx_games_active ON games(is_active);
CREATE INDEX idx_games_rating ON games(rating DESC);
```
</Tab>
<Tab title="categories">
```sql
CREATE TABLE categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    icon VARCHAR(50),
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE game_categories (
    game_id UUID REFERENCES games(id) ON DELETE CASCADE,
    category_id UUID REFERENCES categories(id) ON DELETE CASCADE,
    PRIMARY KEY (game_id, category_id)
);

-- Tipos
CREATE TYPE game_platform AS ENUM ('dos', 'arcade', 'nes', 'snes', 'gameboy');
```
</Tab>
</Tabs>

### Tablas del Microservicio Score

<Tabs>
<Tab title="scores">
```sql
CREATE TABLE scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL REFERENCES games(id),
    score INTEGER NOT NULL,
    level_reached INTEGER,
    time_played INTEGER, -- segundos
    game_metadata JSONB DEFAULT '{}',
    screenshot_url VARCHAR(500),
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_user_game_score UNIQUE(user_id, game_id, score)
);

-- Índices
CREATE INDEX idx_scores_user_id ON scores(user_id);
CREATE INDEX idx_scores_game_id ON scores(game_id);
CREATE INDEX idx_scores_score ON scores(score DESC);
CREATE INDEX idx_scores_created ON scores(created_at DESC);
CREATE INDEX idx_scores_verified ON scores(is_verified);
```
</Tab>
<Tab title="game_sessions">
```sql
CREATE TABLE game_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL REFERENCES games(id),
    session_start TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    session_end TIMESTAMP WITH TIME ZONE,
    duration_seconds INTEGER,
    final_score INTEGER,
    save_state_url VARCHAR(500),
    session_metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_user_game ON game_sessions(user_id, game_id);
CREATE INDEX idx_sessions_start ON game_sessions(session_start DESC);
```
</Tab>
</Tabs>

### Tablas del Microservicio Ranking

<Tabs>
<Tab title="rankings">
```sql
CREATE TABLE rankings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    game_id UUID NOT NULL REFERENCES games(id),
    user_id UUID NOT NULL,
    score INTEGER NOT NULL,
    rank_position INTEGER NOT NULL,
    rank_type ranking_type DEFAULT 'global',
    period_start TIMESTAMP WITH TIME ZONE,
    period_end TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT unique_game_user_rank_type UNIQUE(game_id, user_id, rank_type, period_start)
);

-- Índices
CREATE INDEX idx_rankings_game_rank ON rankings(game_id, rank_position);
CREATE INDEX idx_rankings_user ON rankings(user_id);
CREATE INDEX idx_rankings_type ON rankings(rank_type);

-- Tipos
CREATE TYPE ranking_type AS ENUM ('global', 'weekly', 'monthly', 'daily');
```
</Tab>
<Tab title="achievements">
```sql
CREATE TABLE achievements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    game_id UUID REFERENCES games(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon_url VARCHAR(500),
    achievement_type achievement_type DEFAULT 'score',
    criteria JSONB NOT NULL,
    points INTEGER DEFAULT 10,
    rarity rarity_level DEFAULT 'common',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_achievements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    achievement_id UUID NOT NULL REFERENCES achievements(id),
    earned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    game_session_id UUID REFERENCES game_sessions(id),
    
    CONSTRAINT unique_user_achievement UNIQUE(user_id, achievement_id)
);

-- Tipos
CREATE TYPE achievement_type AS ENUM ('score', 'time', 'level', 'special');
CREATE TYPE rarity_level AS ENUM ('common', 'rare', 'epic', 'legendary');
```
</Tab>
</Tabs>

## Sistema de Migraciones

### Estructura de Migraciones

```bash
migrations/
├── 001_initial_schema.up.sql
├── 001_initial_schema.down.sql
├── 002_add_user_profiles.up.sql
├── 002_add_user_profiles.down.sql
├── 003_create_games_table.up.sql
├── 003_create_games_table.down.sql
└── ...
```

### Herramienta de Migración

<Tabs>
<Tab title="migrate-cli">
```bash
# Instalación
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

# Crear nueva migración
migrate create -ext sql -dir migrations -seq add_user_preferences

# Ejecutar migraciones
migrate -path migrations -database "postgresql://user:pass@host/db?sslmode=require" up

# Rollback
migrate -path migrations -database "postgresql://user:pass@host/db?sslmode=require" down 1
```
</Tab>
<Tab title="Script Node.js">
```javascript
// scripts/migrate.js
const { Pool } = require('pg');
const fs = require('fs');
const path = require('path');

class MigrationRunner {
  constructor(pool) {
    this.pool = pool;
  }
  
  async createMigrationsTable() {
    await this.pool.query(`
      CREATE TABLE IF NOT EXISTS schema_migrations (
        version INTEGER PRIMARY KEY,
        applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
      )
    `);
  }
  
  async getCurrentVersion() {
    const result = await this.pool.query(
      'SELECT version FROM schema_migrations ORDER BY version DESC LIMIT 1'
    );
    return result.rows[0]?.version || 0;
  }
  
  async migrate() {
    await this.createMigrationsTable();
    const currentVersion = await this.getCurrentVersion();
    
    const migrationFiles = fs.readdirSync('./migrations')
      .filter(file => file.endsWith('.up.sql'))
      .map(file => parseInt(file.split('_')[0]))
      .filter(version => version > currentVersion)
      .sort();
      
    for (const version of migrationFiles) {
      await this.runMigration(version);
    }
  }
}
```
</Tab>
</Tabs>

### Migraciones Principales

<Tabs>
<Tab title="001_initial_schema.up.sql">
```sql
-- Extensiones
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

-- Tipos base
CREATE TYPE user_role AS ENUM ('player', 'admin', 'moderator');
CREATE TYPE game_platform AS ENUM ('dos', 'arcade', 'nes', 'snes', 'gameboy');

-- Tabla de usuarios
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
</Tab>
</Tabs>
```