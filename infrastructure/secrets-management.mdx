---
title: Seguridad y Gestión de Secretos
description: Guía completa sobre gestión de secretos, políticas de seguridad y mejores
  prácticas para RetroGameCloud
icon: shield-check
---

## Introducción

La seguridad en RetroGameCloud es fundamental para proteger los datos de usuarios, mantener la integridad de la plataforma y garantizar el cumplimiento normativo. Esta documentación cubre la gestión de secretos, políticas de seguridad y mejores prácticas implementadas en nuestra arquitectura de microservicios.

<Note>
Todos los secretos y credenciales deben seguir el principio de menor privilegio y rotarse regularmente según las políticas establecidas.
</Note>

## Gestión de Secretos

### Selección de Herramientas

#### AWS Secrets Manager vs HashiCorp Vault

Para RetroGameCloud, hemos elegido **AWS Secrets Manager** como solución principal por las siguientes razones:

<CardGroup cols={2}>
<Card title="AWS Secrets Manager" icon="aws">
- **Integración nativa** con servicios AWS (RDS, EKS)
- **Rotación automática** para bases de datos RDS
- **Menor overhead operacional**
- **Cumplimiento** integrado con AWS Config
</Card>

<Card title="HashiCorp Vault" icon="vault">
- **Mayor flexibilidad** para secretos dinámicos
- **Auditoría avanzada** y políticas granulares  
- **Multi-cloud** y on-premises
- **Requiere más gestión** operacional
</Card>
</CardGroup>

<Info>
Usamos Vault como solución complementaria para secretos dinámicos y tokens de corta duración en entornos de desarrollo.
</Info>

### AWS Secrets Manager

#### Secretos Almacenados por Entorno

<Tabs>
<Tab title="Production">

```json
{
  "secret_name": "retrogamecloud/prod/postgres/main",
  "description": "Credenciales principales de PostgreSQL - Producción",
  "secret_value": {
    "username": "rgc_prod_admin",
    "password": "AUTO_GENERATED_32_CHARS",
    "host": "rgc-postgres-prod.cluster-xyz.eu-west-1.rds.amazonaws.com",
    "port": 5432,
    "database": "retrogamecloud_prod"
  },
  "rotation_enabled": true,
  "rotation_interval": 30
}
```

</Tab>

<Tab title="Staging">

```json
{
  "secret_name": "retrogamecloud/staging/postgres/main", 
  "description": "Credenciales principales de PostgreSQL - Staging",
  "secret_value": {
    "username": "rgc_staging_admin",
    "password": "AUTO_GENERATED_32_CHARS",
    "host": "rgc-postgres-staging.cluster-abc.eu-west-1.rds.amazonaws.com",
    "port": 5432,
    "database": "retrogamecloud_staging"
  },
  "rotation_enabled": true,
  "rotation_interval": 15
}
```

</Tab>

<Tab title="Development">

```json
{
  "secret_name": "retrogamecloud/dev/postgres/main",
  "description": "Credenciales principales de PostgreSQL - Desarrollo", 
  "secret_value": {
    "username": "rgc_dev_admin",
    "password": "AUTO_GENERATED_24_CHARS",
    "host": "rgc-postgres-dev.cluster-def.eu-west-1.rds.amazonaws.com",
    "port": 5432,
    "database": "retrogamecloud_dev"
  },
  "rotation_enabled": false
}
```

</Tab>
</Tabs>

#### JWT y Tokens de Autenticación

<Tabs>
<Tab title="JWT Secrets">

```json
{
  "secret_name": "retrogamecloud/prod/jwt/tokens",
  "description": "Secretos para firma de tokens JWT",
  "secret_value": {
    "access_token_secret": "AUTO_GENERATED_256_BIT",
    "refresh_token_secret": "AUTO_GENERATED_256_BIT",
    "token_expiry": "15m",
    "refresh_expiry": "7d",
    "issuer": "retrogamecloud.com",
    "audience": "rgc-api"
  },
  "rotation_enabled": false,
  "manual_rotation_schedule": "quarterly"
}
```

</Tab>

<Tab title="OAuth2 Providers">

```json
{
  "secret_name": "retrogamecloud/prod/oauth2/providers",
  "description": "Credenciales OAuth2 para proveedores externos",
  "secret_value": {
    "google": {
      "client_id": "GOOGLE_CLIENT_ID",
      "client_secret": "GOOGLE_CLIENT_SECRET",
      "redirect_uri": "https://api.retrogamecloud.com/auth/google/callback"
    },
    "discord": {
      "client_id": "DISCORD_CLIENT_ID", 
      "client_secret": "DISCORD_CLIENT_SECRET",
      "redirect_uri": "https://api.retrogamecloud.com/auth/discord/callback"
    },
    "steam": {
      "api_key": "STEAM_WEB_API_KEY",
      "return_url": "https://api.retrogamecloud.com/auth/steam/return"
    }
  }
}
```

</Tab>
</Tabs>

#### API Keys Externas

```json
{
  "secret_name": "retrogamecloud/prod/external/apis",
  "description": "API Keys para servicios externos",
  "secret_value": {
    "rawg_api_key": "RAWG_API_KEY",
    "igdb_client_id": "IGDB_CLIENT_ID",
    "igdb_client_secret": "IGDB_CLIENT_SECRET",
    "sendgrid_api_key": "SENDGRID_API_KEY",
    "s3_access_key": "S3_ACCESS_KEY",
    "s3_secret_key": "S3_SECRET_KEY"
  },
  "rotation_schedule": "manual_quarterly"
}
```

## Integración con EKS

### AWS Secrets Store CSI Driver

#### Instalación y Configuración

```yaml
# secrets-store-csi-driver.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secrets-store-csi-driver
  namespace: kube-system
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/SecretsManagerCSIRole
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: secrets-store-csi-driver
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: secrets-store-csi-driver
  template:
    metadata:
      labels:
        app: secrets-store-csi-driver
    spec:
      serviceAccountName: secrets-store-csi-driver
      containers:
      - name: secrets-store
        image: k8s.gcr.io/csi-secrets-store/driver:v1.3.0
        args:
          - "--endpoint=$(CSI_ENDPOINT)"
          - "--nodeid=$(KUBE_NODE_NAME)"
          - "--provider-volume=/etc/kubernetes/secrets-store-csi-providers"
        env:
        - name: CSI_ENDPOINT
          value: unix:///csi/csi.sock
        volumeMounts:
        - name: plugin-dir
          mountPath: /csi
        - name: registration-dir
          mountPath: /registration
```

#### SecretProviderClass

```yaml
# secret-provider-class.yaml
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: retrogamecloud-secrets
  namespace: retrogamecloud
spec:
  provider: aws
  parameters:
    region: eu-west-1
    objects: |
      - objectName: "retrogamecloud/prod/postgres/main"
        objectType: "secretsmanager"
        jmesPath:
          - path: "username"
            objectAlias: "db_username"
          - path: "password" 
            objectAlias: "db_password"
          - path: "host"
            objectAlias: "db_host"
          - path: "port"
            objectAlias: "db_port"
      - objectName: "retrogamecloud/prod/jwt/tokens"
        objectType: "secretsmanager"
        jmesPath:
          - path: "access_token_secret"
            objectAlias: "jwt_access_secret"
          - path: "refresh_token_secret"
            objectAlias: "jwt_refresh_secret"
  secretObjects:
  - secretName: postgres-credentials
    type: Opaque
    data:
    - objectName: db_username
      key: username
    - objectName: db_password
      key: password
    - objectName: db_host
      key: host
    - objectName: db_port
      key: port
  - secretName: jwt-secrets
    type: Opaque
    data:
    - objectName: jwt_access_secret
      key: access_token_secret
    - objectName: jwt_refresh_secret
      key: refresh_token_secret
```

### Montaje en Deployments

#### Ejemplo Completo - Auth Service

<Tabs>
<Tab title="Deployment">

```yaml
# auth-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: retrogamecloud
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      serviceAccountName: auth-service-sa
      containers:
      - name: auth-service
        image: retrogamecloud/auth-service:v1.2.0
        ports:
        - containerPort: 8080
        env:
        - name: DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: password
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: postgres-credentials
              key: host
        - name: JWT_ACCESS_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: access_token_secret
        # Montaje como volumen para archivos de configuración
        volumeMounts:
        - name: oauth-config
          mountPath: "/etc/oauth"
          readOnly: true
        - name: secrets-store
          mountPath: "/mnt/secrets"
          readOnly: true
      volumes:
      - name: secrets-store
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: "retrogamecloud-secrets"
      - name: oauth-config
        secret:
          secretName: oauth-providers
```

</Tab>

<Tab title="ServiceAccount">

```yaml
# auth-service-sa.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: auth-service-sa
  namespace: retrogamecloud
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT:role/RetroGameCloudAuthServiceRole
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-reader
  namespace: retrogamecloud
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-secrets
  namespace: retrogamecloud
subjects:
- kind: ServiceAccount
  name: auth-service-sa
  namespace: retrogamecloud
roleRef:
  kind: Role
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io
```

</Tab>

<Tab title="IAM Role">

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": [
        "arn:aws:secretsmanager:eu-west-1:ACCOUNT:secret:retrogamecloud/prod/postgres/*",
        "arn:aws:secretsmanager:eu-west-1:ACCOUNT:secret:retrogamecloud/prod/jwt/*",
        "arn:aws:secretsmanager:eu-west-1:ACCOUNT:secret:retrogamecloud/prod/oauth2/*"
      ],
      "Condition": {
        "StringEquals": {
          "secretsmanager:ResourceTag/Environment": "production",
          "secretsmanager:ResourceTag/Service": "auth-service"
        }
      }
    }
  ]
}
```

</Tab>
</Tabs>

## Rotación de Secretos

### Rotación Automática - RDS

#### Configuración en AWS Secrets Manager

```python
# terraform/secrets.tf
resource "aws_secretsmanager_secret" "postgres_main" {
  name        = "retrogamecloud/${var.environment}/postgres/main"
  description = "PostgreSQL credentials for ${var.environment}"
  
  tags = {
    Environment = var.environment
    Service     = "postgres"
    AutoRotate  = "true"
  }
}

resource "aws_secretsmanager_secret_rotation" "postgres_rotation" {
  secret_id           = aws_secretsmanager_secret.postgres_main.id
  rotation_lambda_arn = aws_lambda_function.postgres_rotation.arn

  rotation_rules {
    automatically_after_days = var.environment == "production" ? 30 : 15
  }

  depends_on = [aws_lambda_permission.allow_secret_manager_call_lambda]
}

# Lambda para rotación automática
resource "aws_lambda_function" "postgres_rotation" {
  filename         = "postgres_rotation.zip"
  function_name    = "retrogamecloud-postgres-rotation-${var.environment}"
  role            = aws_iam_role.lambda_rotation_role.arn
  handler         = "lambda_function.lambda_handler"
  source_code_hash = filebase64sha256("postgres_rotation.zip")
  runtime         = "python3.9"
  timeout         = 30

  environment {
    variables = {
      SECRETS_MANAGER_ENDPOINT = "https://secretsmanager.${var.aws_region}.amazonaws.com"
      RDS_ENDPOINT            = aws_rds_cluster.main.endpoint
    }
  }

  vpc_config {
    subnet_ids         = var.private_subnet_ids
    security_group_ids = [aws_security_group.lambda_rotation.id]
  }
}
```

#### Función Lambda de Rotación

```python
# lambda/postgres_rotation.py
import json
import boto3
import logging
import os
import pymysql

logger = logging.getLogger()
logger.setLevel(logging.INFO)

def lambda_handler(event, context):
    """
    Maneja la rotación automática de credenciales PostgreSQL
    """
    service = boto3.client('secretsmanager')
    
    arn = event['Step']
    token = event['ClientRequestToken']
    step = event['Step']
    
    if step == "createSecret":
        create_secret(service, arn, token)
    elif step == "setSecret":
        set_secret(service, arn, token)
    elif
```