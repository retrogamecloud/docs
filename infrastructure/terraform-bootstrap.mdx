---
title: Terraform Bootstrap
sidebarTitle: 5.2. Terraform Bootstrap
description: Configuración inicial de servicios base con S3, DynamoDB y Route53
icon: rocket
---

## Visión General

El **Terraform Bootstrap** es el primer paso para desplegar la infraestructura de Retro Game Hub. Crea los servicios fundamentales necesarios para que el resto de la infraestructura funcione correctamente.

**Ubicación**: `/infrastructure/terraform/bootstrap/`

<CardGroup cols={2}>
  <Card title="S3 Backend" icon="database">
    Bucket S3 para almacenar el Terraform state de forma remota
  </Card>
  <Card title="DynamoDB Lock" icon="lock">
    Tabla para bloqueo de state y prevenir conflictos
  </Card>
  <Card title="Route53 Zone" icon="globe">
    Hosted Zone permanente con nameservers para tu dominio
  </Card>
  <Card title="IAM Roles Base" icon="user-shield">
    Roles y políticas IAM para EKS y servicios AWS
  </Card>
</CardGroup>

## ¿Por Qué Bootstrap?

El problema del "huevo y la gallina" en Terraform:

- Terraform necesita un **backend S3** para almacenar el state
- Pero no puedes crear el bucket S3 con Terraform si no tienes dónde guardar su state
- **Solución**: Bootstrap crea el backend usando **state local**, luego migramos

### Arquitectura Bootstrap

```mermaid
graph TB
    subgraph "Fase 1: Bootstrap (State Local)"
        A[terraform init] --> B[terraform apply]
        B --> C[S3 Bucket creado]
        B --> D[DynamoDB Table creada]
        B --> E[Route53 Zone creada]
        B --> F[IAM Roles creados]
    end
    
    subgraph "Fase 2: Infraestructura Principal"
        G[Configurar backend S3] --> H[terraform init -migrate-state]
        H --> I[terraform apply]
        I --> J[VPC + EKS + RDS + Monitoring]
    end
    
    C --> G
    D --> G
    E --> I
    F --> I
    
    style C fill:#e8f5e9
    style D fill:#e8f5e9
    style E fill:#fff3e0
    style F fill:#e3f2fd
```

## Estructura de Archivos

```bash
infrastructure/terraform/bootstrap/
├── main.tf              # Recursos principales
├── variables.tf         # Variables de entrada
├── outputs.tf           # Outputs (S3 bucket, nameservers)
├── providers.tf         # Provider AWS
├── terraform.tfvars.example
└── README.md
```

## Recursos Creados

### 1. S3 Bucket para Terraform State

```hcl
resource "aws_s3_bucket" "terraform_state" {
  bucket = "${var.project_name}-terraform-state-${var.environment}"
  
  tags = {
    Name        = "Terraform State Bucket"
    Environment = var.environment
    Project     = var.project_name
  }
}

resource "aws_s3_bucket_versioning" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id
  
  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_s3_bucket_encryption" "terraform_state" {
  bucket = aws_s3_bucket.terraform_state.id
  
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = "AES256"
    }
  }
}
```

**Características**:
- **Versionado habilitado**: Recuperación de states anteriores
- **Encryption at rest**: AES256 automático
- **Public access bloqueado**: No accesible desde internet
- **Lifecycle policy**: Elimina versiones antiguas después de 90 días

### 2. DynamoDB Table para State Locking

```hcl
resource "aws_dynamodb_table" "terraform_locks" {
  name         = "${var.project_name}-terraform-locks"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "LockID"
  
  attribute {
    name = "LockID"
    type = "S"
  }
  
  tags = {
    Name        = "Terraform State Locks"
    Environment = var.environment
  }
}
```

**Características**:
- **Pay-per-request**: No costos fijos, solo por uso
- **LockID**: Previene que múltiples usuarios ejecuten terraform simultáneamente
- **Timeout automático**: Lock se libera si el proceso muere

### 3. Route53 Hosted Zone

```hcl
resource "aws_route53_zone" "main" {
  name = var.domain_name
  
  tags = {
    Name        = "Main DNS Zone"
    Environment = var.environment
    Project     = var.project_name
  }
}
```

**Por Qué en Bootstrap**:
- Los **nameservers son permanentes**: Si recreas la zone, cambian los nameservers
- Cambiar nameservers en registrador toma hasta 48h en propagarse
- **Crear una sola vez** en bootstrap evita este problema

### 4. IAM Roles Base

```hcl
# Role para EKS Cluster
resource "aws_iam_role" "eks_cluster" {
  name = "${var.project_name}-eks-cluster-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "eks.amazonaws.com"
      }
    }]
  })
}

# Role para EKS Node Group
resource "aws_iam_role" "eks_nodes" {
  name = "${var.project_name}-eks-nodes-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "sts:AssumeRole"
      Effect = "Allow"
      Principal = {
        Service = "ec2.amazonaws.com"
      }
    }]
  })
}
```

## Variables de Configuración

**Archivo**: `terraform.tfvars`

```hcl
# Configuración básica
project_name = "retro-game-hub"
environment  = "prod"
region       = "us-east-1"

# Dominio
domain_name = "tudominio.com"

# Tags adicionales
tags = {
  ManagedBy = "Terraform"
  Owner     = "DevOps Team"
}
```

### Variables Disponibles

| Variable | Descripción | Ejemplo | Requerida |
|----------|-------------|---------|-----------|
| `project_name` | Nombre del proyecto (prefijo recursos) | `retro-game-hub` | Sí |
| `environment` | Ambiente (prod/staging/dev) | `prod` | Sí |
| `region` | Región AWS | `us-east-1` | Sí |
| `domain_name` | Dominio principal | `retrogamehub.com` | Sí |
| `enable_deletion_protection` | Protección contra eliminación | `true` | No |

## Outputs

El bootstrap genera outputs críticos para la fase 2:

```hcl
output "s3_bucket_name" {
  description = "Nombre del bucket S3 para Terraform state"
  value       = aws_s3_bucket.terraform_state.id
}

output "dynamodb_table_name" {
  description = "Nombre de la tabla DynamoDB para locks"
  value       = aws_dynamodb_table.terraform_locks.id
}

output "route53_zone_id" {
  description = "ID de la Hosted Zone de Route53"
  value       = aws_route53_zone.main.zone_id
}

output "route53_nameservers" {
  description = "Nameservers de Route53 (configurar en registrador)"
  value       = aws_route53_zone.main.name_servers
}
```

## Despliegue Paso a Paso

### Paso 1: Clonar Repositorio

```bash
git clone https://github.com/RetroGameCloud/infrastructure.git
cd infrastructure/terraform/bootstrap
```

### Paso 2: Configurar Variables

```bash
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars
```

Edita con tus valores:

```hcl
project_name = "retro-game-hub"
environment  = "prod"
region       = "us-east-1"
domain_name  = "tudominio.com"
```

### Paso 3: Inicializar Terraform

```bash
terraform init
```

Output esperado:
```
Initializing the backend...
Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Installing hashicorp/aws v5.x.x...

Terraform has been successfully initialized!
```

### Paso 4: Validar Configuración

```bash
terraform validate
```

### Paso 5: Planificar Despliegue

```bash
terraform plan
```

Revisa que se crearán:
- 1 S3 bucket
- 1 DynamoDB table
- 1 Route53 hosted zone
- 2 IAM roles
- ~10 recursos en total

### Paso 6: Aplicar Cambios

```bash
terraform apply
```

Confirma con `yes`.

**Tiempo estimado**: 2-3 minutos

### Paso 7: Guardar Outputs

```bash
terraform output -json > ../bootstrap-outputs.json
```

Este archivo será usado por la infraestructura principal.

### Paso 8: Configurar Nameservers

```bash
terraform output route53_nameservers
```

Output:
```
[
  "ns-123.awsdns-45.com",
  "ns-678.awsdns-90.net",
  "ns-234.awsdns-56.org",
  "ns-789.awsdns-01.co.uk"
]
```

**Acción requerida**: Configura estos 4 nameservers en tu registrador de dominio (Namecheap, GoDaddy, etc.)

<Warning>
  **Importante**: La propagación DNS puede tardar hasta 48 horas. Sin embargo, generalmente toma 1-2 horas.
</Warning>

## Verificación

### Verificar S3 Bucket

```bash
aws s3 ls | grep terraform-state
```

### Verificar DynamoDB Table

```bash
aws dynamodb describe-table \
  --table-name retro-game-hub-terraform-locks \
  --query 'Table.TableStatus'
```

### Verificar Route53 Zone

```bash
aws route53 list-hosted-zones \
  --query 'HostedZones[?Name==`tudominio.com.`]'
```

### Verificar Nameservers

```bash
dig NS tudominio.com +short
```

Debe mostrar los 4 nameservers de Route53 (tarda 1-2h en propagarse).

## Migración a Backend Remoto

Una vez completado el bootstrap, la infraestructura principal usará el S3 backend:

**Archivo**: `infrastructure/terraform/backend.tf`

```hcl
terraform {
  backend "s3" {
    bucket         = "retrogamehub-terraform-state"
    key            = "bootstrap/terraform.tfstate"
    region         = "eu-west-1"
    dynamodb_table = "retrogamehub-terraform-locks"
    encrypt        = true
  }
}
```

Comandos:

```bash
cd ../  # Volver a /infrastructure/terraform/
terraform init -migrate-state
```

Terraform preguntará si migrar el state local a S3. Confirmar con `yes`.

## Costos Estimados

| Recurso | Costo Mensual | Detalles |
|---------|---------------|----------|
| S3 Bucket | ~$0.50 | State file < 1MB |
| DynamoDB | ~$0.10 | Pay-per-request, uso mínimo |
| Route53 Hosted Zone | $0.50 | $0.50/mes por zona |
| IAM Roles | $0.00 | Gratis |
| **Total** | **~$1.10/mes** | Costo fijo mínimo |

## Troubleshooting

### Error: Bucket Already Exists

```
Error: creating S3 Bucket: BucketAlreadyExists
```

**Solución**: Los nombres de buckets S3 son globales. Cambia `project_name` en `terraform.tfvars`:

```hcl
project_name = "retro-game-hub-${random_id}"
```

### Error: Route53 Zone Already Exists

```
Error: creating Route53 Hosted Zone: HostedZoneAlreadyExists
```

**Solución**: Importa la zona existente:

```bash
terraform import aws_route53_zone.main Z1234567890ABC
```

### Error: Invalid Credentials

```
Error: error configuring Terraform AWS Provider: no valid credential sources
```

**Solución**: Configura AWS CLI:

```bash
aws configure
# AWS Access Key ID: AKIAIOSFODNN7EXAMPLE
# AWS Secret Access Key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
# Default region: us-east-1
```

### Nameservers No Propagan

**Verificar**: 

```bash
whois tudominio.com | grep "Name Server"
```

Si aún muestra los nameservers antiguos, espera 1-2 horas más o contacta tu registrador.

## Destrucción (Cuidado)

<Warning>
  **Peligro**: Eliminar el bootstrap destruirá el S3 bucket con todos los Terraform states. Solo hacer esto si estás seguro.
</Warning>

```bash
# 1. Eliminar TODA la infraestructura principal primero
cd ../
terraform destroy

# 2. Luego eliminar bootstrap
cd bootstrap/
terraform destroy
```

Terraform preguntará confirmación. El S3 bucket debe estar vacío para poder eliminarse.

## Mejores Prácticas

### 1. Protección de Eliminación

Habilita deletion protection en producción:

```hcl
resource "aws_s3_bucket" "terraform_state" {
  bucket = "..."
  
  lifecycle {
    prevent_destroy = true
  }
}
```

### 2. Backup del State

El state del bootstrap se almacena localmente. **Hacer backup**:

```bash
cp terraform.tfstate terraform.tfstate.backup
# Guardar en lugar seguro (1Password, encrypted USB, etc.)
```

### 3. Versionado del Bucket

El bucket ya tiene versionado habilitado. Para recuperar un state anterior:

```bash
aws s3api list-object-versions \
  --bucket retro-game-hub-terraform-state-prod \
  --prefix eks/terraform.tfstate
```

### 4. Monitoreo del State Lock

Si terraform se queda "colgado" en `Acquiring state lock`:

```bash
# Ver locks activos
aws dynamodb scan --table-name retro-game-hub-terraform-locks

# Eliminar lock manualmente (CUIDADO)
aws dynamodb delete-item \
  --table-name retro-game-hub-terraform-locks \
  --key '{"LockID": {"S": "retro-game-hub-terraform-state-prod/eks/terraform.tfstate"}}'
```

## Referencias

- [Terraform S3 Backend](https://www.terraform.io/docs/language/settings/backends/s3.html)
- [AWS S3 Best Practices](https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html)
- [Route53 DNS Setup](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/Welcome.html)
- [DynamoDB Lock Table](https://www.terraform.io/docs/language/settings/backends/s3.html#dynamodb-state-locking)
