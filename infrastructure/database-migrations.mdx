---
title: 6.8. Migraciones de Base de Datos
description: Gu√≠a completa para ejecutar migraciones de esquema en RDS PostgreSQL
  de forma segura, con estrategias de versionado, procedimientos de rollback y despliegues
  sin downtime
icon: database
---

## Introducci√≥n

Las migraciones de base de datos en RetroGameCloud requieren un enfoque estructurado para mantener la integridad de datos y minimizar el tiempo de inactividad. Esta gu√≠a cubre desde la creaci√≥n de scripts hasta la ejecuci√≥n en producci√≥n con estrategias de zero-downtime.

<Note>
Todas las migraciones deben probarse exhaustivamente en entornos locales y staging antes del despliegue en producci√≥n.
</Note>

## Herramientas de Migraci√≥n

### Flyway
Utilizamos **Flyway** como herramienta principal para el versionado y ejecuci√≥n de migraciones de esquema:

- Versionado autom√°tico de scripts SQL

- Seguimiento del estado de migraciones

- Validaci√≥n de checksums

- Soporte para rollbacks

### Configuraci√≥n Docker
Para desarrollo local, utilizamos un contenedor Flyway configurado:

```yaml
version: '3.8'
services:
  flyway:
    image: flyway/flyway:8.5.13
    command: -url=jdbc:postgresql://postgres:5432/retrogame -user=postgres -password=password -connectRetries=60 migrate
    volumes:
      - ./migrations:/flyway/sql
    depends_on:
      - postgres
    environment:
      - FLYWAY_BASELINE_ON_MIGRATE=true
      - FLYWAY_VALIDATE_ON_MIGRATE=true

```

## Estructura de Migraciones

### Convenci√≥n de Nomenclatura

Las migraciones siguen una estructura estricta:

<Tabs>
<Tab title="Migraciones hacia adelante">

```

V{version}__{descripci√≥n}.sql

Ejemplos:

- V001__initial_schema.sql

- V002__add_user_achievements.sql

- V003__create_game_scores_index.sql

```

</Tab>
<Tab title="Migraciones de rollback">

```

U{version}__{descripci√≥n}.sql

Ejemplos:

- U002__remove_user_achievements.sql

- U003__drop_game_scores_index.sql

```

</Tab>
</Tabs>

### Estructura de Directorios

```

migrations/
‚îú‚îÄ‚îÄ schema/
‚îÇ   ‚îú‚îÄ‚îÄ V001__initial_schema.sql
‚îÇ   ‚îú‚îÄ‚îÄ V002__add_user_achievements.sql
‚îÇ   ‚îî‚îÄ‚îÄ V003__create_game_scores_index.sql
‚îú‚îÄ‚îÄ rollbacks/
‚îÇ   ‚îú‚îÄ‚îÄ U002__remove_user_achievements.sql
‚îÇ   ‚îî‚îÄ‚îÄ U003__drop_game_scores_index.sql
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ V100__insert_initial_games.sql
‚îÇ   ‚îî‚îÄ‚îÄ V101__migrate_user_preferences.sql
‚îî‚îÄ‚îÄ hotfixes/
    ‚îî‚îÄ‚îÄ V999__emergency_fix_user_scores.sql

```

## Ejemplos de Migraciones Reales

### Migraci√≥n de Esquema Inicial

<Tabs>
<Tab title="V001__initial_schema.sql">

```sql

- - Crear extensiones necesarias
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

- - Tabla de usuarios
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

- - Tabla de juegos
CREATE TABLE games (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    platform VARCHAR(50) NOT NULL,
    release_year INTEGER,
    genre VARCHAR(100),
    file_url TEXT,
    thumbnail_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

- - Tabla de puntuaciones
CREATE TABLE game_scores (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    game_id UUID REFERENCES games(id) ON DELETE CASCADE,
    score INTEGER NOT NULL DEFAULT 0,
    achieved_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, game_id)
);

- - √çndices para optimizaci√≥n
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_games_platform ON games(platform);
CREATE INDEX idx_games_genre ON games(genre);
CREATE INDEX idx_game_scores_user_id ON game_scores(user_id);
CREATE INDEX idx_game_scores_game_id ON game_scores(game_id);
CREATE INDEX idx_game_scores_score ON game_scores(score DESC);

```

</Tab>
<Tab title="Rollback - Drop inicial">

```sql

- - U001__drop_initial_schema.sql
DROP INDEX IF EXISTS idx_game_scores_score;
DROP INDEX IF EXISTS idx_game_scores_game_id;
DROP INDEX IF EXISTS idx_game_scores_user_id;
DROP INDEX IF EXISTS idx_games_genre;
DROP INDEX IF EXISTS idx_games_platform;
DROP INDEX IF EXISTS idx_users_username;
DROP INDEX IF EXISTS idx_users_email;

DROP TABLE IF EXISTS game_scores;
DROP TABLE IF EXISTS games;
DROP TABLE IF EXISTS users;

DROP EXTENSION IF EXISTS "pgcrypto";
DROP EXTENSION IF EXISTS "uuid-ossp";

```

</Tab>
</Tabs>

### Migraci√≥n de Logros de Usuario

<Tabs>
<Tab title="V002__add_user_achievements.sql">

```sql

- - Crear tabla de logros
CREATE TABLE achievements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT NOT NULL,
    icon_url TEXT,
    points INTEGER DEFAULT 0,
    category VARCHAR(50) DEFAULT 'general',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

- - Crear tabla de logros de usuario
CREATE TABLE user_achievements (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    achievement_id UUID REFERENCES achievements(id) ON DELETE CASCADE,
    unlocked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    progress INTEGER DEFAULT 100,
    UNIQUE(user_id, achievement_id)
);

- - Agregar columna de puntos totales a usuarios
ALTER TABLE users ADD COLUMN total_achievement_points INTEGER DEFAULT 0;

- - √çndices para logros
CREATE INDEX idx_achievements_category ON achievements(category);
CREATE INDEX idx_user_achievements_user_id ON user_achievements(user_id);
CREATE INDEX idx_user_achievements_unlocked_at ON user_achievements(unlocked_at);

- - Insertar logros iniciales
INSERT INTO achievements (name, description, points, category) VALUES
('Primer Juego', 'Juega tu primer juego retro', 10, 'gaming'),
('Gamer Dedicado', 'Juega 10 juegos diferentes', 50, 'gaming'),
('Puntuaci√≥n Alta', 'Consigue m√°s de 10,000 puntos en cualquier juego', 25, 'score'),
('Veterano', 'Lleva 30 d√≠as registrado', 100, 'loyalty');

```

</Tab>
<Tab title="U002__remove_user_achievements.sql">

```sql

- - Eliminar √≠ndices
DROP INDEX IF EXISTS idx_user_achievements_unlocked_at;
DROP INDEX IF EXISTS idx_user_achievements_user_id;
DROP INDEX IF EXISTS idx_achievements_category;

- - Eliminar columna agregada
ALTER TABLE users DROP COLUMN IF EXISTS total_achievement_points;

- - Eliminar tablas
DROP TABLE IF EXISTS user_achievements;
DROP TABLE IF EXISTS achievements;

```

</Tab>
</Tabs>

### Migraci√≥n de Optimizaci√≥n de √çndices

<Tabs>
<Tab title="V003__optimize_game_queries.sql">

```sql

- - Crear √≠ndice compuesto para queries frecuentes
CREATE INDEX CONCURRENTLY idx_games_platform_genre
ON games(platform, genre)
WHERE platform IS NOT NULL AND genre IS NOT NULL;

- - √çndice parcial para juegos activos
CREATE INDEX CONCURRENTLY idx_games_active
ON games(created_at)
WHERE file_url IS NOT NULL;

- - √çndice para ranking de puntuaciones
CREATE INDEX CONCURRENTLY idx_game_scores_ranking
ON game_scores(game_id, score DESC, achieved_at DESC);

- - Estad√≠sticas para el optimizador
ANALYZE games;
ANALYZE game_scores;

```

</Tab>
<Tab title="U003__remove_game_optimizations.sql">

```sql
DROP INDEX CONCURRENTLY IF EXISTS idx_game_scores_ranking;
DROP INDEX CONCURRENTLY IF EXISTS idx_games_active;
DROP INDEX CONCURRENTLY IF EXISTS idx_games_platform_genre;

```

</Tab>
</Tabs>

## Estrategias de Testing

### Testing Automatizado

<Tabs>
<Tab title="test-migrations.sh">

```bash
#!/bin/bash
set -e

DB_NAME="retrogame_test"
DB_USER="postgres"
DB_HOST="localhost"

echo "üß™ Iniciando tests de migraci√≥n..."

# Crear base de datos de prueba
createdb -h $DB_HOST -U $DB_USER $DB_NAME || true

# Funci√≥n para limpiar al salir
cleanup() {
    echo "üßπ Limpiando base de datos de prueba..."
    dropdb -h $DB_HOST -U $DB_USER $DB_NAME --if-exists
}
trap cleanup EXIT

# Ejecutar migraciones
echo "‚¨ÜÔ∏è Ejecutando migraciones..."
flyway -url=jdbc:postgresql://$DB_HOST:5432/$DB_NAME \
       -user=$DB_USER \
       -locations=filesystem:./migrations/schema,filesystem:./migrations/data \
       migrate

# Verificar datos de prueba
echo "‚úÖ Insertando datos de prueba..."
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f ./tests/sample-data.sql

# Ejecutar tests de integridad
echo "üîç Verificando integridad de datos..."
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -f ./tests/integrity-tests.sql

# Test de rollback
echo "‚¨áÔ∏è Probando rollback..."
flyway -url=jdbc:postgresql://$DB_HOST:5432/$DB_NAME \
       -user=$DB_USER \
       -locations=filesystem:./migrations/rollbacks \
       migrate

echo "‚ú® Todos los tests pasaron correctamente!"

```

</Tab>
<Tab title="integrity-tests.sql">

```sql

- - Tests de integridad de datos
DO $$
DECLARE
    user_count INTEGER;
    game_count INTEGER;
    orphaned_scores INTEGER;
BEGIN
    -- Verificar que existan usuarios
    SELECT COUNT(*) INTO user_count FROM users;
    IF user_count = 0 THEN
        RAISE EXCEPTION 'No users found after migration';
    END IF;

    -- Verificar que existan juegos
    SELECT COUNT(*) INTO game_count FROM games;
    IF game_count = 0 THEN
        RAISE EXCEPTION 'No games found after migration';
    END IF;

    -- Verificar integridad referencial
    SELECT COUNT(*) INTO orphaned_scores
    FROM game_scores gs
    LEFT JOIN users u ON gs.user_id = u.id
    LEFT JOIN games g ON gs.game_id = g.id
    WHERE u.id IS NULL OR g.id IS NULL;

    IF orphaned_scores > 0 THEN
        RAISE EXCEPTION 'Found % orphaned scores', orphaned_scores;
    END IF;

    RAISE NOTICE '‚úÖ Integrity tests passed - Users: %, Games: %', user_count, game_count;
END $$;

```

</Tab>
</Tabs>

### Performance Testing

```sql

- - performance-test.sql
EXPLAIN (ANALYZE, BUFFERS)
SELECT g.title, gs.score, u.username
FROM games g
JOIN game_scores gs ON g.id = gs.game_id
JOIN users u ON gs.user_id = u.id
WHERE g.platform = 'NES'
ORDER BY gs.score DESC
LIMIT 10;

- - Verificar que el query use √≠ndices apropiados
DO $$
DECLARE
    query_plan TEXT;
BEGIN
    SELECT query_plan INTO query_plan FROM (
        EXPLAIN (FORMAT JSON)
        SELECT * FROM games WHERE platform = 'NES' AND genre = 'Action'
    ) AS plan_data;

    IF query_plan NOT LIKE '%Index%' THEN
        RAISE WARNING 'Query may not be using indexes optimally';
    END IF;
END $$;

```

## Estrategias Zero-Downtime

### Blue-Green Deployment con RDS

<Tabs>
<Tab title="Preparaci√≥n Blue-Green">

```bash
#!/bin/bash

# blue-green-migration.sh

BLUE_DB="retrogame-prod"
GREEN_DB="retrogame-staging"

echo "üîÑ Iniciando migraci√≥n Blue-Green..."

# 1. Sincronizar datos de Blue a Green
aws rds create-db-snapshot \
    --db-instance-identifier $BLUE_DB \
    --db-snapshot-identifier "${BLUE_DB}-pre-migration-$(date +%Y%m%d)"

# 2. Restaurar snapshot en Green
aws rds restore-db-instance-from-db-snapshot \
    --db-instance-identifier $GREEN_DB \
    --db-snapshot-identifier "${BLUE_DB}-pre-migration-$(date +%Y%m%d)"

# 3. Ejecutar migraciones en Green
echo "‚¨ÜÔ∏è Ejecutando migraciones en Green..."
flyway -url=jdbc:postgresql://${GREEN_DB}.region.rds.amazonaws.com:5432/retrogame \
       -user=$DB_USER \
       -password=$DB_PASSWORD \
       migrate

# 4. Validar Green
echo "‚úÖ Validando migraci√≥n..."
./validate-green-environment.sh

echo "üéØ Green environment listo para switch"

```

</Tab>
<Tab title="Switch Traffic">

```bash
#!/bin/bash

# switch-traffic.sh

echo "üîÑ Cambiando tr√°fico de Blue a Green..."

# Actualizar Route53 record
aws route53 change-resource-record-sets \
    --hosted-zone-id $HOSTED_ZONE_ID \
    --change-batch '{
        "Changes": [{
            "Action": "UPSERT",
            "ResourceRecordSet": {
                "Name": "db.retrogamecloud.com",
                "Type": "CNAME",
                "TTL": 60,
                "ResourceRecords": [{"Value": "retrogame-staging.region.rds.amazonaws.com"}]
            }
        }]
    }'

# Monitorear por 5 minutos
echo "üìä Monitoreando por 5 minutos..."
for i in {1..5}; do
    echo "Minuto $i/5..."
    curl -f http://health.retrogamecloud.com/db || {
        echo "‚ùå Health check fall√≥, ejecutando rollback..."
        ./rollback-traffic.sh
        exit 1
    }
    sleep 60
done

echo "‚úÖ Switch completado exitosamente"

```

</Tab>
</Tabs>

### Migraciones Compatibles hacia Atr√°s

```sql

- - Ejemplo: Agregar columna sin romper versiones anteriores

- - V004__add_user_avatar.sql

- - Paso 1: Agregar columna como nullable
ALTER TABLE users ADD COLUMN avatar_url TEXT;

- - Paso 2:

```