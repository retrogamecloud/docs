---
title: Procedimientos de Recuperaci√≥n Ante Desastres
description: Gu√≠a completa de disaster recovery con procedimientos paso a paso, RPO/RTO definidos, clasificaci√≥n de servicios por criticidad y simulacros de DR
icon: shield-halved
---

# Procedimientos de Recuperaci√≥n ante Desastres

Esta gu√≠a establece los procedimientos completos de recuperaci√≥n ante desastres (DR) para la plataforma RetroGameCloud, incluyendo clasificaci√≥n de servicios, objetivos de tiempo y punto de recuperaci√≥n, procedimientos detallados por escenario y validaciones post-recovery.

## Clasificaci√≥n de Servicios por Criticidad

### Servicios Cr√≠ticos
<Card title="Servicios de Misi√≥n Cr√≠tica" icon="exclamation-triangle" color="red">
- **Autenticaci√≥n (Auth Service)**
- **Base de Datos Principal (PostgreSQL)**
- **Kong Gateway**
- **Monitoreo y Alertas**
</Card>

### Servicios Importantes
<Card title="Servicios de Alta Prioridad" icon="exclamation" color="orange">
- **Sistema de Puntuaciones (Scores Service)**
- **Gesti√≥n de Salas**
- **API Backend Principal**
- **Redis Cache**
</Card>

### Servicios Normales
<Card title="Servicios de Prioridad Est√°ndar" icon="info" color="blue">
- **CDN y Frontend**
- **Servicios de M√©tricas**
- **Logs Centralizados**
- **Servicios de Notificaciones**
</Card>

## Objetivos de Recuperaci√≥n por Criticidad

### Definiciones Clave

<Card title="RPO - Recovery Point Objective" icon="clock">
  P√©rdida m√°xima de datos aceptable por servicio
</Card>

<Card title="RTO - Recovery Time Objective" icon="stopwatch">
  Tiempo m√°ximo para restaurar servicios por criticidad
</Card>

### Matriz de Criticidad Detallada

| Servicio | Criticidad | RPO | RTO | SLA Recovery |
|----------|------------|-----|-----|--------------|
| **Autenticaci√≥n** | Cr√≠tico | 1 hora | 30 min | 99.9% |
| **Base de Datos Principal** | Cr√≠tico | 1 hora | 30 min | 99.9% |
| **Kong Gateway** | Cr√≠tico | 1 hora | 45 min | 99.9% |
| **Monitoreo** | Cr√≠tico | 2 horas | 1 hora | 99.5% |
| **Scores Service** | Importante | 4 horas | 2 horas | 99.0% |
| **Gesti√≥n de Salas** | Importante | 4 horas | 2 horas | 99.0% |
| **API Backend** | Importante | 4 horas | 1.5 horas | 99.0% |
| **Redis Cache** | Importante | 8 horas | 1 hora | 98.5% |
| **CDN/Frontend** | Normal | 8 horas | 3 horas | 98.0% |
| **Logs** | Normal | 24 horas | 4 horas | 95.0% |

## Estrategias de Backup Automatizado

### Arquitectura de Respaldo

```mermaid
graph TB
    subgraph "Regi√≥n Primaria (Madrid)"
        A[Producci√≥n] --> B[RDS Snapshots Automatizados]
        A --> C[EKS Backup Velero]
        A --> D[S3 Backup Cross-Region]
        A --> E[Terraform State Backup]
        A --> F[Kong Config Backup]
    end

    subgraph "Regi√≥n DR (Frankfurt)"
        G[RDS Cross-Region Replica]
        H[S3 Replication Target]
        I[EKS DR Cluster]
        J[Terraform State Replica]
    end

    B --> G
    C --> I
    D --> H
    E --> J
    F --> H

    subgraph "Backup Externos"
        K[GitLab Repository]
        L[Backup Offsite]
    end

    A --> K
    H --> L

    style A fill:#ff9999
    style G fill:#99ff99
    style I fill:#99ff99
```

### Configuraci√≥n de Backups Automatizados

<Tabs>
  <Tab title="RDS Snapshots">
    ```bash
    # Configuraci√≥n de snapshots automatizados
    aws rds modify-db-instance \
      --db-instance-identifier retrogame-prod \
      --backup-retention-period 30 \
      --preferred-backup-window "03:00-04:00" \
      --preferred-maintenance-window "sun:04:00-sun:05:00"

    # Crear snapshot manual antes de cambios cr√≠ticos
    aws rds create-db-snapshot \
      --db-instance-identifier retrogame-prod \
      --db-snapshot-identifier retrogame-pre-deploy-$(date +%Y%m%d-%H%M%S)

    # Verificar snapshots disponibles
    aws rds describe-db-snapshots \
      --db-instance-identifier retrogame-prod \
      --max-items 10
    ```
  </Tab>

  <Tab title="Velero EKS Backup">
    ```yaml
    # velero-backup-schedule.yaml
    apiVersion: velero.io/v1
    kind: Schedule
    metadata:
      name: retrogame-daily-backup
    spec:
      schedule: "0 2 * * *"  # Daily at 2 AM
      template:
        includedNamespaces:
          - retrogame-prod
          - retrogame-auth
          - retrogame-scores
        excludedResources:
          - pods
          - events
        storageLocation: aws-s3-backup
        ttl: 720h0m0s  # 30 days
    ```
  </Tab>

  <Tab title="Cross-Region Replication">
    ```bash
    # Configurar replicaci√≥n cross-region para RDS
    aws rds create-db-instance-read-replica \
      --db-instance-identifier retrogame-dr-replica \
      --source-db-instance-identifier retrogame-prod \
      --db-instance-class db.t3.medium \
      --destination-region eu-central-1

    # Configurar replicaci√≥n S3
    aws s3api put-bucket-replication \
      --bucket retrogame-backups-prod \
      --replication-configuration file://replication-config.json
    ```
  </Tab>
</Tabs>

## Runbooks por Escenario de Desastre

### Escenario 1: Fallo Total de Regi√≥n AWS

<Tabs>
  <Tab title="Detecci√≥n y Evaluaci√≥n">
    ```bash
    #!/bin/bash
    # dr-region-failure-detection.sh

    echo "=== EVALUACI√ìN DE FALLO DE REGI√ìN ==="
    
    # Verificar conectividad a regi√≥n primaria
    PRIMARY_REGION="eu-west-1"
    DR_REGION="eu-central-1"
    
    echo "Verificando regi√≥n primaria: $PRIMARY_REGION"
    aws ec2 describe-regions --region $PRIMARY_REGION || {
        echo "‚ùå FALLO: Regi√≥n primaria no accesible"
        exit 1
    }
    
    # Verificar servicios cr√≠ticos
    echo "Verificando RDS..."
    aws rds describe-db-instances \
      --db-instance-identifier retrogame-prod \
      --region $PRIMARY_REGION || echo "‚ùå RDS no accesible"
    
    echo "Verificando EKS..."
    aws eks describe-cluster \
      --name retrogame-prod \
      --region $PRIMARY_REGION || echo "‚ùå EKS no accesible"
    
    echo "Verificando √∫ltimo snapshot disponible..."
    LATEST_SNAPSHOT=$(aws rds describe-db-snapshots \
      --db-instance-identifier retrogame-prod \
      --region $PRIMARY_REGION \
      --query 'DBSnapshots[0].DBSnapshotIdentifier' \
      --output text 2>/dev/null)
    
    if [ "$LATEST_SNAPSHOT" != "None" ]; then
        echo "‚úÖ √öltimo snapshot: $LATEST_SNAPSHOT"
    else
        echo "‚ö†Ô∏è  Verificando snapshots en regi√≥n DR..."
    fi
    ```
  </Tab>

  <Tab title="Activaci√≥n DR">
    ```bash
    #!/bin/bash
    # dr-region-failover.sh

    echo "=== INICIANDO PROCEDIMIENTO DE DISASTER RECOVERY ==="
    
    DR_REGION="eu-central-1"
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    
    # 1. Promocionar replica de RDS
    echo "Promoviendo replica RDS a master..."
    aws rds promote-read-replica \
      --db-instance-identifier retrogame-dr-replica \
      --region $DR_REGION
    
    # Esperar hasta que est√© disponible
    echo "Esperando promoci√≥n de RDS..."
    aws rds wait db-instance-available \
      --db-instance-identifier retrogame-dr-replica \
      --region $DR_REGION
    
    # 2. Desplegar EKS en regi√≥n DR
    echo "Desplegando EKS cluster en regi√≥n DR..."
    cd terraform/disaster-recovery
    terraform workspace select dr-frankfurt
    terraform apply -auto-approve
    
    # 3. Restaurar aplicaciones
    echo "Restaurando aplicaciones desde backup..."
    velero restore create retrogame-dr-restore-$TIMESTAMP \
      --from-backup retrogame-daily-backup-latest \
      --wait
    
    # 4. Actualizar DNS
    echo "Actualizando registros DNS..."
    aws route53 change-resource-record-sets \
      --hosted-zone-id Z1D633PJN98FT9 \
      --change-batch file://dns-failover-batch.json
    
    echo "‚úÖ Disaster Recovery completado"
    echo "üîç Iniciando validaciones..."
    ```
  </Tab>

  <Tab title="Validaci√≥n Post-Recovery">
    ```bash
    #!/bin/bash
    # dr-validation.sh

    echo "=== VALIDACI√ìN POST-RECOVERY ==="
    
    DR_ENDPOINT="https://retrogame-dr.cloud"
    
    # Test de conectividad b√°sica
    echo "Verificando conectividad web..."
    curl -f $DR_ENDPOINT/health || {
        echo "‚ùå Endpoint web no accesible"
        exit 1
    }
    
    # Test de autenticaci√≥n
    echo "Verificando servicio de autenticaci√≥n..."
    curl -f $DR_ENDPOINT/api/auth/health || {
        echo "‚ùå Servicio de auth no disponible"
        exit 1
    }
    
    # Test de base de datos
    echo "Verificando conexi√≥n a BD..."
    kubectl exec -n retrogame-prod deployment/api -- \
      pg_isready -h retrogame-dr-replica.cluster.eu-central-1.rds.amazonaws.com || {
        echo "‚ùå Base de datos no accesible"
        exit 1
    }
    
    # Test funcional b√°sico
    echo "Ejecutando tests funcionales..."
    npm run test:e2e:critical
    
    echo "‚úÖ Validaci√≥n completada exitosamente"
    ```
  </Tab>
</Tabs>

### Escenario 2: Corrupci√≥n de Base de Datos

<Tabs>
  <Tab title="Detecci√≥n">
    ```bash
    #!/bin/bash
    # db-corruption-detection.sh

    echo "=== DETECCI√ìN DE CORRUPCI√ìN DE BD ==="
    
    # Verificar integridad de BD
    kubectl exec -n retrogame-prod deployment/api -- psql -c "
    SELECT 
        schemaname, 
        tablename, 
        pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
        pg_stat_get_live_tuples(c.oid) as live_tuples,
        pg_stat_get_dead_tuples(c.oid) as dead_tuples
    FROM pg_tables t
    JOIN pg_class c ON c.relname = t.tablename
    WHERE schemaname = 'public'
    ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
    "
    
    # Verificar logs de errores
    aws rds describe-db-log-files \
      --db-instance-identifier retrogame-prod \
      --filename-contains error
    
    # Test de queries cr√≠ticas
    kubectl exec -n retrogame-prod deployment/api -- psql -c "
    SELECT COUNT(*) FROM users WHERE created_at > NOW() - INTERVAL '1 hour';
    SELECT COUNT(*) FROM scores WHERE created_at > NOW() - INTERVAL '1 hour';
    "
    ```
  </Tab>

  <Tab title="Recuperaci√≥n">
    ```bash
    #!/bin/bash
    # db-corruption-recovery.sh

    echo "=== RECUPERACI√ìN DE CORRUPCI√ìN DE BD ==="
    
    RECOVERY_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    
    # 1. Detener aplicaciones para evitar m√°s corrupci√≥n
    echo "Deteniendo aplicaciones..."
    kubectl scale deployment api --replicas=0 -n retrogame-prod
    kubectl scale deployment auth-service --replicas=0 -n retrogame-prod
    
    # 2. Crear snapshot del estado actual (para forense)
    echo "Creando snapshot del estado corrupto..."
    aws rds create-db-snapshot \
      --db-instance-identifier retrogame-prod \
      --db-snapshot-identifier corrupted-state-$RECOVERY_TIMESTAMP
    
    # 3. Identificar √∫ltimo snapshot v√°lido
    echo "Identificando √∫ltimo snapshot v√°lido..."
    VALID_SNAPSHOT=$(aws rds describe-db-snapshots \
      --db-instance-identifier retrogame-prod \
      --query 'DBSnapshots[?Status==`available`] | [0].DBSnapshotIdentifier' \
      --output text)
    
    echo "Usando snapshot: $VALID_SNAPSHOT"
    
    # 4. Restaurar desde snapshot
    echo "Restaurando BD desde snapshot..."
    aws rds restore-db-instance-from-db-snapshot \
      --db-instance-identifier retrogame-recovered-$RECOVERY_TIMESTAMP \
      --db-snapshot-identifier $VALID_SNAPSHOT \
      --db-instance-class db.t3.large
    
    # 5. Esperar hasta que est√© disponible
    aws rds wait db-instance-available \
      --db-instance-identifier retrogame-recovered-$RECOVERY_TIMESTAMP
    
    echo "‚úÖ BD restaurada exitosamente"
    ```
  </Tab>
</Tabs>

### Escenario 3: Ataque de Ransomware

<Tabs>
  <Tab title="Contenci√≥n">
    ```bash
    #!/bin/bash
    # ransomware-containment.sh

    echo "=== CONTENCI√ìN DE RANSOMWARE ==="
    
    # 1. Aislamiento inmediato
    echo "Aislando sistemas comprometidos..."
    
    # Revocar tokens de acceso activos
    kubectl delete secret aws-credentials -n retrogame-prod
    kubectl delete secret database-credentials -n retrogame-prod
    
    # Deshabilitar acceso SSH
    aws ec2 modify-instance-attribute \
      --instance-id i-1234567890abcdef0 \
      --groups sg-emergency-lockdown
    
    # Detener servicios no cr√≠ticos
    kubectl scale deployment --all --replicas=0 -n retrogame-prod
</Tab>
</Tabs>
```