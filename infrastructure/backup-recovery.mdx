---
title: Estrategia de Respaldo y Recuperación Ante Desastres
description: Documentación completa sobre backups, disaster recovery, RPO/RTO y procedimientos
  de restauración para RetroGameCloud
icon: shield-check
---

# Estrategia de Respaldo y Recuperación ante Desastres

<Note>
Esta documentación cubre la estrategia completa de backup y disaster recovery (DR) para la plataforma RetroGameCloud, incluyendo objetivos de recuperación, procedimientos automatizados y runbooks de emergencia.
</Note>

## Objetivos de Recuperación

### RPO (Recovery Point Objective)

- **Base de Datos Principal**: 1 hora máximo
- **Archivos de Juegos (S3)**: 24 horas máximo
- **Configuraciones de Kubernetes**: 1 hora máximo
- **Configuración Kong Gateway**: 1 hora máximo

### RTO (Recovery Time Objective)

- **Servicios Críticos**: 4 horas máximo
- **Base de Datos**: 2 horas máximo
- **Frontend y CDN**: 30 minutos máximo
- **API Gateway**: 1 hora máximo

## Configuración de Backups Automatizados

### Base de Datos RDS PostgreSQL

<Tabs>
<Tab title="Configuración Terraform">

```hcl
resource "aws_db_instance" "retrogamecloud_db" {
  identifier = "retrogamecloud-prod"

  # Configuración de backups automatizados
  backup_retention_period = 7
  backup_window          = "03:00-04:00"
  maintenance_window     = "sun:04:00-sun:05:00"

  # Snapshots finales
  final_snapshot_identifier = "retrogamecloud-final-snapshot"
  skip_final_snapshot      = false

  # Cifrado
  storage_encrypted = true

  # Multi-AZ para alta disponibilidad
  multi_az = true

  # Monitoreo mejorado
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_enhanced_monitoring.arn

  tags = {
    Environment = "production"
    Backup      = "automated"
  }
}

# Snapshots manuales programados
resource "aws_lambda_function" "db_snapshot" {
  filename      = "db_snapshot.zip"
  function_name = "retrogamecloud-manual-snapshot"
  role         = aws_iam_role.lambda_snapshot_role.arn
  handler      = "index.handler"
  runtime      = "python3.9"
}

resource "aws_cloudwatch_event_rule" "snapshot_schedule" {
  name                = "db-snapshot-schedule"
  description         = "Trigger for manual DB snapshots"
  schedule_expression = "cron(0 */6 * * ? *)"
}
```

</Tab>
<Tab title="Backup S3 Kong Config">

```hcl
resource "aws_s3_bucket" "kong_config_backup" {
  bucket = "retrogamecloud-kong-config-backup"

  versioning {
    enabled = true
  }

  lifecycle_configuration {
    rule {
      enabled = true
      id      = "kong_config_retention"

      expiration {
        days = 90
      }

      noncurrent_version_expiration {
        days = 30
      }
    }
  }
}

# Lambda para backup automático de Kong
resource "aws_lambda_function" "kong_backup" {
  filename      = "kong_backup.zip"
  function_name = "retrogamecloud-kong-backup"
  role         = aws_iam_role.lambda_backup_role.arn
  handler      = "kong_backup.handler"
  runtime      = "python3.9"

  environment {
    variables = {
      KONG_ADMIN_URL = "http://kong-admin.retrogamecloud.local:8001"
      S3_BUCKET      = aws_s3_bucket.kong_config_backup.bucket
    }
  }
}
```

</Tab>
</Tabs>

## Procedimientos de Disaster Recovery

### Procedimiento Paso a Paso de Restauración

<Steps>
<Step title="1. Crear Nueva Base de Datos desde Snapshot">

```bash
# Listar snapshots disponibles
aws rds describe-db-snapshots \
  --db-instance-identifier retrogamecloud-prod \
  --snapshot-type automated

# Restaurar desde el último snapshot
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier retrogamecloud-dr-$(date +%Y%m%d) \
  --db-snapshot-identifier rds:retrogamecloud-prod-$(date +%Y-%m-%d-06-00) \
  --db-instance-class db.r5.large \
  --multi-az \
  --storage-encrypted
```

</Step>

<Step title="2. Recrear Infraestructura en Región Alternativa">

```bash
# Configurar región de DR
export AWS_DEFAULT_REGION=us-east-1
export TF_VAR_environment=disaster-recovery

# Aplicar configuración de Terraform
cd infrastructure/terraform
terraform workspace select dr || terraform workspace new dr
terraform init
terraform plan -var="database_endpoint=retrogamecloud-dr.cluster-xxx.us-east-1.rds.amazonaws.com"
terraform apply -auto-approve
```

</Step>

<Step title="3. Recrear Cluster EKS">

```bash
# Obtener credenciales del nuevo cluster
aws eks update-kubeconfig --region us-east-1 --name retrogamecloud-dr

# Aplicar manifiestos desde Git
kubectl apply -f k8s/namespaces/
kubectl apply -f k8s/configs/
kubectl apply -f k8s/deployments/
kubectl apply -f k8s/services/
```

</Step>

<Step title="4. Restaurar Configuración Kong">

```bash
# Descargar último backup de Kong desde S3
aws s3 cp s3://retrogamecloud-kong-config-backup/latest/kong-config.json ./

# Restaurar configuración
curl -X POST http://kong-admin:8001/config \
  -F config=@kong-config.json

# Verificar configuración
curl -X GET http://kong-admin:8001/services
curl -X GET http://kong-admin:8001/routes
```

</Step>

<Step title="5. Actualizar Registros DNS">

```bash
# Obtener nueva dirección del Load Balancer
NEW_LB=$(kubectl get svc kong-proxy -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

# Actualizar Route53 (usando CLI o Terraform)
aws route53 change-resource-record-sets \
  --hosted-zone-id Z123456789 \
  --change-batch file://dns-update.json
```

DNS Update JSON:
```json
{
  "Changes": [{
    "Action": "UPSERT",
    "ResourceRecordSet": {
      "Name": "api.retrogamecloud.com",
      "Type": "CNAME",
      "TTL": 300,
      "ResourceRecords": [{"Value": "${NEW_LB}"}]
    }
  }]
}
```

</Step>

<Step title="6. Verificar Health Checks">

```bash
# Health check de la API
curl -f https://api.retrogamecloud.com/health

# Health check de la base de datos
kubectl exec -it $(kubectl get pods -l app=backend -o jsonpath='{.items[0].metadata.name}') -- \
  psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c "SELECT version();"

# Health check de Kong
curl -f http://kong-admin:8001/status
```

</Step>
</Steps>

## Checklist de Validación Post-Recovery

### Validación de Servicios

<Tabs>
<Tab title="Base de Datos">

- [ ] Conexión a la base de datos establecida
- [ ] Integridad de datos verificada
- [ ] Usuarios y permisos restaurados
- [ ] Backups automáticos reconfigurados
- [ ] Monitoreo y alertas activos

```bash
# Script de validación de BD
#!/bin/bash
echo "Validando conexión a BD..."
kubectl exec -it postgres-client -- psql -h $NEW_DB_HOST -c "SELECT count(*) FROM users;"

echo "Verificando integridad..."
kubectl exec -it postgres-client -- psql -h $NEW_DB_HOST -c "SELECT pg_database_size(current_database());"

echo "Validando backups automáticos..."
aws rds describe-db-instances --db-instance-identifier retrogamecloud-dr --query 'DBInstances[0].BackupRetentionPeriod'
```

</Tab>

<Tab title="Aplicaciones">

- [ ] Todos los pods en estado Running
- [ ] Health checks respondiendo
- [ ] APIs funcionales
- [ ] Autenticación funcionando
- [ ] Logs siendo generados correctamente

```bash
# Validación de aplicaciones
kubectl get pods --all-namespaces | grep -v Running
curl -f https://api.retrogamecloud.com/api/v1/games | jq .
curl -f https://retrogamecloud.com | grep -q "RetroGameCloud"
```

</Tab>

<Tab title="Kong Gateway">

- [ ] Kong Admin API accesible
- [ ] Todas las rutas configuradas
- [ ] Plugins funcionando
- [ ] Rate limiting activo
- [ ] SSL/TLS configurado

```bash
# Validación Kong
curl -s http://kong-admin:8001/status | jq .database.reachable
curl -s http://kong-admin:8001/services | jq '.data | length'
curl -s http://kong-admin:8001/routes | jq '.data | length'
curl -I https://api.retrogamecloud.com | grep -q "HTTP/2 200"
```

</Tab>
</Tabs>

### Checklist de Validación Completa

<Note>
**Tiempo estimado de validación**: 30-45 minutos
</Note>

1. **Infraestructura Base** (10 min)
   - [ ] EKS cluster operativo
   - [ ] Nodos de trabajo disponibles
   - [ ] Load balancers configurados
   - [ ] Certificados SSL válidos

2. **Base de Datos** (10 min)
   - [ ] RDS instance en estado available
   - [ ] Conexiones desde aplicaciones
   - [ ] Datos críticos verificados
   - [ ] Performance baseline establecida

3. **Aplicaciones** (15 min)
   - [ ] Frontend accesible
   - [ ] API respondiendo
   - [ ] Autenticación funcionando
   - [ ] Funciones críticas validadas

4. **Monitoreo** (10 min)
   - [ ] Métricas fluyendo a CloudWatch
   - [ ] Alertas configuradas
   - [ ] Dashboards operativos
   - [ ] Logs centralizados

## Calendario de Simulacros de DR

### Simulacros Trimestrales

<Tabs>
<Tab title="Q1 - Enero">

**Simulacro Completo de Región**
- **Fecha**: Segundo sábado de enero
- **Duración**: 4-6 horas
- **Alcance**: Failover completo a región secundaria
- **Participantes**: DevOps, Backend, QA

**Objetivos**:
- Validar RTO/RPO reales
- Probar procedimientos completos
- Actualizar documentación

</Tab>

<Tab title="Q2 - Abril">

**Simulacro de Base de Datos**
- **Fecha**: Segundo sábado de abril
- **Duración**: 2-3 horas
- **Alcance**: Solo restauración de BD
- **Participantes**: DevOps, Backend

**Objetivos**:
- Validar snapshots automáticos
- Probar restauración point-in-time
- Verificar integridad de datos

</Tab>

<Tab title="Q3 - Julio">

**Simulacro de Aplicaciones**
- **Fecha**: Segundo sábado de julio
- **Duración**: 3-4 horas
- **Alcance**: Recreación de cluster y apps
- **Participantes**: DevOps, Backend, Frontend

**Objetivos**:
- Validar manifiestos K8s
- Probar configuración Kong
- Verificar funcionalidad end-to-end

</Tab>

<Tab title="Q4 - Octubre">

**Simulacro de Chaos Engineering**
- **Fecha**: Segundo sábado de octubre
- **Duración**: 6-8 horas
- **Alcance**: Fallos aleatorios múltiples
- **Participantes**: Todo el equipo

**Objetivos**:
- Probar resistencia del sistema
- Validar alertas y respuesta
- Mejorar procedimientos de escalación

</Tab>
</Tabs>

### Métricas de Simulacros

```yaml
# Métricas a rastrear en cada simulacro
metrics:
  rpo_achieved: "tiempo hasta último backup válido"
  rto_achieved: "tiempo total de restauración"
  data_loss: "cantidad de datos perdidos"
  false_positives: "alertas incorrectas"
  procedure_gaps: "pasos faltantes en documentación"
  
# Dashboard de seguimiento
simulacro_dashboard:
  - rto_trend: "tendencia de tiempo de recuperación"
  - success_rate: "tasa de éxito de simulacros"
  - team_readiness: "preparación del equipo"
```

## Contactos de Emergencia

### Escalación de Incidentes

1. **Nivel 1 - DevOps On-Call**
   - Slack: `@devops-oncall`
   - Teléfono: +1-XXX-XXX-XXXX

2. **Nivel 2 - Lead DevOps**
   - Email: devops-lead@retrogamecloud.com
   - Teléfono: +1-XXX-XXX-XXXX

3. **Nivel 3 - CTO**
   - Email: cto@retrogamecloud.com
   - Teléfono: +1-XXX-XXX-XXXX

### Vendors y Soporte

- **AWS Support**: Caso de Enterprise Support
- **Kong Support**: Portal de soporte técnico
- **Datadog**: Soporte 24/7 via chat

<Warning>
Mantén esta documentación actualizada después de cada simulacro y cambio de infraestructura. Los procedimientos desactualizados pueden ser peores que no tener procedimientos.
</Warning>