---
title: 6.9. Troubleshooting de Redis
description: 'Resolución de problemas comunes con Redis en el sistema de rankings:
  cache eviction, conexiones, clustering y persistencia'
icon: wrench
---

# Guía de Troubleshooting de Redis

Esta guía te ayudará a identificar y resolver los problemas más comunes relacionados con Redis en el sistema de rankings de RetroGameCloud.

## Problema: Rankings Desactualizados

### Síntomas

- Los rankings muestran datos antiguos después de nuevos scores

- Puntuaciones recientes no aparecen en los leaderboards

- Inconsistencias entre el ranking y la base de datos

### Diagnóstico

<Tabs>
<Tab title="Verificar Cache">

```bash

# Conectar a Redis
redis-cli -h redis-cluster.retrogame.local -p 6379

# Verificar claves de ranking
KEYS ranking:*

# Comprobar TTL de las claves
TTL ranking:game:123:daily
TTL ranking:game:123:weekly

# Verificar contenido del ranking
ZREVRANGE ranking:game:123:daily 0 10 WITHSCORES

```

</Tab>
<Tab title="Verificar Conectividad">

```bash

# Ping básico
redis-cli ping

# Verificar info del servidor
redis-cli info replication
redis-cli info memory

# Verificar logs de aplicación
kubectl logs -f deployment/ranking-service | grep redis

```

</Tab>
</Tabs>

### Soluciones

<Warning>
Antes de realizar cambios en producción, verifica en un entorno de desarrollo.
</Warning>

#### 1. Limpiar Cache Específico

```bash

# Eliminar rankings específicos
redis-cli DEL ranking:game:123:daily
redis-cli DEL ranking:game:123:weekly
redis-cli DEL ranking:global:monthly

# Forzar regeneración desde el servicio
curl -X POST "https://api.retrogame.cloud/rankings/refresh/123" \
  -H "Authorization: Bearer $TOKEN"

```

#### 2. Verificar TTL y Expiración

```javascript
// Configuración recomendada en ranking-service
const RANKING_TTL = {
  daily: 3600,     // 1 hora
  weekly: 7200,    // 2 horas
  monthly: 14400,  // 4 horas
  alltime: 86400   // 24 horas
};

// Verificar que se está configurando correctamente
await redis.zadd(`ranking:game:${gameId}:${period}`, score, userId);
await redis.expire(`ranking:game:${gameId}:${period}`, RANKING_TTL[period]);

```

## Problema: Errores de Conexión

### Síntomas

- `ECONNREFUSED` en logs del servicio

- Timeouts al acceder a Redis

- Rankings no se actualizan

### Diagnóstico

<Note>
Verifica primero la conectividad de red antes de revisar la configuración de Redis.
</Note>

<Tabs>
<Tab title="Verificar Estado">

```bash

# Estado del pod Redis
kubectl get pods -l app=redis-cluster -o wide

# Logs de Redis
kubectl logs -f redis-cluster-0

# Verificar servicios
kubectl get svc | grep redis

```

</Tab>
<Tab title="Verificar Configuración">

```yaml

# Verificar ConfigMap de Redis
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
data:
  redis.conf: |
    maxmemory 2gb
    maxmemory-policy allkeys-lru
    maxclients 10000
    timeout 0
    tcp-keepalive 300

```

</Tab>
</Tabs>

### Soluciones

#### 1. Pool de Conexiones

```javascript
// Configuración optimizada para el cliente Redis
const redis = new Redis.Cluster([
  {
    host: 'redis-cluster.retrogame.local',
    port: 6379
  }
], {
  redisOptions: {
    connectTimeout: 10000,
    lazyConnect: true,
    maxRetriesPerRequest: 3,
    retryDelayOnFailover: 1000,
    family: 4,
    keepAlive: true
  },
  maxRetriesPerRequest: 3,
  retryDelayOnFailover: 1000,
  enableOfflineQueue: false,
  clusterRetryDelay: 1000,
  scaleReads: 'slave'
});

```

#### 2. Circuit Breaker

```javascript
const CircuitBreaker = require('opossum');

const redisOptions = {
  timeout: 3000,
  errorThresholdPercentage: 50,
  resetTimeout: 30000
};

const breaker = new CircuitBreaker(updateRanking, redisOptions);

```

## Problema: Memory Eviction

### Síntomas

- Rankings desaparecen inesperadamente

- Logs con `maxmemory` warnings

- Performance degradada

### Diagnóstico

```bash

# Verificar uso de memoria
redis-cli info memory

# Ver política de eviction actual
redis-cli config get maxmemory-policy

# Monitorear evictions
redis-cli info stats | grep evicted

```

### Configuración Recomendada

<Tabs>
<Tab title="Política LRU">

```bash

# Configurar eviction policy para rankings
redis-cli config set maxmemory-policy allkeys-lru
redis-cli config set maxmemory 4gb

# Guardar configuración
redis-cli config rewrite

```

</Tab>
<Tab title="Monitorización">

```yaml

# Alerta en Prometheus

- alert: RedisMemoryHigh
  expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.8
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "Redis memory usage is high"
    description: "Redis instance {{ $labels.instance }} memory usage is above 80%"

```

</Tab>
</Tabs>

## Configuración Cluster vs Standalone

### Cuándo usar cada uno

<Card title="Redis Standalone" icon="server" href="#standalone-config">
Ideal para desarrollo y sistemas pequeños con menos de 100k operaciones/día
</Card>

<Card title="Redis Cluster" icon="network-wired" href="#cluster-config">
Recomendado para producción con alta disponibilidad y escalabilidad
</Card>

### Configuración Cluster

```yaml

# redis-cluster.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-cluster
spec:
  serviceName: redis-cluster
  replicas: 6
  selector:
    matchLabels:
      app: redis-cluster
  template:
    metadata:
      labels:
        app: redis-cluster
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        - containerPort: 16379
        command:
        - redis-server
        - /etc/redis/redis.conf
        - --cluster-enabled
        - --cluster-config-file
        - /data/nodes.conf
        - --cluster-node-timeout
        - "5000"
        - --appendonly
        - "yes"

```

## Persistencia RDB vs AOF

### Comparación

| Característica | RDB | AOF |
|---|---|---|
| **Tamaño** | Compacto | Más grande |
| **Velocidad de carga** | Rápida | Lenta |
| **Durabilidad** | Puede perder datos | Más durable |
| **CPU Impact** | Bajo | Medio-Alto |

### Configuración Híbrida Recomendada

<Tabs>
<Tab title="Configuración">

```bash

# Habilitar ambos métodos
redis-cli config set save "900 1 300 10 60 10000"
redis-cli config set appendonly yes
redis-cli config set appendfsync everysec
redis-cli config set no-appendfsync-on-rewrite no
redis-cli config set auto-aof-rewrite-percentage 100
redis-cli config set auto-aof-rewrite-min-size 64mb

```

</Tab>
<Tab title="Monitoring">

```javascript
// Script para monitorear persistencia
const checkPersistence = async () => {
  const info = await redis.info('persistence');
  console.log('RDB last save:', info.rdb_last_save_time);
  console.log('AOF last rewrite:', info.aof_last_rewrite_time);
  console.log('AOF size:', info.aof_current_size);
};

```

</Tab>
</Tabs>

## Monitorización y Alertas

### Métricas Clave

```yaml

# Grafana Dashboard queries

- redis_connected_clients

- redis_blocked_clients

- redis_memory_used_bytes

- redis_keyspace_hits_total

- redis_keyspace_misses_total

- redis_commands_processed_total

```

### Alertas Críticas

<Warning>
Configura estas alertas para detectar problemas antes de que afecten a los usuarios.
</Warning>

```yaml
groups:

- name: redis.rules
  rules:
  - alert: RedisDown
    expr: redis_up == 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: Redis instance is down

  - alert: RedisMemoryHigh
    expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
    for: 2m
    labels:
      severity: critical

  - alert: RedisSlowQueries
    expr: increase(redis_slowlog_length[5m]) > 10
    for: 1m
    labels:
      severity: warning

```

## Comandos Útiles de Debugging

```bash

# Información general
redis-cli info

# Ver comandos lentos
redis-cli slowlog get 10

# Monitorear comandos en tiempo real
redis-cli monitor

# Verificar configuración actual
redis-cli config get "*"

# Analizar uso de memoria por tipo
redis-cli --bigkeys

# Verificar latencia
redis-cli --latency -h redis-cluster.retrogame.local

```

<Note>
Para más información sobre optimización de Redis, consulta la [documentación oficial de Redis](https://redis.io/documentation) y las métricas específicas en tu dashboard de Grafana.
</Note>