name: Daily Documentation Analysis & Reorganization

on:
  # Ejecutar diariamente a medianoche (an√°lisis completo)
  schedule:
    - cron: '0 0 * * *'  # Todos los d√≠as a las 00:00 UTC
  
  # Permitir ejecuci√≥n manual para pruebas
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'Profundidad del an√°lisis'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - deep
      reorganize_structure:
        description: 'Reorganizar estructura de docs.json'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # Flujo secuencial:
  # 1. intelligent-doc-analyzer.py analiza toda la documentaci√≥n y genera IMPROVEMENTS.md
  # 2. reorganize-docs-structure.py reorganiza docs.json bas√°ndose en el an√°lisis y genera STRUCTURE_CHANGELOG.md
  # 3. Se crea un PR con ambos resultados
  intelligent-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0  # Historia completa para an√°lisis
          
      - name: Checkout all source repos
        run: |
          mkdir -p .analysis-repos
          
          echo "üì¶ Clonando repositorios para an√°lisis completo..."
          
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/backend.git .analysis-repos/backend
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/frontend.git .analysis-repos/frontend
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/kong.git .analysis-repos/kong
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/infrastructure.git .analysis-repos/infrastructure
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/kubernetes.git .analysis-repos/kubernetes
          
          echo "‚úÖ Todos los repositorios clonados"
          
      - name: Setup Python for Claude
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic pyyaml markdown json-repair
          
      - name: Run Intelligent Analysis
        id: analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANALYSIS_DEPTH: ${{ inputs.analysis_depth || 'full' }}
        run: |
          echo "ü§ñ Iniciando an√°lisis inteligente de documentaci√≥n..."
          echo "üìä Profundidad: $ANALYSIS_DEPTH"
          
          python .github/scripts/intelligent-doc-analyzer.py \
            --docs-path . \
            --repos-path .analysis-repos \
            --depth $ANALYSIS_DEPTH \
            --output analysis-results.json
          
          if [ -f "IMPROVEMENTS.md" ]; then
            echo "‚úÖ An√°lisis completado - IMPROVEMENTS.md generado"
            echo "analysis_completed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  An√°lisis completado pero sin mejoras que aplicar"
            echo "analysis_completed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Reorganize Documentation Structure
        if: steps.analysis.outputs.analysis_completed == 'true' && inputs.reorganize_structure != 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üìê Reorganizando estructura bas√°ndose en el an√°lisis previo..."
          echo "‚è≥ Esperando 2 segundos para asegurar que el an√°lisis est√° completo..."
          sleep 2
          
          python .github/scripts/reorganize-docs-structure.py \
            --docs-path . \
            --output-changelog STRUCTURE_CHANGELOG.md
          
          if [ -f "STRUCTURE_CHANGELOG.md" ]; then
            echo "‚úÖ Estructura reorganizada - STRUCTURE_CHANGELOG.md generado"
          fi
          
      - name: Create improvement proposals
        run: |
          if [ -f "analysis-results.json" ]; then
            echo "üìã Propuestas de mejora generadas"
            cat analysis-results.json | python -m json.tool || true
          fi
          
      - name: Create PR with improvements
        if: hashFiles('IMPROVEMENTS.md') != ''
        run: |
          git config user.name "claude-ai-bot[bot]"
          git config user.email "claude-ai-bot[bot]@users.noreply.github.com"
          
          BRANCH_NAME="docs/intelligent-improvements-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # A√±adir archivos relevantes (docs.json + archivos .mdx modificados)
          git add docs.json IMPROVEMENTS.md STRUCTURE_CHANGELOG.md analysis-results.json 2>/dev/null || true
          git add api-reference/ 2>/dev/null || true
          git add docs/ 2>/dev/null || true
          git add cicd/ infrastructure/ services/ frontend/ 2>/dev/null || true
          git add *.mdx 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No hay cambios que commitear"
          else
            git commit -m "docs: Mejoras inteligentes y reorganizaci√≥n estructural" \
              -m "An√°lisis autom√°tico de documentaci√≥n completa" \
              -m "Generado autom√°ticamente por Claude Sonnet 4.5"
            
            git push -u origin "$BRANCH_NAME"
            
            gh pr create \
              --title "ü§ñ Mejoras y reorganizaci√≥n autom√°tica ($(date +%Y-%m-%d))" \
              --body "An√°lisis autom√°tico de documentaci√≥n y reorganizaci√≥n estructural. Ver archivos IMPROVEMENTS.md y STRUCTURE_CHANGELOG.md" \
              --label "documentation,enhancement" \
              --base main || echo "‚ö†Ô∏è  No se pudo crear PR autom√°ticamente"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          
      - name: Cleanup
        if: always()
        run: |
          rm -rf .analysis-repos
          echo "‚úÖ Limpieza completada"
