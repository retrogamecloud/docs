name: Daily Documentation Analysis & Reorganization

on:
  # Ejecutar despu√©s de cada push a main (an√°lisis incremental autom√°tico)
  push:
    branches:
      - main
    paths:
      - '**.mdx'
      - 'docs.json'
      - '.github/scripts/**'
  
  # Ejecutar diariamente a medianoche (an√°lisis completo)
  schedule:
    - cron: '0 0 * * *'  # Todos los d√≠as a las 00:00 UTC
  
  # Permitir ejecuci√≥n manual para pruebas
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'Profundidad del an√°lisis'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - deep
      reorganize_structure:
        description: 'Reorganizar estructura de docs.json'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # Flujo secuencial:
  # 1. intelligent-doc-analyzer.py analiza toda la documentaci√≥n y genera IMPROVEMENTS.md
  # 2. reorganize-docs-structure.py reorganiza docs.json bas√°ndose en el an√°lisis y genera STRUCTURE_CHANGELOG.md
  # 3. Se crea un PR con ambos resultados
  intelligent-review:
    runs-on: ubuntu-latest
    
    # Permisos expl√≠citos siguiendo el principio de privilegio m√≠nimo
    permissions:
      contents: write        # Necesario para hacer commits y push
      pull-requests: write   # Necesario para crear PRs
      issues: write          # Necesario para crear issues si hay problemas
    
    # Evitar loops infinitos: no ejecutar si el commit es del bot
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip-ci]')
    
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0  # Historia completa para an√°lisis
          
      - name: Checkout all source repos
        run: |
          # Limpiar .analysis-repos anteriores si existen
          rm -rf .analysis-repos
          mkdir -p .analysis-repos
          
          echo "üì¶ Clonando repositorios para an√°lisis completo..."
          
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/backend.git .analysis-repos/backend
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/frontend.git .analysis-repos/frontend
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/kong.git .analysis-repos/kong
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/infrastructure.git .analysis-repos/infrastructure
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/retrogamecloud/kubernetes.git .analysis-repos/kubernetes
          
          # Eliminar directorios .git para evitar que se detecten como submodules
          find .analysis-repos -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "‚úÖ Todos los repositorios clonados y limpiados"
          
      - name: Setup Python for Claude
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install anthropic pyyaml markdown json-repair requests
      
      - name: Auto-fix Quick Wins
        id: autofix
        run: |
          echo "üîß Aplicando correcciones autom√°ticas..."
          python .github/scripts/auto-fix-quick-wins.py \
            --docs-path . \
            --report-output AUTO_FIXES_REPORT.md
          echo "autofix_completed=true" >> $GITHUB_OUTPUT
      
      - name: Validate Links
        id: links
        continue-on-error: true
        run: |
          echo "üîó Validando links..."
          python .github/scripts/validate-links.py \
            --docs-path . \
            --rate-limit 0.5 \
            --output broken-links.json \
            --report BROKEN_LINKS_REPORT.md || true
          echo "links_validated=true" >> $GITHUB_OUTPUT
      
      - name: Analyze Code with AST
        id: ast
        run: |
          echo "üìù Analizando c√≥digo fuente..."
          python .github/scripts/ast-code-analyzer.py \
            --repos-path .analysis-repos \
            --output undocumented-apis.json \
            --report UNDOCUMENTED_APIS_REPORT.md
          echo "ast_completed=true" >> $GITHUB_OUTPUT
      
      - name: Generate Diagrams
        id: diagrams
        run: |
          echo "üé® Generando diagramas..."
          python .github/scripts/auto-generate-diagrams.py \
            --repos-path .analysis-repos \
            --docs-path . \
            --output generated-diagrams.json
          echo "diagrams_generated=true" >> $GITHUB_OUTPUT
      
      - name: Incremental Analysis Check
        id: incremental
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANALYSIS_DEPTH: ${{ inputs.analysis_depth || 'full' }}
        run: |
          echo "üîÑ Verificando necesidad de an√°lisis completo..."
          python .github/scripts/incremental-analysis-cache.py \
            --docs-path . \
            --full-interval-days 7 \
            --output incremental-analysis.json
          
          # Determinar si se necesita an√°lisis completo
          if grep -q '"analysis_type": "full"' incremental-analysis.json; then
            echo "needs_full_analysis=true" >> $GITHUB_OUTPUT
          else
            echo "needs_full_analysis=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Run Intelligent Analysis
        id: analysis
        if: steps.incremental.outputs.needs_full_analysis == 'true' || inputs.analysis_depth == 'deep'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANALYSIS_DEPTH: ${{ inputs.analysis_depth || 'full' }}
        run: |
          echo "ü§ñ Iniciando an√°lisis inteligente de documentaci√≥n..."
          echo "üìä Profundidad: $ANALYSIS_DEPTH"
          
          python .github/scripts/intelligent-doc-analyzer.py \
            --docs-path . \
            --repos-path .analysis-repos \
            --depth $ANALYSIS_DEPTH \
            --output analysis-results.json
          
          if [ -f "IMPROVEMENTS.md" ]; then
            echo "‚úÖ An√°lisis completado - IMPROVEMENTS.md generado"
            echo "analysis_completed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  An√°lisis completado pero sin mejoras que aplicar"
            echo "analysis_completed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-implement Improvements
        if: steps.analysis.outputs.analysis_completed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ü§ñ Implementando mejoras propuestas autom√°ticamente..."
          python .github/scripts/auto-implement-improvements.py \
            --docs-path . \
            --repos-path .analysis-repos \
            --max-improvements 20 \
            --report AUTO_IMPLEMENTED_REPORT.md
          
          if [ -f "AUTO_IMPLEMENTED_REPORT.md" ]; then
            echo "‚úÖ Mejoras implementadas - AUTO_IMPLEMENTED_REPORT.md generado"
          fi
      
      - name: Reorganize Documentation Structure
        if: steps.analysis.outputs.analysis_completed == 'true' && inputs.reorganize_structure != 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "üìê Reorganizando estructura bas√°ndose en el an√°lisis previo..."
          echo "‚è≥ Esperando 2 segundos para asegurar que el an√°lisis est√° completo..."
          sleep 2
          
          python .github/scripts/reorganize-docs-structure.py \
            --docs-path . \
            --output-changelog STRUCTURE_CHANGELOG.md
          
          if [ -f "STRUCTURE_CHANGELOG.md" ]; then
            echo "‚úÖ Estructura reorganizada - STRUCTURE_CHANGELOG.md generado"
          fi
      
      - name: Fix MDX Syntax Errors
        run: |
          echo "üîß Corrigiendo errores de sintaxis MDX..."
          python .github/scripts/fix-mdx-syntax.py
          
          echo "‚úÖ Sintaxis MDX verificada y corregida"
          
      - name: Create improvement proposals
        run: |
          if [ -f "analysis-results.json" ]; then
            echo "üìã Propuestas de mejora generadas"
            cat analysis-results.json | python -m json.tool || true
          fi
          
      - name: Create PR with improvements
        if: hashFiles('IMPROVEMENTS.md') != ''
        run: |
          git config user.name "claude-ai-bot[bot]"
          git config user.email "claude-ai-bot[bot]@users.noreply.github.com"
          
          BRANCH_NAME="docs/intelligent-improvements-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # A√±adir TODOS los archivos generados y modificados
          git add docs.json IMPROVEMENTS.md STRUCTURE_CHANGELOG.md analysis-results.json 2>/dev/null || true
          git add AUTO_FIXES_REPORT.md BROKEN_LINKS_REPORT.md UNDOCUMENTED_APIS_REPORT.md AUTO_IMPLEMENTED_REPORT.md 2>/dev/null || true
          git add broken-links.json undocumented-apis.json generated-diagrams.json incremental-analysis.json 2>/dev/null || true
          git add .analysis-cache.json 2>/dev/null || true
          # A√±adir TODOS los archivos .mdx (incluyendo los auto-generados en directorios nuevos)
          git add **/*.mdx 2>/dev/null || true
          git add api-reference/ docs/ cicd/ infrastructure/ services/ frontend/ architecture/ database/ monitoring/ security/ data/ observability/ operations/ 2>/dev/null || true
          git add *.mdx 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No hay cambios que commitear"
          else
            git commit -m "docs: Mejoras inteligentes y reorganizaci√≥n estructural [skip-ci]" \
              -m "An√°lisis autom√°tico completo con nuevas capacidades:" \
              -m "- Auto-fix de quick wins aplicados" \
              -m "- Links validados" \
              -m "- APIs analizadas con AST" \
              -m "- Diagramas generados autom√°ticamente" \
              -m "- An√°lisis incremental con cache" \
              -m "- MEJORAS IMPLEMENTADAS AUTOM√ÅTICAMENTE" \
              -m "" \
              -m "Generado autom√°ticamente por Claude Sonnet 4.5"
            
            git push -u origin "$BRANCH_NAME"
            
            gh pr create \
              --title "ü§ñ Mejoras y reorganizaci√≥n autom√°tica ($(date +%Y-%m-%d))" \
              --body "An√°lisis autom√°tico de documentaci√≥n y reorganizaci√≥n estructural. Ver archivos IMPROVEMENTS.md y STRUCTURE_CHANGELOG.md" \
              --label "documentation,enhancement" \
              --base main || echo "‚ö†Ô∏è  No se pudo crear PR autom√°ticamente"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          
      - name: Cleanup
        if: always()
        run: |
          rm -rf .analysis-repos
          echo "‚úÖ Limpieza completada"
