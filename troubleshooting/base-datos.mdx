---
title: 8.5. Resolución de Problemas
description: Guía completa para diagnosticar y resolver problemas comunes en RetroGameCloud,
  organizada por categorías de infraestructura y servicios
icon: wrench
---

# 8.5. Resolución de Problemas

Esta guía proporciona un enfoque sistemático para diagnosticar y resolver los problemas más comunes en RetroGameCloud, organizados por categorías de infraestructura.

<Note>
Antes de comenzar cualquier diagnóstico, asegúrate de tener acceso a kubectl configurado para el cluster EKS y permisos para ver logs y métricas.
</Note>

## Kubernetes y Contenedores

### CrashLoopBackOff

* *Síntomas:**

- Pods reiniciándose constantemente

- Estado `CrashLoopBackOff` en `kubectl get pods`

- Aplicación no disponible

* *Diagnóstico:**

<Tabs>
<Tab title="Verificar Estado">

```bash
kubectl get pods -n retrogame
kubectl describe pod <pod-name> -n retrogame

```

</Tab>
<Tab title="Revisar Logs">

```bash
kubectl logs <pod-name> -n retrogame --previous
kubectl logs <pod-name> -n retrogame -f

```

</Tab>
<Tab title="Eventos del Cluster">

```bash
kubectl get events -n retrogame --sort-by=.metadata.creationTimestamp

```

</Tab>
</Tabs>

* *Soluciones paso a paso:**

1. **Revisar configuración de variables de entorno**
   ```bash
   kubectl describe deployment <deployment-name> -n retrogame
   ```

2. **Verificar ConfigMaps y Secrets**
   ```bash
   kubectl get configmap -n retrogame
   kubectl get secret -n retrogame
   ```

3. **Ajustar recursos si es necesario**
   ```yaml
   resources:
     requests:
       memory: "256Mi"
       cpu: "250m"
     limits:
       memory: "512Mi"
       cpu: "500m"
   ```

4. **Verificar health checks**
   ```yaml
   livenessProbe:
     httpGet:
       path: /health
       port: 8080
     initialDelaySeconds: 30
     periodSeconds: 10
   ```

* *Prevención:**

- Implementar health checks apropiados

- Configurar recursos basados en monitoreo real

- Usar init containers para dependencias

### ImagePullBackOff

* *Síntomas:**

- Pods en estado `ImagePullBackOff`

- Error "Failed to pull image" en eventos

* *Diagnóstico:**

```bash
kubectl describe pod <pod-name> -n retrogame
docker login <registry-url>  # Verificar acceso al registry

```

* *Soluciones:**

1. **Verificar nombre de imagen y tag**
   ```bash
   kubectl get deployment <deployment> -o yaml | grep image
   ```

2. **Actualizar ImagePullSecrets**
   ```bash
   kubectl create secret docker-registry regcred \
     --docker-server=<registry-url> \
     --docker-username=<username> \
     --docker-password=<password>
   ```

3. **Verificar políticas de pull**
   ```yaml
   imagePullPolicy: IfNotPresent  # o Always para latest tags
   ```

### OOMKilled (Out of Memory)

* *Síntomas:**

- Pods terminándose inesperadamente

- Exit code 137 en logs

- Alto uso de memoria en métricas

* *Diagnóstico:**

```bash
kubectl top pods -n retrogame
kubectl describe pod <pod-name> -n retrogame | grep -A 5 "Last State"

```

* *Soluciones:**

1. **Aumentar límites de memoria**
   ```yaml
   resources:
     limits:
       memory: "1Gi"  # Aumentar según necesidad
   ```

2. **Implementar HPA (Horizontal Pod Autoscaler)**
   ```yaml
   apiVersion: autoscaling/v2
   kind: HorizontalPodAutoscaler
   metadata:
     name: app-hpa
   spec:
     scaleTargetRef:
       apiVersion: apps/v1
       kind: Deployment
       name: app-deployment
     minReplicas: 2
     maxReplicas: 10
     metrics:
     - type: Resource
       resource:
         name: memory
         target:
           type: Utilization
           averageUtilization: 70
   ```

### Pods en Estado Pending

* *Síntomas:**

- Pods no programándose en nodos

- Estado `Pending` persistente

* *Diagnóstico:**

```bash
kubectl describe pod <pod-name> -n retrogame
kubectl get nodes
kubectl describe node <node-name>

```

* *Soluciones:**

1. **Verificar recursos disponibles en nodos**
   ```bash
   kubectl top nodes
   ```

2. **Revisar node selectors y taints**
   ```bash
   kubectl get nodes --show-labels
   kubectl describe node <node-name> | grep Taints
   ```

3. **Escalar cluster si es necesario**
   ```bash
   aws eks update-nodegroup-config \
     --cluster-name retrogame-cluster \
     --nodegroup-name worker-nodes \
     --scaling-config minSize=2,maxSize=5,desiredSize=3
   ```

## Servicios y Aplicaciones

### Servicio de Autenticación

* *Síntomas específicos:**

- Error 401/403 en login

- Tokens JWT inválidos

- Problemas de OAuth2 con Kong

* *Diagnóstico:**

<Tabs>
<Tab title="Verificar Servicio">

```bash
kubectl logs deployment/auth-service -n retrogame
curl -k https://api.retrogame.cloud/auth/health

```

</Tab>
<Tab title="Verificar Kong">

```bash
kubectl logs deployment/kong-gateway -n kong
curl -i http://kong-admin:8001/services/auth-service

```

</Tab>
<Tab title="Base de Datos">

```bash
kubectl exec -it deployment/auth-service -n retrogame -- \
  psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c "SELECT COUNT(*) FROM users;"

```

</Tab>
</Tabs>

* *Soluciones:**

1. **Regenerar secretos OAuth2**
   ```bash
   kubectl create secret generic auth-secrets \
     --from-literal=jwt-secret=$(openssl rand -base64 32) \
     --from-literal=oauth2-client-secret=$(openssl rand -base64 32) \
     -n retrogame
   ```

2. **Verificar configuración de Kong**
   ```bash
   curl -X POST http://kong-admin:8001/services/auth-service/plugins \
     --data "name=oauth2" \
     --data "config.enable_client_credentials=true"
   ```

### Servicio de Puntuaciones

* *Síntomas específicos:**

- Puntuaciones no guardándose

- Rankings desactualizados

- Timeouts en escritura

* *Diagnóstico:**

```bash
kubectl logs deployment/score-service -n retrogame --tail=100
kubectl exec -it deployment/redis -n retrogame -- redis-cli ping

```

* *Soluciones:**

1. **Verificar conexión a Redis**
   ```bash
   kubectl exec -it deployment/score-service -n retrogame -- \
     redis-cli -h redis-service -p 6379 ping
   ```

2. **Limpiar cache si es necesario**
   ```bash
   kubectl exec -it deployment/redis -n retrogame -- \
     redis-cli FLUSHDB
   ```

### Servicio de Catálogo

* *Síntomas específicos:**

- Juegos no cargando

- Imágenes no mostrándose

- S3 upload fallando

* *Diagnóstico:**

<Tabs>
<Tab title="Logs del Servicio">

```bash
kubectl logs deployment/catalog-service -n retrogame

```

</Tab>
<Tab title="Verificar S3">

```bash
aws s3 ls s3://retrogame-assets/games/
aws s3api head-bucket --bucket retrogame-assets

```

</Tab>
<Tab title="CloudFront">

```bash
curl -I https://cdn.retrogame.cloud/games/pacman.zip

```

</Tab>
</Tabs>

* *Soluciones:**

1. **Verificar IAM roles para S3**
   ```bash
   kubectl describe serviceaccount catalog-sa -n retrogame
   ```

2. **Sincronizar assets**
   ```bash
   aws s3 sync ./game-assets s3://retrogame-assets/games/ --delete
   ```

## Base de Datos

### PostgreSQL RDS

* *Síntomas:**

- Connection timeout

- Too many connections

- Slow queries

* *Diagnóstico:**

<Tabs>
<Tab title="Verificar Conectividad">

```bash
kubectl run pg-test --rm -it --restart=Never \
  --image=postgres:13 -- \
  psql -h $RDS_ENDPOINT -U $DB_USER -d retrogame

```

</Tab>
<Tab title="Monitoring RDS">

```bash
aws rds describe-db-instances \
  --db-instance-identifier retrogame-db \
  --query 'DBInstances[0].DBInstanceStatus'

```

</Tab>
<Tab title="Connection Pool">

```bash
kubectl logs deployment/auth-service -n retrogame | grep "connection pool"

```

</Tab>
</Tabs>

* *Soluciones:**

1. **Ajustar connection pool**
   ```yaml
   env:
   - name: DB_POOL_SIZE
     value: "20"
   - name: DB_POOL_TIMEOUT
     value: "30"
   ```

2. **Escalar RDS si es necesario**
   ```bash
   aws rds modify-db-instance \
     --db-instance-identifier retrogame-db \
     --db-instance-class db.t3.medium \
     --apply-immediately
   ```

3. **Optimizar queries lentas**
   ```sql
   SELECT query, mean_time, calls
   FROM pg_stat_statements
   ORDER BY mean_time DESC
   LIMIT 10;
   ```

### Redis

* *Síntomas:**

- Cache miss alto

- Redis OOM

- Conexiones rechazadas

* *Diagnóstico:**

```bash
kubectl exec -it deployment/redis -n retrogame -- redis-cli info memory
kubectl exec -it deployment/redis -n retrogame -- redis-cli info clients

```

* *Soluciones:**

1. **Configurar maxmemory policy**
   ```bash
   kubectl exec -it deployment/redis -n retrogame -- \
     redis-cli CONFIG SET maxmemory-policy allkeys-lru
   ```

2. **Monitorear uso**
   ```bash
   kubectl exec -it deployment/redis -n retrogame -- \
     redis-cli --latency-history -i 1
   ```

3. **Escalar Redis**
   ```yaml
   resources:
     requests:
       memory: "512Mi"
     limits:
       memory: "1Gi"
   ```

## Red y Conectividad

### DNS Resolution

* *Síntomas:**

- Name resolution failed

- Service discovery fallando

- Timeouts intermitentes

* *Diagnóstico:**

<Tabs>
<Tab title="DNS Lookup">

```bash
kubectl run dns-test --rm -it --restart=Never \
  --image=busybox -- nslookup auth-service.retrogame.svc.cluster.local

```

</Tab>
<Tab title="CoreDNS Logs">

```bash
kubectl logs -n kube-system -l k8s-app=kube-dns

```

</Tab>
<Tab title="Service Endpoints">

```bash
kubectl get endpoints -n retrogame

```

</Tab>
</Tabs>

* *Soluciones:**

1. **Verificar CoreDNS**
   ```bash
   kubectl get pods -n kube-system -l k8s-app=kube-dns
   kubectl describe configmap coredns -n kube-system
   ```

2. **Recrear servicios si es necesario**
   ```bash
   kubectl delete service auth-service -n retrogame
   kubectl apply -f auth-service.yaml
   ```

### SSL/TLS Issues

* *Síntomas:**

- Certificate errors

- HTTPS redirect loops

- SSL handshake failures

* *Diagnóstico:**

```bash
openssl s_client -connect api.retrogame.cloud:443
curl -vI https://api.retrogame.cloud/health

```

* *Soluciones:**

1. **Verificar certificados**
   ```bash
   kubectl get certificate -n retrogame
   kubectl describe certificate api-tls -n retrogame
   ```

2. **Renovar certificado si es necesario**
   ```bash
   kubectl delete certificate api-tls -n retrogame
   kubectl apply -f tls-certificate.yaml
   ```

### Kong Gateway Issues

* *Síntomas:**

- 502/503 errors

- Rate limiting incorrecto

- Routing problems

* *Diagnóstico:**

<Tabs>
<Tab title="Kong Status">

```bash
kubectl logs deployment/kong-gateway -n kong
curl -i http://kong-admin:8001/status

```

</Tab>
<Tab title="Services Config">

```bash
curl -s http://kong-admin:8001/services | jq
curl -s http://kong-admin:8001/routes | jq

```

</Tab>
<Tab title="Plugins">

```bash
curl -s http://kong-admin:8001/plugins | jq

```

</Tab>
</Tabs>

* *Soluciones:**

1. **Reiniciar Kong con configuración**
   ```bash
   kubectl rollout restart deployment/kong-gateway -n kong
   ```

2. **Verificar upstreams**
   ```bash
   curl -X GET http://kong-admin:8001/upstreams/auth-service/health
   ```

### Network Timeouts

* *Síntomas:**

- Request timeouts

- Connection refused

- Load balancer issues

* *Diagnóstico:**

```bash
kubectl get svc -n retrogame
kubectl describe svc auth-service -n retrogame
telnet auth-service.retrogame.svc.cluster.local 8080

```

* *Soluciones:**

1. **Ajustar timeouts en servicios**
   ```yaml
   annotations:
     nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
     nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
     nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
   ```

2. **Verificar Network Policies**
   ```bash
   kubectl get networkpolicy -n retrogame
   kubectl describe networkpolicy allow-frontend -n retrogame
   ```

<Warning>
Siempre realiza una copia de seguridad antes de aplicar cambios críticos en producción. Usa el entorno de staging para probar soluciones complejas.
</Warning>

## Comandos de Diagnóstico Rápido

Para un diagnóstico inicial rápido, ejecuta estos comandos:

```bash

# Estado general del cluster
kubectl get pods --all-namespaces | grep -v Running

# Recursos más consumidos
kubectl top nodes
kubectl top pods --all-namespaces --sort-by=cpu

# Eventos recientes
kubectl get events --all-namespaces --sort-by=.metadata.creationTimestamp

# Estado de servicios críticos
kubectl get svc -n retrogame
kubectl get ingress -n retrogame

# Verificar conectividad externa
curl -f https://api.retrogame.cloud/health || echo "API no disponible"

```

Este enfoque sistemático te permitirá identificar y resolver rápidamente la mayoría de problemas en RetroGameCloud. Recuerda documentar las soluciones aplic