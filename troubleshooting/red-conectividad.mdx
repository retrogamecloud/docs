---
title: 8.5. Troubleshooting
description: Guía completa para diagnosticar y resolver problemas en RetroGameCloud
icon: wrench
---

# 8.5. Troubleshooting

Esta guía proporciona soluciones sistemáticas para los problemas más comunes en RetroGameCloud, organizados por categoría para facilitar el diagnóstico rápido.

<Note>
Para cada problema, sigue el orden: **Síntomas** → **Diagnóstico** → **Solución** → **Prevención**
</Note>

## Índice de Problemas

<div className="grid grid-cols-2 gap-4">
<Card title="Kubernetes" icon="cloud" href="#kubernetes">
Problemas con pods, deployments y recursos del cluster
</Card>

<Card title="Microservicios" icon="server" href="#microservicios">
Auth, scores, ranking, catalog y user service
</Card>

<Card title="Base de Datos" icon="database" href="#base-de-datos">
RDS PostgreSQL, Redis y connection pools
</Card>

<Card title="Red y Conectividad" icon="network-wired" href="#red-y-conectividad">
DNS, SSL, Kong gateway y timeouts
</Card>
</div>

## Kubernetes

### CrashLoopBackOff

* *Síntomas:**

- Pods que se reinician constantemente

- Estado `CrashLoopBackOff` en `kubectl get pods`

- Aplicación no disponible

* *Diagnóstico:**

<Tabs>
<Tab title="Verificar Estado">

```bash

# Ver estado de pods
kubectl get pods -n retrogame

# Ver eventos del pod
kubectl describe pod <pod-name> -n retrogame

# Ver logs del contenedor
kubectl logs <pod-name> -n retrogame --previous
</Tab>
<Tab title="Verificar Resources">

```bash

# Ver límites de recursos
kubectl describe deployment <deployment-name> -n retrogame

# Ver uso de recursos
kubectl top pods -n retrogame
</Tab>
</Tabs>

* *Solución:**

1. **Error de configuración:**

```bash

# Verificar variables de entorno
kubectl get deployment auth-service -n retrogame -o yaml | grep -A 20 env:

# Corregir ConfigMap
kubectl edit configmap auth-config -n retrogame

```

2. **Problemas de conectividad a BD:**

```bash

# Verificar secrets de BD
kubectl get secret postgres-credentials -n retrogame -o yaml

# Probar conexión desde pod
kubectl exec -it <pod-name> -n retrogame -- nc -zv postgres-service 5432

```

3. **Límites de memoria insuficientes:**

```yaml

# deployment.yaml
resources:
  limits:
    memory: "512Mi"
    cpu: "500m"
  requests:
    memory: "256Mi"
    cpu: "250m"

```

* *Prevención:**

- Implementar health checks adecuados

- Establecer límites de recursos realistas

- Usar liveness y readiness probes

### ImagePullBackOff

* *Síntomas:**

- Pods en estado `ImagePullBackOff`

- Error "Failed to pull image" en eventos

* *Diagnóstico:**

```bash

# Ver detalles del error
kubectl describe pod <pod-name> -n retrogame

# Verificar imagen en ECR
aws ecr describe-images --repository-name retrogame/auth-service

```

* *Solución:**

<Tabs>
<Tab title="Credenciales ECR">

```bash

# Recrear secret de ECR
aws ecr get-login-password --region eu-west-1 | \
kubectl create secret docker-registry ecr-secret \
  --docker-server=<aws-account>.dkr.ecr.eu-west-1.amazonaws.com \
  --docker-username=AWS \
  --docker-password-stdin -n retrogame

# Asociar secret al ServiceAccount
kubectl patch serviceaccount default -n retrogame \
  -p '{"imagePullSecrets": [{"name": "ecr-secret"}]}'
</Tab>
<Tab title="Tag Incorrecto">

```bash

# Verificar tags disponibles
aws ecr list-images --repository-name retrogame/auth-service

# Actualizar deployment
kubectl set image deployment/auth-service \
  auth-service=<aws-account>.dkr.ecr.eu-west-1.amazonaws.com/retrogame/auth-service:latest \
  -n retrogame
</Tab>
</Tabs>

* *Prevención:**

- Automatizar actualización de secrets ECR

- Usar imagePullPolicy: IfNotPresent para tags específicos

- Implementar validación de imágenes en CI/CD

### OOMKilled (Out of Memory)

* *Síntomas:**

- Pods terminados con código 137

- Mensaje "OOMKilled" en eventos

- Aplicación se vuelve lenta antes del reinicio

* *Diagnóstico:**

```bash

# Ver uso de memoria
kubectl top pods -n retrogame --sort-by=memory

# Ver límites configurados
kubectl describe deployment <deployment-name> -n retrogame | grep -A 5 "Limits"

# Ver métricas históricas en Grafana

# Dashboard: Kubernetes / Pods / Memory Usage

```

* *Solución:**

1. **Aumentar límites de memoria:**

```yaml

# k8s/deployment.yaml
resources:
  limits:
    memory: "1Gi"  # Aumentar de 512Mi
  requests:
    memory: "512Mi"

```

2. **Optimizar aplicación:**

```bash

# Para servicios Node.js
NODE_OPTIONS: "--max-old-space-size=768"

# Para servicios Java
JAVA_OPTS: "-Xmx512m -XX:+UseG1GC"

```

* *Prevención:**

- Monitorizar uso de memoria con alertas

- Implementar profiling en desarrollo

- Usar Horizontal Pod Autoscaler (HPA)

### Pods Pending

* *Síntomas:**

- Pods en estado `Pending`

- No se programan en ningún nodo

* *Diagnóstico:**

```bash

# Ver eventos del pod
kubectl describe pod <pod-name> -n retrogame

# Ver recursos disponibles en nodos
kubectl describe nodes | grep -A 5 "Allocated resources"

# Ver taints en nodos
kubectl get nodes -o json | jq '.items[].spec.taints'

```

* *Solución:**

<Tabs>
<Tab title="Recursos Insuficientes">

```bash

# Escalar cluster EKS
aws eks update-nodegroup-config \
  --cluster-name retrogame-cluster \
  --nodegroup-name worker-nodes \
  --scaling-config minSize=2,maxSize=5,desiredSize=3
</Tab>
<Tab title="Node Selector">

```yaml

# Verificar nodeSelector en deployment
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/instance-type: t3.medium  # Asegurar que existe
</Tab>
</Tabs>

* *Prevención:**

- Configurar Cluster Autoscaler

- Monitorizar recursos del cluster

- Usar Pod Disruption Budgets

## Microservicios

### Auth Service

* *Síntomas:**

- Error 401/403 en todas las peticiones

- "Invalid token" o "Token expired"

- Login fallido

* *Diagnóstico:**

<Tabs>
<Tab title="Logs del Servicio">

```bash

# Ver logs de auth-service
kubectl logs -f deployment/auth-service -n retrogame

# Buscar errores específicos
kubectl logs deployment/auth-service -n retrogame | grep -i "error\|jwt\|oauth"
</Tab>
<Tab title="Base de Datos">

```bash

# Verificar conexión a PostgreSQL
kubectl exec -it deployment/auth-service -n retrogame -- \
  psql -h postgres-service -U retrogame_user -d retrogame_db -c "\dt"

# Verificar tablas de usuarios
kubectl exec -it deployment/auth-service -n retrogame -- \
  psql -h postgres-service -U retrogame_user -d retrogame_db -c "SELECT COUNT(*) FROM users;"
</Tab>
</Tabs>

* *Solución:**

1. **JWT Secret incorrecto:**

```bash

# Verificar secret
kubectl get secret jwt-secret -n retrogame -o yaml

# Regenerar si es necesario
kubectl create secret generic jwt-secret \
  --from-literal=jwt-secret=$(openssl rand -base64 32) \
  -n retrogame --dry-run=client -o yaml | kubectl apply -f -

```

2. **Base de datos no disponible:**

```bash

# Verificar servicio PostgreSQL
kubectl get svc postgres-service -n retrogame

# Probar conexión
kubectl run postgres-test --rm -it --restart=Never --image=postgres:13 -- \
  psql -h postgres-service.retrogame.svc.cluster.local -U retrogame_user -d retrogame_db

```

* *Prevención:**

- Implementar health checks específicos

- Usar connection pooling

- Configurar alertas para fallos de autenticación

### Score Service

* *Síntomas:**

- Puntuaciones no se guardan

- Error 500 al obtener rankings

- Datos inconsistentes entre servicios

* *Diagnóstico:**

```bash

# Ver logs específicos de scores
kubectl logs deployment/score-service -n retrogame | grep -i "score\|ranking"

# Verificar comunicación con Redis
kubectl exec -it deployment/score-service -n retrogame -- \
  redis-cli -h redis-service ping

# Verificar datos en Redis
kubectl exec -it deployment/redis -n retrogame -- \
  redis-cli KEYS "scores:*"

```

* *Solución:**

1. **Redis no disponible:**

```bash

# Reiniciar Redis
kubectl rollout restart deployment/redis -n retrogame

# Verificar configuración
kubectl get configmap redis-config -n retrogame -o yaml

```

2. **Corrupción de datos:**

```bash

# Limpiar datos corruptos
kubectl exec -it deployment/redis -n retrogame -- \
  redis-cli FLUSHDB

# Recargar datos desde PostgreSQL
kubectl exec -it deployment/score-service -n retrogame -- \
  curl -X POST http://localhost:3000/admin/rebuild-cache

```

* *Prevención:**

- Implementar backup automático de Redis

- Usar persistencia en Redis

- Validar datos antes de guardar

### Ranking Service

* *Síntomas:**

- Rankings desactualizados

- Error de timeout en consultas

- Inconsistencias en posiciones

* *Diagnóstico:**

```bash

# Ver performance de consultas
kubectl logs deployment/ranking-service -n retrogame | grep -i "slow\|timeout"

# Verificar índices en PostgreSQL
kubectl exec -it postgres-0 -n retrogame -- \
  psql -U retrogame_user -d retrogame_db -c "SELECT * FROM pg_stat_user_indexes;"

```

* *Solución:**

1. **Optimizar consultas:**

```sql

- - Crear índices necesarios
CREATE INDEX CONCURRENTLY idx_scores_game_user ON scores(game_id, user_id);
CREATE INDEX CONCURRENTLY idx_scores_created_at ON scores(created_at DESC);

```

2. **Aumentar timeout:**

```yaml

# En ConfigMap
QUERY_TIMEOUT: "30000"  # 30 segundos
CONNECTION_POOL_SIZE: "20"

```

* *Prevención:**

- Monitorizar performance de queries

- Implementar cache de rankings

- Usar paginación en consultas grandes

## Base de Datos

### PostgreSQL (RDS)

* *Síntomas:**

- Connection timeout errors

- "Too many connections"

- Queries lentas o bloqueadas

* *Diagnóstico:**

<Tabs>
<Tab title="Conexiones">

```sql

- - Ver conexiones activas
SELECT count(*) FROM pg_stat_activity;
SELECT state, count(*) FROM pg_stat_activity GROUP BY state;

- - Ver conexiones por aplicación
SELECT application_name, count(*)
FROM pg_stat_activity
WHERE state = 'active'
GROUP BY application_name;
</Tab>
<Tab title="Performance">

```sql

- - Ver queries más lentas
SELECT query, mean_time, calls
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

- - Ver locks activos
SELECT * FROM pg_locks WHERE NOT GRANTED;
</Tab>
</Tabs>

* *Solución:**

1. **Demasiadas conexiones:**

```bash

# Aumentar connection pool en aplicación
kubectl patch configmap app-config -n retrogame --patch '
data:
  DB_POOL_SIZE: "10"
  DB_POOL_MAX: "20"
'

# Reiniciar deployments
kubectl rollout restart deployment/auth-service -n retrogame

```

2. **Queries lentas:**

```sql

- - Crear índices faltantes
CREATE INDEX CONCURRENTLY idx_users_email ON users(email);
CREATE INDEX CONCURRENTLY idx_games_category ON games(category);

- - Actualizar estadísticas
ANALYZE;

```

3. **Configurar PgBouncer:**

```yaml

# pgbouncer-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
data:
  pgbouncer.ini: |
    [databases]
    retrogame_db = host=postgres-service port=5432 dbname=retrogame_db

    [pgbouncer]
    pool_mode = transaction
    max_client_conn = 100
    default_pool_size = 20

```

* *Prevención:**

- Monitorizar métricas de RDS en CloudWatch

- Configurar alertas para conexiones altas

- Implementar connection pooling adecuado

### Redis

* *Síntomas:**

- Cache miss alto

- Timeouts en operaciones Redis

- Memoria Redis agotada

* *Diagnóstico:**

```bash

# Ver info de Redis
kubectl exec -it deployment/redis -n retrogame -- \
  redis-cli INFO memory

# Ver estadísticas de comandos
kubectl exec -it deployment/redis -n retrogame -- \
  redis-cli INFO commandstats

# Ver keys con mayor uso de memoria
kubectl exec -it deployment/redis -n retrogame -- \
  redis-cli --bigkeys

```

* *Solución:**

<Tabs>
<Tab title="Memoria Insuficiente">

```bash

# Aumentar memoria límite
kubectl patch deployment redis -n retrogame --patch '
spec:
  template:
    spec:
      containers:
      - name: redis
        resources:
          limits:
            memory: "1Gi"
          requests:
            memory: "512Mi"
'

# Configurar eviction policy
kubectl exec -it deployment/redis -n retrogame -- \
  redis-cli CONFIG SET maxmemory-policy allkeys-lru
</Tab>
<Tab title="Performance">

```bash

# Optimizar configuración
kubectl create configmap redis-config --from-literal=redis.conf="
maxmemory 512mb
maxmemory-policy allkeys-lru
tcp-keepalive 60
timeout 300
" -n retrogame --dry-run=client -o yaml | kubectl apply -f -
</Tab>
</Tabs>

* *Prevención:**

- Implementar TTL en todas las keys

- Monitorizar uso de memoria

- Configurar backup/restore automático

## Red y Conectividad

### DNS Resolution

* *Síntomas:**

- "Name or service not known"

- Timeouts intermitentes entre servicios

- Service discovery failures

* *Diagnóstico:**

```bash

# Probar resolución DNS desde pod
kubectl exec -it deployment/auth-service -n retrogame -- \
  nslookup postgres-service.retrogame.svc.cluster.local

```