---
title: 3.4. Servicio de Puntuaciones
description: Gesti√≥n de puntuaciones y logros de jugadores con sistema de rankings
  en tiempo real
icon: trophy
---

## Descripci√≥n

El servicio de puntuaciones permite a los jugadores guardar y actualizar sus mejores scores en cada juego. Solo guarda el score m√°s alto por usuario y juego, proporcionando un sistema de rankings y logros personalizado con invalidaci√≥n inteligente de cache.

<CardGroup cols={3}>
  <Card title="JWT Protected" icon="lock">
    Autenticaci√≥n requerida

    Solo usuarios autenticados
  </Card>

  <Card title="Best Score Only" icon="star">
    Solo el mejor

    Actualiza si supera el anterior
  </Card>

  <Card title="Real-time" icon="bolt">
    Guardado instant√°neo

    Sin delay
  </Card>
</CardGroup>

## Arquitectura del Servicio

| Caracter√≠stica | Detalle |
|---|---|
| **Puerto** | 5003 |
| **Base de Datos** | PostgreSQL (scores) |
| **Dependencias** | Auth Service, Games Service |
| **Cache** | Redis para rankings |

## Flujo de Actualizaci√≥n de Puntuaciones

El proceso de submit score involucra m√∫ltiples servicios y capas de cache para mantener rankings actualizados:

```mermaid
sequenceDiagram
    participant Client
    participant ScoreAPI as Score Service
    participant DB as PostgreSQL
    participant Cache as Redis Cache
    participant Rankings as Ranking Engine

    Client->>ScoreAPI: POST /api/scores
    ScoreAPI->>DB: Verificar score actual

    alt Score es mejor
        ScoreAPI->>DB: UPDATE score
        ScoreAPI->>Cache: INVALIDATE user_scores:{userId}
        ScoreAPI->>Cache: INVALIDATE game_leaderboard:{gameId}
        ScoreAPI->>Rankings: Recalcular posici√≥n
        Rankings->>Cache: SET new_rankings
        ScoreAPI->>Client: Score actualizado
    else Score no es mejor
        ScoreAPI->>Client: Score no actualizado
    end

```

## Caracter√≠sticas Principales

### üéØ Gesti√≥n de Puntuaciones

- Almacenamiento del mejor score por usuario/juego
- Validaci√≥n autom√°tica contra records anteriores
- Sistema de rankings din√°mico
- Cache inteligente para optimizar consultas

### üèÜ Sistema de Leaderboards

- Rankings globales por juego
- Posiciones calculadas en tiempo real
- Cache de rankings para respuesta r√°pida
- Invalidaci√≥n autom√°tica al actualizar scores

### ‚ö° Optimizaciones de Rendimiento

- Cache distribuido con Redis
- Queries optimizadas con √≠ndices compuestos
- Invalidaci√≥n selectiva de cache
- Paginaci√≥n eficiente en rankings

## Problemas Comunes

### üö® Cache Desactualizado

**Problema:** Los rankings no reflejan scores recientes

**S√≠ntomas:**
```bash
# Usuario reporta score no visible en leaderboard
curl -H "Authorization: Bearer $TOKEN" /api/leaderboard/game123
# Respuesta muestra datos obsoletos
```

**Logs a revisar:**
```bash
# Buscar errores de invalidaci√≥n de cache
docker logs score-service | grep "Cache invalidation failed"
docker logs redis | grep "COMMAND FAILED"
```

**Soluci√≥n r√°pida:**
```bash
# Limpiar cache manualmente
redis-cli DEL "game_leaderboard:*"
redis-cli DEL "user_scores:*"

# Reiniciar servicio si persiste
docker restart score-service
```

### üîÑ Scores Duplicados

**Problema:** M√∫ltiples entries del mismo usuario/juego

**S√≠ntomas:**
```sql
-- Verificar duplicados
SELECT user_id, game_id, COUNT(*) 
FROM scores 
GROUP BY user_id, game_id 
HAVING COUNT(*) > 1;
```

**Logs relevantes:**
```bash
# Buscar race conditions
docker logs score-service | grep "Constraint violation"
docker logs score-service | grep "Transaction conflict"
```

**Soluci√≥n:**
```sql
-- Limpiar duplicados manteniendo el mejor score
WITH ranked_scores AS (
  SELECT *, ROW_NUMBER() OVER (
    PARTITION BY user_id, game_id 
    ORDER BY score DESC, created_at DESC
  ) as rn
  FROM scores
)
DELETE FROM scores 
WHERE id IN (
  SELECT id FROM ranked_scores WHERE rn > 1
);
```

### üêå Rankings Lentos

**Problema:** Leaderboards tardan en cargar

**S√≠ntomas:**
```bash
# Timeout en consultas de ranking
curl -w "%{time_total}" /api/leaderboard/popular-game
# > 5 segundos de respuesta
```

**Logs a reviever:**
```bash
# Queries lentas
docker logs score-service | grep "Query took"
docker logs postgresql | grep "slow query"
```

**Soluci√≥n inmediata:**
```sql
-- Verificar √≠ndices
EXPLAIN ANALYZE SELECT * FROM scores 
WHERE game_id = 'game123' 
ORDER BY score DESC LIMIT 100;

-- Recrear √≠ndices si es necesario
REINDEX INDEX idx_scores_game_score;
```

### üîê Errores de Autenticaci√≥n

**Problema:** Scores no se guardan por token inv√°lido

**S√≠ntomas:**
```bash
# Error 401 al enviar score
POST /api/scores
Authorization: Bearer expired_token
# Response: {"error": "Token expired"}
```

**Logs t√≠picos:**
```bash
docker logs score-service | grep "JWT verification failed"
docker logs score-service | grep "Invalid token"
```

**Soluci√≥n:**
```bash
# Verificar conectividad con auth service
curl http://auth-service:5001/health

# Revisar configuraci√≥n JWT
docker exec score-service env | grep JWT
```

### üìä Inconsistencias en Rankings

**Problema:** Posiciones incorrectas en leaderboard

**S√≠ntomas:**
```bash
# Usuario con score alto aparece en posici√≥n baja
GET /api/leaderboard/game123
# Usuario con 10000 puntos en posici√≥n 50
```

**Soluci√≥n de emergencia:**
```bash
# Forzar rec√°lculo de rankings
curl -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
  /api/admin/recalculate-rankings/game123

# O via base de datos
docker exec -it postgresql psql -d gamedb -c \
  "SELECT user_id, score, 
   ROW_NUMBER() OVER (ORDER BY score DESC) as position 
   FROM scores WHERE game_id = 'game123';"
```

## API Endpoints

### POST /api/scores
Enviar nuevo score

### GET /api/leaderboard/:gameId
Obtener ranking de un juego

### GET /api/user-scores/:userId
Obtener scores de un usuario

### POST /api/admin/recalculate-rankings/:gameId
Recalcular rankings (admin only)