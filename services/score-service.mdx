---
title: 3.4. Servicio de Puntuaciones
description: Gesti√≥n de puntuaciones y logros de jugadores con sistema de rankings en tiempo real
icon: trophy
---

## Descripci√≥n

El servicio de puntuaciones permite a los jugadores guardar y actualizar sus mejores scores en cada juego. Solo guarda el score m√°s alto por usuario y juego, proporcionando un sistema de rankings y logros personalizado con invalidaci√≥n inteligente de cache.

<CardGroup cols={3}>
  <Card title="JWT Protected" icon="lock">
    Autenticaci√≥n requerida

    Solo usuarios autenticados
  </Card>

  <Card title="Best Score Only" icon="star">
    Solo el mejor

    Actualiza si supera el anterior
  </Card>

  <Card title="Real-time" icon="bolt">
    Guardado instant√°neo

    Sin delay
  </Card>
</CardGroup>

## Arquitectura del Servicio

| Caracter√≠stica | Detalle |
|---|---|
| **Puerto** | 5003 |
| **Base de Datos** | PostgreSQL (scores) |
| **Dependencias** | Auth Service, Games Service |
| **Cache** | Redis para rankings |

## Flujo de Actualizaci√≥n de Puntuaciones

El proceso de submit score involucra m√∫ltiples servicios y capas de cache para mantener rankings actualizados:

```mermaid
sequenceDiagram
    participant Client
    participant ScoreAPI as Score Service
    participant DB as PostgreSQL
    participant Cache as Redis Cache
    participant Rankings as Ranking Engine

    Client->>ScoreAPI: POST /api/scores
    ScoreAPI->>DB: Verificar score actual
    
    alt Score es mejor
        ScoreAPI->>DB: UPDATE score
        ScoreAPI->>Cache: INVALIDATE user_scores:{userId}
        ScoreAPI->>Cache: INVALIDATE game_leaderboard:{gameId}
        ScoreAPI->>Rankings: Recalcular posici√≥n
        Rankings->>Cache: SET new_rankings
        ScoreAPI->>Client: Score actualizado
    else Score no es mejor
        ScoreAPI->>Client: Score no actualizado
    end
```

## Caracter√≠sticas Principales

### üéØ Gesti√≥n de Puntuaciones

- Almacenamiento del mejor score por usuario/juego
- Validaci√≥n autom√°tica contra scores existentes
- Historial de mejoras de puntuaciones

### üèÜ Sistema de Rankings

- Rankings globales por juego
- Comparativas entre usuarios
- Estad√≠sticas de rendimiento

### üìä Analytics de Jugador

- Progress tracking individual
- M√©tricas de mejora
- Logros desbloqueados

### ‚ö° Cache Inteligente

- Invalidaci√≥n selectiva por usuario y juego
- Rankings precalculados en Redis
- TTL autom√°tico para rankings globales

## Estrategia de Cache

<CardGroup cols={2}>
  <Card title="User Scores Cache" icon="user">
    **Key Pattern:** `user_scores:{userId}`

    **TTL:** 1 hora

    **Invalidaci√≥n:** Al actualizar score
  </Card>

  <Card title="Game Leaderboards" icon="trophy">
    **Key Pattern:** `game_leaderboard:{gameId}`

    **TTL:** 15 minutos

    **Invalidaci√≥n:** Al cambiar top rankings
  </Card>
</CardGroup>

## Endpoints

El servicio expone los siguientes endpoints principales:

<CardGroup cols={2}>
  <Card title="Guardar Puntuaci√≥n" icon="save" href="/api-reference/scores/save-score">
    `POST /api/scores`

    Guarda o actualiza la puntuaci√≥n de un jugador
  </Card>

  <Card title="Scores de Usuario" icon="user" href="/api-reference/scores/get-user-scores">
    `GET /api/scores/user/:userId`

    Obtiene todas las puntuaciones de un usuario
  </Card>

  <Card title="Ranking Global" icon="trophy" href="/api-reference/scores/get-leaderboard">
    `GET /api/scores/leaderboard/:game`

    Rankings globales por juego
  </Card>

  <Card title="Comparar Scores" icon="balance-scale" href="/api-reference/scores/compare-scores">
    `GET /api/scores/compare`

    Compara puntuaciones entre usuarios
  </Card>
</CardGroup>

## Proceso de Invalidaci√≥n de Cache

### Triggers de Invalidaci√≥n

<Steps>
  <Step title="Submit de Nueva Puntuaci√≥n">
    Cuando un usuario env√≠a un score, se verifica si supera su mejor marca actual
  </Step>

  <Step title="Validaci√≥n de Mejora">
    Si el nuevo score es mejor, se actualiza la base de datos PostgreSQL
  </Step>

  <Step title="Cache de Usuario">
    Se invalida `user_scores:{userId}` para refrescar las puntuaciones personales
  </Step>

  <Step title="Cache de Leaderboard">
    Se invalida `game_leaderboard:{gameId}` si el score afecta el top ranking
  </Step>

  <Step title="Rec√°lculo de Posiciones">
    El ranking engine recalcula las posiciones y actualiza el cache con nuevos datos
  </Step>
</Steps>

### Optimizaciones de Performance

- **Lazy Loading:** Rankings se recalculan solo cuando son solicitados
- **Batch Updates:** M√∫ltiples scores se procesan en lotes durante picos de tr√°fico
- **Conditional Invalidation:** Solo se invalidan caches que realmente se ven afectados

## Consideraciones de Escalabilidad

<Warning>
Durante eventos con alto volumen de submits (torneos), el sistema implementa:

- **Queue System:** Redis Bull para procesar scores en background
- **Rate Limiting:** M√°ximo 10 submits por minuto por usuario
- **Partial Cache Updates:** Solo se actualizan posiciones relevantes en rankings
</Warning>

## Monitoreo

El servicio incluye m√©tricas espec√≠ficas para:

- Cache hit ratio por tipo de consulta
- Tiempo de invalidaci√≥n de rankings
- Frecuencia de actualizaciones de score por juego
- Latencia de rec√°lculos de posiciones