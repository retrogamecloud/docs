---
title: "8.11. Servicio de Rankings"
description: "Leaderboards y clasificaciones globales"
icon: "ranking-star"
---

## Descripci√≥n

El servicio de rankings proporciona tablas de clasificaci√≥n (leaderboards) para cada juego, mostrando los mejores jugadores y sus puntuaciones.

<CardGroup cols={3}>
  <Card title="Top 10" icon="medal">
    Los mejores jugadores
    
    Por cada juego
  </Card>
  
  <Card title="Real-time" icon="bolt">
    Actualizaci√≥n inmediata
    
    Al guardar scores
  </Card>
  
  <Card title="Cache Opcional" icon="database">
    Redis para performance
    
    Reducir carga en PostgreSQL
  </Card>
</CardGroup>

## Endpoints

### GET /api/rankings/games/:gameSlug

Obtiene el ranking (top 10) de un juego espec√≠fico.

<CodeGroup>
```bash Request
curl http://api.retrogamecloud.com/api/rankings/games/doom
```

```json Response 200
[
  {
    "rank": 1,
    "username": "doomguy",
    "score": 350000,
    "created_at": "2025-11-18T14:20:00.000Z"
  },
  {
    "rank": 2,
    "username": "player1",
    "score": 285000,
    "created_at": "2025-11-17T10:15:00.000Z"
  },
  {
    "rank": 3,
    "username": "fps_master",
    "score": 250000,
    "created_at": "2025-11-16T18:30:00.000Z"
  },
  {
    "rank": 4,
    "username": "retrogamer",
    "score": 220000,
    "created_at": "2025-11-15T12:00:00.000Z"
  },
  {
    "rank": 5,
    "username": "shooter_pro",
    "score": 195000,
    "created_at": "2025-11-14T09:45:00.000Z"
  }
  // ... hasta top 10
]
```

```json Error 404
{
  "error": "Juego no encontrado"
}
```
</CodeGroup>

**Caracter√≠sticas:**
- Ordena por score descendente
- Solo muestra top 10
- Incluye username y fecha del score
- El campo `rank` se calcula autom√°ticamente (1, 2, 3...)

### GET /api/rankings/global

Obtiene el ranking global (mejores jugadores entre todos los juegos).

<CodeGroup>
```bash Request
curl http://api.retrogamecloud.com/api/rankings/global?limit=20
```

```json Response 200
[
  {
    "rank": 1,
    "username": "master_gamer",
    "total_score": 2850000,
    "games_played": 10,
    "avg_score": 285000
  },
  {
    "rank": 2,
    "username": "retro_king",
    "total_score": 2650000,
    "games_played": 10,
    "avg_score": 265000
  },
  {
    "rank": 3,
    "username": "arcade_legend",
    "total_score": 2400000,
    "games_played": 9,
    "avg_score": 266667
  }
  // ...
]
```
</CodeGroup>

**Query params:**
- `limit` (opcional): N√∫mero de jugadores a mostrar (default: 10, max: 100)

### GET /api/rankings/user/:username

Obtiene la posici√≥n de un usuario espec√≠fico en todos los juegos.

<CodeGroup>
```bash Request
curl http://api.retrogamecloud.com/api/rankings/user/player1
```

```json Response 200
{
  "username": "player1",
  "rankings": [
    {
      "game": "DOOM",
      "game_slug": "doom",
      "score": 285000,
      "rank": 2,
      "total_players": 156
    },
    {
      "game": "Duke Nukem 3D",
      "game_slug": "duke3d",
      "score": 150000,
      "rank": 5,
      "total_players": 89
    },
    {
      "game": "Tetris",
      "game_slug": "tetris",
      "score": 50000,
      "rank": 12,
      "total_players": 203
    }
  ],
  "global_rank": 8,
  "total_score": 485000
}
```
</CodeGroup>

## SQL Queries

### Query para Ranking por Juego

```sql
-- Top 10 de un juego espec√≠fico
SELECT 
  ROW_NUMBER() OVER (ORDER BY s.score DESC) as rank,
  u.username,
  s.score,
  s.created_at
FROM scores s
JOIN users u ON s.user_id = u.id
JOIN games g ON s.game_id = g.id
WHERE g.slug = $1
  AND u.is_active = true
ORDER BY s.score DESC
LIMIT 10;
```

### Query para Ranking Global

```sql
-- Top jugadores globales
SELECT 
  ROW_NUMBER() OVER (ORDER BY SUM(s.score) DESC) as rank,
  u.username,
  SUM(s.score) as total_score,
  COUNT(DISTINCT s.game_id) as games_played,
  AVG(s.score)::INTEGER as avg_score
FROM scores s
JOIN users u ON s.user_id = u.id
WHERE u.is_active = true
GROUP BY u.id, u.username
ORDER BY total_score DESC
LIMIT $1;
```

### Query para Posici√≥n de Usuario

```sql
-- Ranking de un usuario espec√≠fico
WITH user_ranks AS (
  SELECT 
    g.name as game_name,
    g.slug as game_slug,
    s.score,
    ROW_NUMBER() OVER (PARTITION BY g.id ORDER BY s.score DESC) as rank,
    COUNT(*) OVER (PARTITION BY g.id) as total_players
  FROM scores s
  JOIN games g ON s.game_id = g.id
  JOIN users u ON s.user_id = u.id
  WHERE u.username = $1
    AND u.is_active = true
)
SELECT * FROM user_ranks
ORDER BY score DESC;
```

## Cache con Redis

Para mejorar performance en rankings muy consultados.

### Configuraci√≥n

```javascript
import Redis from 'redis';

const redis = Redis.createClient({
  url: process.env.REDIS_URL || 'redis://redis:6379'
});

await redis.connect();

// Cache TTL: 1 minuto
const CACHE_TTL = 60;
```

### Implementaci√≥n con Cache

```javascript
async function obtenerRankingPorJuego(gameSlug) {
  const cacheKey = `ranking:${gameSlug}`;
  
  // Intentar leer de cache
  const cached = await redis.get(cacheKey);
  if (cached) {
    console.log('‚úÖ Ranking desde cache');
    return JSON.parse(cached);
  }
  
  // No est√° en cache ‚Üí consultar DB
  const query = `
    SELECT 
      ROW_NUMBER() OVER (ORDER BY s.score DESC) as rank,
      u.username,
      s.score,
      s.created_at
    FROM scores s
    JOIN users u ON s.user_id = u.id
    JOIN games g ON s.game_id = g.id
    WHERE g.slug = $1
    ORDER BY s.score DESC
    LIMIT 10
  `;
  
  const { rows } = await pool.query(query, [gameSlug]);
  
  // Guardar en cache
  await redis.setEx(cacheKey, CACHE_TTL, JSON.stringify(rows));
  console.log('üíæ Ranking guardado en cache');
  
  return rows;
}
```

### Invalidaci√≥n de Cache

Cuando se guarda un nuevo score, invalidar el cache del juego:

```javascript
async function invalidarCacheRanking(gameSlug) {
  const cacheKey = `ranking:${gameSlug}`;
  await redis.del(cacheKey);
  console.log(`üóëÔ∏è Cache invalidado para: ${gameSlug}`);
}

// Llamar despu√©s de guardar score
await guardarPuntuacion(userId, gameSlug, score);
await invalidarCacheRanking(gameSlug);
```

## Integraci√≥n con Frontend

### Mostrar Ranking en UI

```javascript
// Cargar ranking al seleccionar un juego
async function loadRanking(gameSlug) {
  try {
    const response = await fetch(`http://api.retrogamecloud.com/api/rankings/games/${gameSlug}`);
    const ranking = await response.json();
    
    displayRanking(ranking);
  } catch (error) {
    console.error('Error cargando ranking:', error);
  }
}

function displayRanking(ranking) {
  const container = document.getElementById('ranking-table');
  
  const html = `
    <table class="ranking-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Player</th>
          <th>Score</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        ${ranking.map(entry => `
          <tr class="rank-${entry.rank}">
            <td class="rank">${entry.rank}</td>
            <td class="username">${entry.username}</td>
            <td class="score">${entry.score.toLocaleString()}</td>
            <td class="date">${new Date(entry.created_at).toLocaleDateString()}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  container.innerHTML = html;
}
```

### CSS para Rankings

```css
.ranking-table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Press Start 2P', monospace;
}

.rank-1 { background: gold; }
.rank-2 { background: silver; }
.rank-3 { background: #cd7f32; }

.ranking-table td {
  padding: 10px;
  text-align: center;
}

.score {
  font-weight: bold;
  color: #00ff00;
}
```

## Variables de Entorno

```bash
# Puerto del servicio
PORT=3004

# Base de datos
DATABASE_URL=postgresql://postgres:password@postgres:5432/retrogamedb

# Redis (opcional)
REDIS_URL=redis://redis:6379
ENABLE_CACHE=true
CACHE_TTL=60

# Logs
LOG_LEVEL=info
```

## Performance

### Sin Cache

<Table>
  <thead>
    <tr>
      <th>M√©trica</th>
      <th>Valor</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Latencia promedio</td>
      <td>~80ms</td>
    </tr>
    <tr>
      <td>P95 latencia</td>
      <td>~150ms</td>
    </tr>
    <tr>
      <td>Queries/segundo</td>
      <td>~500</td>
    </tr>
  </tbody>
</Table>

### Con Redis Cache

<Table>
  <thead>
    <tr>
      <th>M√©trica</th>
      <th>Valor</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Latencia promedio</td>
      <td>~5ms</td>
    </tr>
    <tr>
      <td>P95 latencia</td>
      <td>~15ms</td>
    </tr>
    <tr>
      <td>Queries/segundo</td>
      <td>~5000</td>
    </tr>
    <tr>
      <td>Cache hit rate</td>
      <td>~95%</td>
    </tr>
  </tbody>
</Table>

**Mejora**: 16x m√°s r√°pido con cache ‚ú®

## M√©tricas Prometheus

```javascript
const rankingRequests = new promClient.Counter({
  name: 'ranking_requests_total',
  help: 'Total de requests a rankings',
  labelNames: ['game', 'cache_status']
});

const rankingLatency = new promClient.Histogram({
  name: 'ranking_request_duration_seconds',
  help: 'Latencia de requests de ranking',
  labelNames: ['game', 'cache_status']
});

// Uso
const start = Date.now();
const ranking = await obtenerRankingPorJuego(gameSlug);
const duration = (Date.now() - start) / 1000;

rankingRequests.labels(gameSlug, 'hit').inc();
rankingLatency.labels(gameSlug, 'hit').observe(duration);
```

## Pr√≥ximos Pasos

<CardGroup cols={2}>
  <Card title="Score Service" icon="trophy" href="/services/score-service">
    Sistema de puntuaciones
  </Card>
  
  <Card title="User Service" icon="user" href="/services/user-service">
    Gesti√≥n de usuarios
  </Card>
  
  <Card title="Frontend" icon="window" href="/frontend/overview">
    Interfaz de usuario
  </Card>
  
  <Card title="Monitoring" icon="chart-line" href="/infrastructure/monitoring">
    M√©tricas y dashboards
  </Card>
</CardGroup>
