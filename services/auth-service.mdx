---
title: 3.1. Servicio de Autenticación
description: Servicio de autenticación con JWT y gestión de usuarios
icon: lock
---

## Descripción

El servicio de autenticación maneja el registro, login y validación de usuarios mediante JSON Web Tokens (JWT). Es el punto de entrada para todos los usuarios de la plataforma y el guardián de seguridad que protege el acceso a los demás microservicios.

<CardGroup cols={3}>
  <Card title="Registro" icon="user-plus">
    Crear nuevas cuentas con username único requerido
  </Card>

  <Card title="Login" icon="right-to-bracket">
    Autenticación JWT con token válido por 24h
  </Card>

  <Card title="Validación" icon="shield-check">
    Middleware protector que verifica tokens en cada request
  </Card>
</CardGroup>

## Arquitectura del Servicio

```mermaid
graph TD
    A[Frontend] -->|POST /auth/register<br/>POST /auth/login<br/>GET /auth/verify| B[Kong API Gateway]
    B -->|Route: /auth/*| C[Auth Service :3001]
    C --> D[Controllers<br/>register/login/verify]
    D --> E[Services<br/>hashPass/genToken/validate]
    E --> F[Repositories<br/>create/findUser/update]
    F --> G[PostgreSQL<br/>Table: users]
```

## Configuración del Servicio

<AccordionGroup>
  <Accordion title="Variables de Entorno">
    ```env
    PORT=3001
    DATABASE_URL=postgresql://user:password@postgres:5432/auth_db
    JWT_SECRET=your-super-secret-jwt-key
    JWT_EXPIRES_IN=24h
    BCRYPT_SALT_ROUNDS=10
    NODE_ENV=production
    ```
  </Accordion>

  <Accordion title="Dockerfile">
    ```dockerfile
    FROM node:20-alpine
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production
    COPY . .
    EXPOSE 3001
    CMD ["npm", "start"]
    ```
  </Accordion>
</AccordionGroup>

## Tecnologías

| Tecnología | Versión | Propósito |
|------------|---------|-----------|
| **Node.js** | 20 LTS | Runtime de JavaScript |
| **Express** | ^4.18 | Framework web |
| **jsonwebtoken** | ^9.0 | Generación y validación de JWT |
| **bcrypt** | ^5.1 | Hash de contraseñas (salt rounds: 10) |
| **pg** | ^8.11 | Cliente PostgreSQL |
| **Jest** | ^29.7 | Testing framework |
| **Helmet** | ^7.1 | Seguridad HTTP headers |

## Modelo de Datos

### Tabla: users

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  display_name VARCHAR(100),
  password_hash VARCHAR(255) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
```

## Endpoints

El servicio de autenticación expone los siguientes endpoints principales:

<CardGroup cols={2}>
  <Card title="POST /auth/register" icon="user-plus" href="/api-reference/auth-service/register">
    Registro de nuevos usuarios con validación de datos
  </Card>

  <Card title="POST /auth/login" icon="right-to-bracket" href="/api-reference/auth-service/login">
    Autenticación y generación de tokens JWT
  </Card>

  <Card title="GET /auth/verify" icon="shield-check" href="/api-reference/auth-service/verify">
    Validación de tokens y información del usuario
  </Card>

  <Card title="POST /auth/refresh" icon="arrow-rotate-right" href="/api-reference/auth-service/refresh">
    Renovación de tokens expirados
  </Card>

  <Card title="POST /auth/logout" icon="right-from-bracket" href="/api-reference/auth-service/logout">
    Invalidación de tokens (logout seguro)
  </Card>

  <Card title="GET /auth/health" icon="heart-pulse" href="/api-reference/auth-service/health">
    Health check del servicio
  </Card>
</CardGroup>

<Note>
  Para detalles completos de cada endpoint, incluyendo parámetros, respuestas y ejemplos de código, consulta la [referencia completa de la API](/api-reference/auth-service).
</Note>

## Flujos de Autenticación

### Flujo de Registro

```mermaid
sequenceDiagram
    participant C as Client
    participant A as Auth Service
    participant DB as PostgreSQL

    C->>A: POST /auth/register
    A->>A: Validate input data
    A->>DB: Check if username/email exists
    DB-->>A: User existence result
    A->>A: Hash password (bcrypt)
    A->>DB: INSERT new user
    DB-->>A: User created successfully
    A->>A: Generate JWT token
    A-->>C: 201 Created + JWT token
```

### Flujo de Login

```mermaid
sequenceDiagram
    participant C as Client
    participant A as Auth Service
    participant DB as PostgreSQL

    C->>A: POST /auth/login
    A->>DB: SELECT user by username
    DB-->>A: User data
    A->>A: Compare password (bcrypt)
    A->>A: Generate JWT token
    A->>DB: UPDATE last_login
    A-->>C: 200 OK + JWT token
```

## Seguridad

<Warning>
  **Consideraciones de Seguridad Críticas:**
  - Todas las contraseñas se hashean con bcrypt (salt rounds: 10)
  - Los tokens JWT incluyen expiración obligatoria (24h)
  - Validación estricta de inputs para prevenir inyección SQL
  - Rate limiting implementado para prevenir ataques de fuerza bruta
</Warning>

### Middleware de Protección

```javascript
// Ejemplo de uso del middleware de autenticación
const authMiddleware = require('./middleware/auth');

// Proteger rutas que requieren autenticación
app.use('/games', authMiddleware.verifyToken);
app.use('/save-states', authMiddleware.verifyToken);
```

## Métricas y Monitoreo

| Métrica | Descripción | Umbral de Alerta |
|---------|-------------|------------------|
| **Response Time** | Tiempo promedio de respuesta | > 500ms |
| **Success Rate** | % de requests exitosos | < 95% |
| **Active Users** | Usuarios con sesión válida | - |
| **Failed Logins** | Intentos fallidos por minuto | > 100/min |

## Testing

El servicio incluye pruebas exhaustivas:

- **Unit Tests**: Lógica de negocio y utilidades
- **Integration Tests**: Endpoints y base de datos
- **Security Tests**: Validación de tokens y ataques comunes

```bash
# Ejecutar tests
npm test                    # Todos los tests
npm run test:unit          # Solo unit tests
npm run test:integration   # Solo integration tests
npm run test:coverage      # Con coverage report
```

## Enlaces Relacionados

<CardGroup cols={2}>
  <Card title="API Reference" icon="code" href="/api-reference/auth-service">
    Documentación técnica completa de endpoints
  </Card>

  <Card title="Overview de Servicios" icon="sitemap" href="/services/overview">
    Comparativa de todos los microservicios
  </Card>

  <Card title="Kong Gateway" icon="route" href="/infrastructure/api-gateway">
    Configuración de rutas y seguridad
  </Card>

  <Card title="Base de Datos" icon="database" href="/infrastructure/databases">
    Esquemas y configuración de PostgreSQL
  </Card>
</CardGroup>