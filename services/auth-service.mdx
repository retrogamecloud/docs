---
title: 3.1. Servicio de Autenticación
description: Servicio de autenticación con JWT y gestión de usuarios
icon: lock
---

## Descripción

El servicio de autenticación maneja el registro, login y validación de usuarios mediante JSON Web Tokens (JWT). Es el punto de entrada para todos los usuarios de la plataforma y el guardián de seguridad que protege el acceso a los demás microservicios.

<CardGroup cols={3}>
  <Card title="Registro" icon="user-plus">
    Crear nuevas cuentas con username único requerido
  </Card>

  <Card title="Login" icon="right-to-bracket">
    Autenticación JWT con token válido por 24h
  </Card>

  <Card title="Validación" icon="shield-check">
    Middleware protector que verifica tokens en cada request
  </Card>
</CardGroup>

## Arquitectura del Servicio

```mermaid
graph TD
    A[Frontend] -->|POST /auth/register<br/>POST /auth/login<br/>GET /auth/verify| B[Kong API Gateway]
    B -->|Route: /auth/*| C[Auth Service :3001]
    C --> D[Controllers<br/>register/login/verify]
    D --> E[Services<br/>hashPass/genToken/validate]
    E --> F[Repositories<br/>create/findUser/update]
    F --> G[PostgreSQL<br/>Table: users]

```

## Configuración del Servicio

<AccordionGroup>
  <Accordion title="Variables de Entorno">
    ```env
    PORT=3001
    DATABASE_URL=postgresql://user:password@postgres:5432/auth_db
    JWT_SECRET=your-super-secret-jwt-key
    JWT_EXPIRES_IN=24h
    BCRYPT_SALT_ROUNDS=10
    NODE_ENV=production
    ```

  </Accordion>

  <Accordion title="Dockerfile">
    ```dockerfile
    FROM node:20-alpine
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production
    COPY . .
    EXPOSE 3001
    CMD ["npm", "start"]
    ```

  </Accordion>
</AccordionGroup>

## Tecnologías

| Tecnología | Versión | Propósito |
|------------|---------|-----------|
| **Node.js** | 20 LTS | Runtime de JavaScript |
| **Express** | ^4.18 | Framework web |
| **jsonwebtoken** | ^9.0 | Generación y validación de JWT |
| **bcrypt** | ^5.1 | Hashing de contraseñas |
| **pg** | ^8.11 | Cliente PostgreSQL |
| **joi** | ^17.9 | Validación de datos |

## Problemas Comunes

<AccordionGroup>
  <Accordion title="❌ Error: JWT Token Inválido" icon="exclamation-triangle">
    **Síntoma:**
    ```bash
    [ERROR] JWT verification failed: invalid signature
    [ERROR] Token expired at 2024-01-15T10:30:00.000Z
    ```


    **Posibles Causas:**
    - JWT_SECRET diferente entre servicios
    - Token expirado (>24h)
    - Malformación del token en headers

    **Solución Rápida:**
    ```bash
    # Verificar JWT_SECRET consistente
    docker exec auth-service printenv | grep JWT_SECRET

    # Regenerar token desde login
    curl -X POST http://localhost:3001/auth/login \
      -H "Content-Type: application/json" \
      -d '{"email":"user@test.com","password":"123456"}'
    ```

  </Accordion>

  <Accordion title="❌ Error: Conexión a Base de Datos" icon="database">
    **Síntoma:**
    ```bash
    [ERROR] Connection terminated unexpectedly
    [ERROR] ECONNREFUSED 127.0.0.1:5432
    ```


    **Posibles Causas:**
    - PostgreSQL no iniciado o inaccesible
    - Credenciales incorrectas en DATABASE_URL
    - Network issues entre contenedores

    **Solución Rápida:**
    ```bash
    # Verificar PostgreSQL
    docker ps | grep postgres

    # Probar conexión manual
    docker exec auth-service npx sequelize-cli db:migrate:status

    # Recrear conexión
    docker-compose restart postgres auth-service
    ```

  </Accordion>

  <Accordion title="❌ Error: Hash/Compare Password" icon="key">
    **Síntoma:**
    ```bash
    [ERROR] bcrypt.compare failed: data and hash arguments required
    [ERROR] Password validation failed for user: john_doe
    ```


    **Posibles Causas:**
    - BCRYPT_SALT_ROUNDS mal configurado
    - Hash corrupto en base de datos
    - Password null/undefined

    **Solución Rápida:**
    ```bash
    # Verificar configuración bcrypt
    echo "BCRYPT_SALT_ROUNDS=10" >> .env

    # Resetear password en DB
    docker exec -it postgres psql -U user -d auth_db -c \
      "UPDATE users SET password = NULL WHERE email = 'user@test.com';"

    # Forzar re-registro
    curl -X POST http://localhost:3001/auth/register \
      -H "Content-Type: application/json" \
      -d '{"email":"user@test.com","password":"newpass123"}'
    ```

  </Accordion>

  <Accordion title="❌ Error: Usuario Duplicado" icon="users">
    **Síntoma:**
    ```bash
    [ERROR] Unique constraint failed: users.email
    [ERROR] User already exists with email: john@example.com
    ```


    **Posibles Causas:**
    - Intento de registro con email existente
    - Falta validación previa en frontend
    - Race condition en requests concurrentes

    **Solución Rápida:**
    ```bash
    # Verificar usuario existente
    docker exec -it postgres psql -U user -d auth_db -c \
      "SELECT id, email, created_at FROM users WHERE email = 'john@example.com';"

    # Limpiar usuario para re-test (solo desarrollo)
    docker exec -it postgres psql -U user -d auth_db -c \
      "DELETE FROM users WHERE email = 'john@example.com';"
    ```

  </Accordion>

  <Accordion title="❌ Error: Headers Already Sent" icon="network-wired">
    **Síntoma:**
    ```bash
    [ERROR] Cannot set headers after they are sent to the client
    [ERROR] at ServerResponse.setHeader (_http_outgoing.js:356:11)
    ```


    **Posibles Causas:**
    - Múltiples res.send() en mismo endpoint
    - Error handling después de respuesta exitosa
    - Middleware calling next() after response

    **Solución Rápida:**
    ```javascript
    // Revisar controllers - usar return después de send
    return res.status(200).json({ token, user });

    // Verificar middleware auth
    if (!token) {
      return res.status(401).json({ error: 'No token provided' });
    }
    ```

  </Accordion>
</AccordionGroup>

## Logs Útiles para Debugging

```bash

# Logs en tiempo real del servicio auth
docker logs -f auth-service

# Filtrar solo errores críticos
docker logs auth-service 2>&1 | grep -E "(ERROR|FATAL)"

# Logs de JWT específicos
docker logs auth-service 2>&1 | grep -i "jwt\|token"

# Logs de database connections
docker logs auth-service 2>&1 | grep -i "database\|postgres\|connection"

```