---
title: 3.1. Servicio de Autenticación
description: Servicio de autenticación con JWT y gestión de usuarios
icon: lock
---

## Descripción

El servicio de autenticación maneja el registro, login y validación de usuarios mediante JSON Web Tokens (JWT). Es el punto de entrada para todos los usuarios de la plataforma y el guardián de seguridad que protege el acceso a los demás microservicios.

<CardGroup cols={3}>
  <Card title="Registro" icon="user-plus">
    Crear nuevas cuentas con username único requerido
  </Card>

  <Card title="Login" icon="right-to-bracket">
    Autenticación JWT con token válido por 24h
  </Card>

  <Card title="Validación" icon="shield-check">
    Middleware protector que verifica tokens en cada request
  </Card>
</CardGroup>

## Arquitectura del Servicio

```mermaid
graph TD
    A[Frontend] -->|POST /auth/register<br/>POST /auth/login<br/>GET /auth/verify| B[Kong API Gateway]
    B -->|Route: /auth/*| C[Auth Service :3001]
    C --> D[Controllers<br/>register/login/verify]
    D --> E[Services<br/>hashPass/genToken/validate]
    E --> F[Repositories<br/>create/findUser/update]
    F --> G[PostgreSQL<br/>Table: users]
```

## Configuración del Servicio

<AccordionGroup>
  <Accordion title="Variables de Entorno">
    ```env
    PORT=3001
    DATABASE_URL=postgresql://user:password@postgres:5432/auth_db
    JWT_SECRET=your-super-secret-jwt-key
    JWT_EXPIRES_IN=24h
    BCRYPT_SALT_ROUNDS=10
    NODE_ENV=production
    ```
  </Accordion>

  <Accordion title="Dockerfile">
    ```dockerfile
    FROM node:20-alpine
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production
    COPY . .
    EXPOSE 3001
    CMD ["npm", "start"]
    ```
  </Accordion>

  <Accordion title="package.json">
    ```json
    {
      "name": "auth-service",
      "version": "1.0.0",
      "scripts": {
        "start": "node src/index.js",
        "dev": "nodemon src/index.js",
        "test": "jest"
      },
      "dependencies": {
        "express": "^4.18.2",
        "jsonwebtoken": "^9.0.0",
        "bcrypt": "^5.1.0",
        "pg": "^8.10.0",
        "cors": "^2.8.5",
        "helmet": "^6.1.5",
        "express-rate-limit": "^6.7.0"
      }
    }
    ```
  </Accordion>
</AccordionGroup>

## Tecnologías

| Tecnología | Versión | Propósito |
|------------|---------|-----------|
| **Node.js** | 20 LTS | Runtime de JavaScript |
| **Express** | ^4.18 | Framework web |
| **jsonwebtoken** | ^9.0 | Generación y validación de JWT |
| **bcrypt** | ^5.1 | Hash de contraseñas |
| **PostgreSQL** | 15 | Base de datos relacional |
| **pg** | ^8.10 | Driver de PostgreSQL |
| **helmet** | ^6.1 | Middleware de seguridad |
| **express-rate-limit** | ^6.7 | Limitador de requests |

## API Endpoints

<AccordionGroup>
  <Accordion title="POST /auth/register">
    **Descripción**: Registrar un nuevo usuario

    **Request Body**:
    ```json
    {
      "username": "johndoe",
      "password": "securePassword123"
    }
    ```

    **Response (201)**:
    ```json
    {
      "message": "Usuario registrado exitosamente",
      "user": {
        "id": 1,
        "username": "johndoe",
        "created_at": "2023-12-01T10:00:00Z"
      },
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
    ```

    **Errores**:
    - `400`: Username ya existe
    - `400`: Datos de entrada inválidos
  </Accordion>

  <Accordion title="POST /auth/login">
    **Descripción**: Autenticar usuario existente

    **Request Body**:
    ```json
    {
      "username": "johndoe",
      "password": "securePassword123"
    }
    ```

    **Response (200)**:
    ```json
    {
      "message": "Login exitoso",
      "user": {
        "id": 1,
        "username": "johndoe"
      },
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
    ```

    **Errores**:
    - `401`: Credenciales inválidas
    - `400`: Datos de entrada inválidos
  </Accordion>

  <Accordion title="GET /auth/verify">
    **Descripción**: Verificar validez del token JWT

    **Headers**:
    ```
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    ```

    **Response (200)**:
    ```json
    {
      "valid": true,
      "user": {
        "id": 1,
        "username": "johndoe"
      }
    }
    ```

    **Errores**:
    - `401`: Token inválido o expirado
    - `400`: Token no proporcionado
  </Accordion>
</AccordionGroup>

## Estructura del Proyecto

```
auth-service/
├── src/
│   ├── controllers/
│   │   ├── authController.js     # Lógica de endpoints
│   │   └── index.js
│   ├── services/
│   │   ├── authService.js        # Lógica de negocio
│   │   ├── jwtService.js         # Manejo de JWT
│   │   └── passwordService.js    # Hash de contraseñas
│   ├── repositories/
│   │   ├── userRepository.js     # Acceso a datos
│   │   └── index.js
│   ├── middleware/
│   │   ├── authMiddleware.js     # Validación de tokens
│   │   ├── validation.js         # Validación de entrada
│   │   └── errorHandler.js       # Manejo de errores
│   ├── models/
│   │   └── User.js               # Modelo de usuario
│   ├── database/
│   │   ├── connection.js         # Conexión a PostgreSQL
│   │   └── migrations/
│   ├── routes/
│   │   └── authRoutes.js         # Definición de rutas
│   └── index.js                  # Punto de entrada
├── tests/
├── docker-compose.yml
├── Dockerfile
└── package.json
```

## Modelo de Datos

### Tabla: users

| Campo | Tipo | Descripción |
|-------|------|-------------|
| `id` | SERIAL PRIMARY KEY | Identificador único |
| `username` | VARCHAR(50) UNIQUE | Nombre de usuario |
| `password_hash` | VARCHAR(255) | Contraseña hasheada |
| `created_at` | TIMESTAMP | Fecha de creación |
| `updated_at` | TIMESTAMP | Última actualización |

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
```

## Seguridad

<CardGroup cols={2}>
  <Card title="Protección de Contraseñas" icon="shield">
    - Hash con bcrypt (10 rounds)
    - Validación de fortaleza
    - Nunca almacenar en texto plano
  </Card>

  <Card title="JWT Security" icon="key">
    - Tokens con expiración (24h)
    - Secret key seguro
    - Verificación en cada request
  </Card>

  <Card title="Rate Limiting" icon="clock">
    - Máximo 5 intentos de login por minuto
    - Protección contra ataques de fuerza bruta
    - IP-based limiting
  </Card>

  <Card title="Headers de Seguridad" icon="helmet">
    - Helmet.js configurado
    - CORS restrictivo
    - Headers de seguridad HTTP
  </Card>
</CardGroup>

## Deployment

### Docker Compose

```yaml
version: '3.8'
services:
  auth-service:
    build: .
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://auth_user:password@postgres:5432/auth_db
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
    networks:
      - microservices-network

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: password
    volumes:
      - auth_postgres_data:/var/lib/postgresql/data
    networks:
      - microservices-network

volumes:
  auth_postgres_data:

networks:
  microservices-network:
    external: true
```

### Health Check

```javascript
app.get('/health', (req, res) => {
  res.status(200).json({
    service: 'auth-service',
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});
```

## Monitoreo y Logs

- **Logs estructurados**: Winston logger
- **Métricas**: Endpoints de health check
- **Errores**: Tracking de intentos de login fallidos
- **Performance**: Tiempo de respuesta de autenticación

<Tip>
El servicio de autenticación es crítico para toda la plataforma. Implementa monitoreo robusto y mantén backups regulares de la base de datos de usuarios.
</Tip>