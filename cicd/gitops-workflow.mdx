---
title: 7.3. Flujo de Trabajo GitOps
sidebarTitle: 7.3. GitOps Workflow
description: Flujo de trabajo GitOps completo con ArgoCD y gestión de base de datos
icon: code-branch
---

## ¿Qué es GitOps?

GitOps es una metodología de despliegue donde **Git es la única fuente de verdad** para la infraestructura y aplicaciones.

<CardGroup cols={3}>
  <Card title="Declarativo" icon="file-code">
    Todo el estado deseado en Git

    YAMLs de Kubernetes
  </Card>

  <Card title="Versionado" icon="clock-rotate-left">
    Historial completo

    Rollback con `git revert`
  </Card>

  <Card title="Automático" icon="wand-magic-sparkles">
    Deploy automático

    Sin kubectl manual
  </Card>
</CardGroup>

## Repositorio GitOps: `kubernetes/`

Este repositorio centraliza todos los manifiestos de Kubernetes y scripts de migración de base de datos.

### Estructura del Repositorio

```

kubernetes/
├── .github/
│   └── workflows/
│       ├── ci.yml                    # Validación de manifiestos
│       └── migration-tests.yml      # Tests de migración
├── tests/
│   └── validate-manifests.test.js   # Tests unitarios
├── migrations/
│   ├── V001__initial_schema.sql     # Migración inicial
│   ├── V002__add_users_table.sql    # Tabla de usuarios
│   ├── V003__add_games_indexes.sql  # Índices de juegos
│   ├── U003__remove_games_indexes.sql # Rollback V003
│   └── flyway.conf                   # Configuración Flyway
├── 00-namespace.yaml                 # Namespace retrogame
├── 01-postgres.yaml                  # Base de datos PostgreSQL
├── 02-backend.yaml                   # Backend unificado (API)
├── 03-cdn.yaml                       # CDN de juegos (Nginx)
├── 04-frontend.yaml                  # Frontend web
├── 05-kong.yaml                      # API Gateway Kong
├── README.md
└── package.json

```

### Nomenclatura de Archivos

Los archivos están numerados para indicar el orden de aplicación:

<Steps>
  <Step title="00-namespace.yaml">
    **Primero**: Crear el namespace `retrogame`

    Todos los demás recursos dependen de esto.
  </Step>

  <Step title="01-postgres.yaml">
    **Segundo**: Base de datos

    Los servicios necesitan conectarse a PostgreSQL.
  </Step>

  <Step title="02-11-services.yaml">
    **Tercero**: Servicios de aplicación

    Backend, frontend, microservicios y API Gateway.
  </Step>

  <Step title="11-flyway-migration-job.yaml">
    **Último**: Job de migración

    Ejecuta migraciones después del despliegue de la base de datos.
  </Step>
</Steps>

## Migraciones de Base de Datos

### Herramientas

Utilizamos **Flyway** para versionado de esquema con migraciones SQL versionadas.

<Card title="¿Por qué Flyway?" icon="database">
  - **Versionado automático**: Trackea qué migraciones se han ejecutado
  - **Checksums**: Valida integridad de migraciones existentes
  - **Rollback**: Soporte para migraciones reversibles
  - **Kubernetes Jobs**: Integración nativa con nuestro flujo GitOps
</Card>

### Proceso de Migración

<Steps>
  <Step title="Crear Script de Migración">
    ```sql
    -- migrations/V004__add_leaderboard_table.sql
    CREATE TABLE leaderboard (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id),
        game_id INTEGER REFERENCES games(id),
        score INTEGER NOT NULL,
        achieved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX idx_leaderboard_game_score ON leaderboard(game_id, score DESC);
    ```

  </Step>

  <Step title="Probar en Local">
    ```bash
    # Usar Docker Compose para testing local
    docker-compose -f docker-compose.test.yml up postgres

    # Ejecutar migración
    flyway -configFiles=migrations/flyway.conf migrate

    # Validar resultado
    psql -h localhost -U retrogame_user -d retrogame_test -c "\dt"
    ```

  </Step>

  <Step title="Ejecutar en Staging">
    ```yaml
    # 11-flyway-migration-job.yaml
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: flyway-migration-staging
      namespace: retrogame
    spec:
      template:
        spec:
          containers:
          - name: flyway
            image: flyway/flyway:8.5.13
            command: ["flyway", "migrate"]
            env:
            - name: FLYWAY_URL
              value: "jdbc:postgresql://postgres-staging:5432/retrogame"
            - name: FLYWAY_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: username
            - name: FLYWAY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: password
            volumeMounts:
            - name: migration-scripts
              mountPath: /flyway/sql
          volumes:
          - name: migration-scripts
            configMap:
              name: flyway-migrations
          restartPolicy: Never
    ```

  </Step>

  <Step title="Validar Integridad">
    ```bash
    # Tests automatizados post-migración
    kubectl apply -f tests/migration-validation-job.yaml

    # Verificar que no hay errores
    kubectl logs -f job/migration-validation
    ```

  </Step>

  <Step title="Desplegar en Producción">
    <Warning>
      Migraciones en producción requieren **ventana de mantenimiento aprobada**
    </Warning>

    ```bash
    # Aplicar con ArgoCD
    argocd app sync retrogame-production

    # Monitorear ejecución
    kubectl logs -f job/flyway-migration-production
    ```

  </Step>
</Steps>

### Estrategias de Versionado de Esquema

<CardGroup cols={2}>
  <Card title="Migraciones Aditivas" icon="plus">
    **Seguras para aplicar en caliente:**

    - `ADD COLUMN` con valores por defecto
    - `CREATE INDEX CONCURRENTLY`
    - `CREATE TABLE` nuevas
    - Nuevas vistas y funciones
  </Card>

  <Card title="Migraciones Destructivas" icon="triangle-exclamation">
    **Requieren ventana de mantenimiento:**

    - `DROP COLUMN`
    - `ALTER COLUMN` que cambie tipo
    - `DROP INDEX` en tablas grandes
    - Renombrar columnas críticas
  </Card>
</CardGroup>

### Nomenclatura de Migraciones

```

V{VERSION}__{DESCRIPCION}.sql     # Migración hacia adelante
U{VERSION}__{DESCRIPCION}.sql     # Migración de rollback

Ejemplos:
V001__initial_schema.sql
V002__add_users_table.sql
V003__add_games_indexes.sql
U003__remove_games_indexes.sql   # Rollback de V003
V004__add_leaderboard_table.sql

```

### Procedimientos de Rollback

<Accordion title="Rollback Automático">
  Para migraciones con script de rollback disponible:

  ```bash
  # Ejecutar rollback usando Flyway
  flyway undo -target=V002

  # O mediante Job de Kubernetes
  kubectl apply -f jobs/flyway-rollback-job.yaml
  ```

</Accordion>

<Accordion title="Rollback Manual">
  Para migraciones sin script de rollback:

  <Steps>
    <Step title="Identificar Cambios">
      ```sql
      -- Revisar historial de migraciones
      SELECT * FROM flyway_schema_history ORDER BY installed_on DESC;
      ```

    </Step>

    <Step title="Crear Script de Rollback">
      ```sql
      -- Ejemplo: Rollback de ADD COLUMN
      ALTER TABLE users DROP COLUMN last_login;

      -- Ejemplo: Rollback de CREATE INDEX
      DROP INDEX CONCURRENTLY idx_users_email;
      ```

    </Step>

    <Step title="Aplicar con Precaución">
      <Warning>
        Migraciones destructivas pueden causar pérdida de datos
      </Warning>

      ```bash
      # Backup antes del rollback
      pg_dump retrogame > backup_pre_rollback.sql

      # Aplicar rollback
      psql -f rollback_script.sql retrogame
      ```

    </Step>
  </Steps>
</Accordion>

## Flujo GitOps Completo

### 1. Desarrollo Local

```bash

# Developer workflow
git checkout -b feature/new-leaderboard

# Crear migración
echo "CREATE TABLE leaderboard..." > migrations/V004__add_leaderboard.sql

# Probar localmente
docker-compose up -d postgres
flyway migrate

# Commit cambios
git add migrations/
git commit -m "feat: add leaderboard table migration"
git push origin feature/new-leaderboard

```

### 2. CI/CD Pipeline

```yaml

# .github/workflows/ci.yml
name: Validate Manifests and Migrations

on:
  pull_request:
    branches: [main]

jobs:
  validate-manifests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Validate Kubernetes YAMLs
      run: |
        kubectl --dry-run=client apply -f *.yaml

    - name: Test Migrations
      run: |
        docker-compose -f docker-compose.test.yml up -d postgres
        flyway -configFiles=migrations/flyway.conf migrate
        flyway validate

```

### 3. ArgoCD Sync

```bash

# ArgoCD detecta cambios en el repo

# y aplica automáticamente:

1. Manifiestos de Kubernetes actualizados
2. Job de migración con nuevos scripts
3. Validación post-despliegue

```

<Info>

* *Resultado**: Infraestructura y esquema de base de datos siempre sincronizados con Git, con historial completo y capacidad de rollback.
</Info>

## Mejores Prácticas

<CardGroup cols={2}>
  <Card title="Seguridad" icon="shield">
    - Nunca hardcodear credenciales
    - Usar Kubernetes Secrets
    - Principio de menor privilegio
    - Auditar cambios de esquema
  </Card>

  <Card title="Reliability" icon="heart">
    - Siempre crear script de rollback
    - Probar en staging primero
    - Backup antes de migraciones
    - Monitorear métricas post-deploy
  </Card>
</CardGroup>