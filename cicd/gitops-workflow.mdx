---
title: 7.3. Flujo de Trabajo GitOps
description: Flujo de trabajo GitOps completo con ArgoCD y gestiÃ³n de base de datos
icon: code-branch
---

## Â¿QuÃ© es GitOps?

GitOps es una metodologÃ­a de despliegue donde **Git es la Ãºnica fuente de verdad** para la infraestructura y aplicaciones.

<CardGroup cols={3}>
  <Card title="Declarativo" icon="file-code">
    Todo el estado deseado en Git

    YAMLs de Kubernetes
  </Card>

  <Card title="Versionado" icon="clock-rotate-left">
    Historial completo

    Rollback con `git revert`
  </Card>

  <Card title="AutomÃ¡tico" icon="wand-magic-sparkles">
    Deploy automÃ¡tico

    Sin kubectl manual
  </Card>
</CardGroup>

## Flujo de Trabajo Completo

El siguiente diagrama muestra el flujo completo desde el desarrollo hasta la producciÃ³n:

```mermaid
flowchart TD
    Dev[ğŸ‘©â€ğŸ’» Desarrollador] -->|git push| GitHub[ğŸ“¦ GitHub Repository]
    
    GitHub --> Actions[âš¡ GitHub Actions]
    Actions --> Validate[âœ… Validar Manifiestos]
    Actions --> Test[ğŸ§ª Test Migraciones]
    Actions --> Build[ğŸ”¨ Build & Push Images]
    
    Build --> Success{âœ… CI Success?}
    Success -->|âŒ Fail| Notification[ğŸ“§ Notificar Error]
    Success -->|âœ… Pass| ArgoCD[ğŸ¤– ArgoCD]
    
    ArgoCD --> Sync[ğŸ”„ Sync Manifiestos]
    Sync --> EKS[â˜ï¸ Amazon EKS]
    
    EKS --> Deploy[ğŸš€ Deploy AplicaciÃ³n]
    Deploy --> Health{ğŸ’š Health Check?}
    
    Health -->|âŒ Fail| Rollback[â†©ï¸ Rollback AutomÃ¡tico]
    Health -->|âœ… Pass| Production[ğŸŒ ProducciÃ³n]
    
    Rollback --> ArgoCD
    Production --> Monitor[ğŸ“Š Monitoreo]
    
    Monitor -->|ğŸš¨ Alerta| AlertManager[ğŸ”” Alert Manager]
    AlertManager --> Slack[ğŸ’¬ Slack/Email]

    classDef github fill:#f9f9f9,stroke:#24292e
    classDef actions fill:#e7f3ff,stroke:#0969da
    classDef argocd fill:#fff2e7,stroke:#fd7e14
    classDef eks fill:#e7f7ff,stroke:#0084c7
    classDef success fill:#e7f7e7,stroke:#28a745
    classDef error fill:#ffe7e7,stroke:#dc3545
    
    class GitHub github
    class Actions,Validate,Test,Build actions
    class ArgoCD,Sync argocd
    class EKS,Deploy eks
    class Production success
    class Rollback,Notification error
```

## Repositorio GitOps: `kubernetes/`

Este repositorio centraliza todos los manifiestos de Kubernetes y scripts de migraciÃ³n de base de datos.

### Estructura del Repositorio

```
kubernetes/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml                    # ValidaciÃ³n de manifiestos
â”‚       â””â”€â”€ migration-tests.yml      # Tests de migraciÃ³n
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ validate-manifests.test.js   # Tests unitarios
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ V001__initial_schema.sql     # MigraciÃ³n inicial
â”‚   â”œâ”€â”€ V002__add_users_table.sql    # Tabla de usuarios
â”‚   â”œâ”€â”€ V003__add_games_indexes.sql  # Ãndices de juegos
â”‚   â”œâ”€â”€ U003__remove_games_indexes.sql # Rollback V003
â”‚   â””â”€â”€ flyway.conf                   # ConfiguraciÃ³n Flyway
â”œâ”€â”€ 00-namespace.yaml                 # Namespace retrogame
â”œâ”€â”€ 01-postgres.yaml                  # Base de datos PostgreSQL
â”œâ”€â”€ 02-backend.yaml                   # Servicios backend (monolito)
â”œâ”€â”€ 03-cdn.yaml                       # CDN de juegos (Nginx)
â”œâ”€â”€ 04-frontend.yaml                  # Frontend web
â”œâ”€â”€ 05-kong.yaml                      # API Gateway Kong
â”œâ”€â”€ 06-auth-service.yaml              # Servicio de autenticaciÃ³n
â”œâ”€â”€ 07-game-catalog.yaml             # CatÃ¡logo de juegos
â”œâ”€â”€ 08-score-service.yaml            # Servicio de puntuaciones
â”œâ”€â”€ 09-ranking-service.yaml          # Servicio de ranking
â”œâ”€â”€ 10-redis.yaml                    # Cache Redis
â””â”€â”€ 11-monitoring.yaml               # Stack de monitoreo
```

### Pipeline de CI/CD

<Tabs>
  <Tab title="GitHub Actions">
    ```yaml
    name: Validar Manifiestos
    on:
      push:
        branches: [main, develop]
      pull_request:
        branches: [main]

    jobs:
      validate:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          
          - name: Validar YAML
            run: |
              yamllint *.yaml
              kubeval *.yaml
              
          - name: Test Migraciones
            run: |
              docker run --rm -v $(pwd)/migrations:/flyway/sql \
                flyway/flyway validate
    ```
  </Tab>

  <Tab title="ArgoCD Application">
    ```yaml
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: retrogame-platform
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/empresa/kubernetes
        targetRevision: main
        path: .
      destination:
        server: https://kubernetes.default.svc
        namespace: retrogame
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
    ```
  </Tab>

  <Tab title="Rollback Strategy">
    ```bash
    # Rollback automÃ¡tico en caso de fallo
    # ArgoCD detecta fallos en health checks
    
    # 1. Rollback de aplicaciÃ³n
    argocd app rollback retrogame-platform
    
    # 2. Rollback de base de datos (si necesario)
    docker run --rm \
      -v $(pwd)/migrations:/flyway/sql \
      flyway/flyway undo
    
    # 3. NotificaciÃ³n automÃ¡tica
    curl -X POST $SLACK_WEBHOOK \
      -d "Rollback ejecutado en retrogame-platform"
    ```
  </Tab>
</Tabs>

## GestiÃ³n de Base de Datos

### Migraciones con Flyway

<Warning>
Las migraciones se ejecutan **antes** del despliegue de aplicaciones para garantizar compatibilidad del esquema.
</Warning>

```sql
-- migrations/V004__add_achievements_table.sql
CREATE TABLE achievements (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    game_id VARCHAR(50) NOT NULL,
    achievement_type VARCHAR(100) NOT NULL,
    points INTEGER DEFAULT 0,
    unlocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_achievements_user_game 
ON achievements(user_id, game_id);
```

### Rollback de Migraciones

```sql
-- migrations/U004__remove_achievements_table.sql
DROP TABLE IF EXISTS achievements CASCADE;
```

## Monitoreo y Alertas

El flujo GitOps incluye monitoreo continuo:

<CardGroup cols={2}>
  <Card title="Health Checks" icon="heart-pulse">
    - Liveness probes
    - Readiness probes  
    - Startup probes
    - Database connectivity
  </Card>

  <Card title="MÃ©tricas Clave" icon="chart-line">
    - Deployment success rate
    - Rollback frequency
    - Time to recovery
    - Migration duration
  </Card>
</CardGroup>

## Estrategias de Despliegue

### Blue-Green Deployment

```yaml
# ConfiguraciÃ³n para despliegue blue-green
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 0
```

### Canary Releases

```yaml
# ArgoCD Rollouts para canary
apiVersion: argoproj.io/v1alpha1
kind: Rollout
spec:
  strategy:
    canary:
      steps:
      - setWeight: 10
      - pause: {duration: 5m}
      - setWeight: 50
      - pause: {duration: 10m}
```

<Tip>
El flujo GitOps garantiza **despliegues consistentes** y **rollbacks rÃ¡pidos** manteniendo siempre la trazabilidad completa en Git.
</Tip>