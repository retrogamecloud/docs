---
title: "Flujo de Trabajo GitOps"
description: "Flujo de trabajo GitOps completo con ArgoCD"
icon: "code-branch"
---

## Â¿QuÃ© es GitOps?

GitOps es una metodologÃ­a de despliegue donde **Git es la Ãºnica fuente de verdad** para la infraestructura y aplicaciones.

<CardGroup cols={3}>
  <Card title="Declarativo" icon="file-code">
    Todo el estado deseado en Git
    
    YAMLs de Kubernetes
  </Card>
  
  <Card title="Versionado" icon="clock-rotate-left">
    Historial completo
    
    Rollback con `git revert`
  </Card>
  
  <Card title="AutomÃ¡tico" icon="wand-magic-sparkles">
    Deploy automÃ¡tico
    
    Sin kubectl manual
  </Card>
</CardGroup>

## Repositorio GitOps: `kubernetes/`

Este repositorio centraliza todos los manifiestos de Kubernetes.

### Estructura del Repositorio

```
kubernetes/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ ci.yml                    # ValidaciÃ³n de manifiestos
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ validate-manifests.test.js    # Tests unitarios
â”œâ”€â”€ 00-namespace.yaml                 # Namespace retrogame
â”œâ”€â”€ 01-postgres.yaml                  # Base de datos PostgreSQL
â”œâ”€â”€ 02-backend.yaml                   # Servicios backend (monolito)
â”œâ”€â”€ 03-cdn.yaml                       # CDN de juegos (Nginx)
â”œâ”€â”€ 04-frontend.yaml                  # Frontend web
â”œâ”€â”€ 05-kong.yaml                      # API Gateway Kong
â”œâ”€â”€ 06-auth-service.yaml             # Servicio de autenticaciÃ³n
â”œâ”€â”€ 07-game-catalog.yaml             # CatÃ¡logo de juegos
â”œâ”€â”€ 08-score-service.yaml            # Servicio de puntuaciones
â”œâ”€â”€ 09-ranking-service.yaml          # Servicio de rankings
â”œâ”€â”€ 10-user-service.yaml             # Servicio de usuarios
â”œâ”€â”€ README.md
â””â”€â”€ package.json
```

### Nomenclatura de Archivos

Los archivos estÃ¡n numerados para indicar el orden de aplicaciÃ³n:

<Steps>
  <Step title="00-namespace.yaml">
    **Primero**: Crear el namespace `retrogame`
    
    Todos los demÃ¡s recursos dependen de esto.
  </Step>
  
  <Step title="01-postgres.yaml">
    **Segundo**: Base de datos
    
    Los servicios backend necesitan la BD activa.
  </Step>
  
  <Step title="02-05">
    **Infraestructura**: Backend monolito, CDN, frontend, Kong
    
    Componentes core del sistema.
  </Step>
  
  <Step title="06-10">
    **Microservicios**: Auth, games, scores, rankings, users
    
    Servicios especÃ­ficos de dominio.
  </Step>
</Steps>

## Flujo GitOps Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEVELOPER WORKFLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 1. Push cÃ³digo         â”‚
           â”‚    (servicio X)        â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 2. GitHub Actions      â”‚
           â”‚    - Tests             â”‚
           â”‚    - Build Docker      â”‚
           â”‚    - Push image        â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 3. Update manifest     â”‚
           â”‚    repo kubernetes/    â”‚
           â”‚    (crear PR)          â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                     â–¼
    [Auto-merge]         [Manual Review]
         â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 4. PR Merged to main   â”‚
           â”‚    (repo kubernetes/)  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 5. ArgoCD detecta      â”‚
           â”‚    cambio en Git       â”‚
           â”‚    (poll cada 3 min)   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ 6. ArgoCD sincroniza   â”‚
           â”‚    - kubectl apply     â”‚
           â”‚    - Rolling update    â”‚
           â”‚    - Health checks     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DEPLOYED TO PRODUCTION (EKS)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Ejemplo PrÃ¡ctico: Actualizar Frontend

<Steps>
  <Step title="Developer: Hacer cambio en cÃ³digo">
    ```bash
    cd frontend/
    # Hacer cambios en el cÃ³digo
    vim src/index.html
    
    git add .
    git commit -m "feat: mejorar UI de selecciÃ³n de juegos"
    git push origin main
    ```
  </Step>
  
  <Step title="GitHub Actions: Build automÃ¡tico">
    El workflow se ejecuta automÃ¡ticamente:
    
    ```
    Running Tests...              âœ… Passed (1m 23s)
    Building Docker Image...      âœ… Built (2m 15s)
    Pushing to Docker Hub...      âœ… Pushed (45s)
    Image: retrogamehub/frontend:sha-a1b2c3d
    ```
  </Step>
  
  <Step title="GitHub Actions: Update manifest">
    El workflow clona el repo `kubernetes/` y actualiza:
    
    ```diff
    # 04-frontend.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: frontend
    spec:
      template:
        spec:
          containers:
          - name: frontend
    -       image: retrogamehub/frontend:sha-xyz123
    +       image: retrogamehub/frontend:sha-a1b2c3d
    ```
    
    Crea PR automÃ¡tico: `chore(frontend): Actualizar a sha-a1b2c3d`
  </Step>
  
  <Step title="Review (Opcional) & Merge">
    **OpciÃ³n A - Auto-merge:**
    ```yaml
    # PR tiene label 'auto-merge'
    # Se mergea automÃ¡ticamente si pasa CI
    ```
    
    **OpciÃ³n B - Manual:**
    ```bash
    # Revisor verifica el PR en GitHub
    # Click "Merge pull request"
    ```
  </Step>
  
  <Step title="ArgoCD: Detectar cambio">
    ArgoCD hace polling cada 3 minutos:
    
    ```
    [15:03] Checking kubernetes/ repository...
    [15:03] New commit detected: abc123
    [15:03] Application 'frontend' out of sync
    [15:03] Triggering sync...
    ```
  </Step>
  
  <Step title="ArgoCD: Aplicar cambios">
    ```bash
    # ArgoCD ejecuta internamente:
    kubectl apply -f 04-frontend.yaml
    
    # Rolling update automÃ¡tico:
    deployment.apps/frontend configured
    
    # Health checks:
    âœ… Deployment is healthy
    âœ… Pods are ready (3/3)
    âœ… Service endpoints updated
    ```
    
    **Zero downtime**: Los pods viejos siguen sirviendo trÃ¡fico hasta que los nuevos estÃ©n ready.
  </Step>
</Steps>

## Manifiestos de Kubernetes

### Ejemplo: Frontend Deployment

<CodeGroup>
```yaml 04-frontend.yaml
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: retrogame
  labels:
    app: frontend
spec:
  selector:
    app: frontend
  ports:
    - name: http
      port: 8000
      targetPort: 8000
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: retrogame
  labels:
    app: frontend
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        # Imagen actualizada automÃ¡ticamente por CI/CD
        image: retrogamehub/frontend:sha-a1b2c3d
        ports:
        - containerPort: 8000
          name: http
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
```
</CodeGroup>

**Puntos clave:**

- âœ… **RollingUpdate**: Deploy sin downtime
- âœ… **maxUnavailable: 0**: Siempre mantiene pods disponibles
- âœ… **Health checks**: Garantiza que pods estÃ©n listos
- âœ… **Resources**: Previene resource starvation

### Ejemplo: Backend con ConfigMap

<CodeGroup>
```yaml 02-backend.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-config
  namespace: retrogame
data:
  NODE_ENV: "production"
  PORT: "3000"
  LOG_LEVEL: "info"

---
apiVersion: v1
kind: Secret
metadata:
  name: backend-secrets
  namespace: retrogame
type: Opaque
data:
  DB_PASSWORD: cGFzc3dvcmQxMjM=  # base64 encoded
  JWT_SECRET: c3VwZXJzZWNyZXQxMjM=

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: retrogame
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: retrogamehub/backend:sha-xyz789
        ports:
        - containerPort: 3000
        envFrom:
        - configMapRef:
            name: backend-config
        env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: backend-secrets
              key: DB_PASSWORD
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: backend-secrets
              key: JWT_SECRET
```
</CodeGroup>

## ArgoCD Setup (Planeado)

<Info>
  ArgoCD aÃºn no estÃ¡ desplegado. Actualmente los despliegues se hacen manualmente con `kubectl apply`.
</Info>

### Instalar ArgoCD en EKS

<Steps>
  <Step title="Crear namespace">
    ```bash
    kubectl create namespace argocd
    ```
  </Step>
  
  <Step title="Instalar ArgoCD">
    ```bash
    kubectl apply -n argocd -f \
      https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    ```
  </Step>
  
  <Step title="Exponer UI con ALB">
    ```yaml
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: argocd-server
      namespace: argocd
      annotations:
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/backend-protocol: HTTPS
    spec:
      ingressClassName: alb
      rules:
      - host: argocd.retrogamecloud.com
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                port:
                  number: 443
    ```
  </Step>
  
  <Step title="Obtener password inicial">
    ```bash
    kubectl -n argocd get secret argocd-initial-admin-secret \
      -o jsonpath="{.data.password}" | base64 -d
    ```
  </Step>
  
  <Step title="Configurar aplicaciÃ³n">
    ```yaml
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: retrogame-stack
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/retrogamecloud/kubernetes.git
        targetRevision: main
        path: .
      destination:
        server: https://kubernetes.default.svc
        namespace: retrogame
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        syncOptions:
        - CreateNamespace=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
    ```
  </Step>
</Steps>

### Configurar Auto-Sync

```yaml
syncPolicy:
  automated:
    prune: true        # Elimina recursos que ya no estÃ¡n en Git
    selfHeal: true     # Revierte cambios manuales
```

**Comportamiento:**
- ArgoCD sincroniza automÃ¡ticamente cada 3 minutos
- Si alguien hace `kubectl edit` manual, ArgoCD lo revierte
- Si se elimina un recurso del Git, ArgoCD lo elimina del cluster

## Rollback

### MÃ©todo 1: Git Revert (Recomendado)

```bash
# Ver historial de commits
cd kubernetes/
git log --oneline

# Revertir el Ãºltimo despliegue
git revert HEAD

# Push
git push origin main

# ArgoCD detectarÃ¡ el revert y aplicarÃ¡ la versiÃ³n anterior
```

**Ventajas:**
- âœ… Mantiene historial completo
- âœ… Auditable
- âœ… Reproducible

### MÃ©todo 2: Rollback de Kubernetes

```bash
# Ver historial de revisiones
kubectl rollout history deployment/frontend -n retrogame

# Rollback a la revisiÃ³n anterior
kubectl rollout undo deployment/frontend -n retrogame

# Rollback a una revisiÃ³n especÃ­fica
kubectl rollout undo deployment/frontend -n retrogame --to-revision=3
```

<Warning>
  Este mÃ©todo funciona pero **rompe GitOps**. El estado en Git no coincide con producciÃ³n. Usa solo en emergencias.
</Warning>

### MÃ©todo 3: Cambiar imagen manualmente

```bash
cd kubernetes/
vim 04-frontend.yaml

# Cambiar la lÃ­nea:
# image: retrogamehub/frontend:sha-a1b2c3d
# a la versiÃ³n anterior:
# image: retrogamehub/frontend:sha-xyz123

git add 04-frontend.yaml
git commit -m "revert(frontend): rollback to sha-xyz123"
git push origin main
```

## Ambiente de Staging

Para implementar un ambiente de staging:

<Steps>
  <Step title="Crear namespace staging">
    ```yaml
    # 00-namespace-staging.yaml
    apiVersion: v1
    kind: Namespace
    metadata:
      name: retrogame-staging
    ```
  </Step>
  
  <Step title="Duplicar manifiestos con suffix">
    ```bash
    cp 04-frontend.yaml 04-frontend-staging.yaml
    
    # Modificar namespace y nombres
    sed -i 's/namespace: retrogame/namespace: retrogame-staging/g' 04-frontend-staging.yaml
    sed -i 's/name: frontend/name: frontend-staging/g' 04-frontend-staging.yaml
    ```
  </Step>
  
  <Step title="Workflow para staging">
    Modificar GitHub Actions para desplegar a staging en PRs:
    
    ```yaml
    on:
      pull_request:
        branches: [ main ]
    
    jobs:
      deploy-staging:
        steps:
          - name: Update staging manifest
            run: |
              sed -i "s|image:.*|image: retrogamehub/frontend:pr-${{ github.event.pull_request.number }}|" \
                04-frontend-staging.yaml
    ```
  </Step>
  
  <Step title="ArgoCD app separada">
    ```yaml
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: retrogame-staging
    spec:
      source:
        repoURL: https://github.com/retrogamecloud/kubernetes.git
        path: staging/
      destination:
        namespace: retrogame-staging
    ```
  </Step>
</Steps>

## Monitoreo del Estado

### Con kubectl

```bash
# Ver estado de todos los deployments
kubectl get deployments -n retrogame

# Ver pods
kubectl get pods -n retrogame -o wide

# Ver eventos recientes
kubectl get events -n retrogame --sort-by='.lastTimestamp'

# Describir un deployment
kubectl describe deployment frontend -n retrogame
```

### Con ArgoCD UI

Acceder a `https://argocd.retrogamecloud.com`:

- ğŸŸ¢ **Synced**: Git y cluster coinciden
- ğŸŸ¡ **OutOfSync**: Hay diferencias
- ğŸ”´ **Degraded**: AplicaciÃ³n unhealthy
- ğŸ”µ **Progressing**: SincronizaciÃ³n en curso

### Con Prometheus Queries

```promql
# Ver versiÃ³n desplegada por pod
kube_pod_labels{namespace="retrogame", pod=~"frontend-.*"}

# Ver timestamp del Ãºltimo despliegue
kube_deployment_status_observed_generation{namespace="retrogame"}
```

## Best Practices GitOps

<AccordionGroup>
  <Accordion title="âœ… 1. Git como Ãºnica fuente de verdad">
    - Nunca hacer `kubectl apply` manual en producciÃ³n
    - Todos los cambios vÃ­a Git
    - Documentar excepciones si las hay
  </Accordion>
  
  <Accordion title="âœ… 2. Pull Requests obligatorios">
    - Requerir review para cambios crÃ­ticos
    - Auto-merge solo para updates de imagen
    - Branch protection en repo kubernetes/
  </Accordion>
  
  <Accordion title="âœ… 3. Manifiestos versionados">
    - Commits descriptivos
    - Tags semÃ¡nticos para releases
    - Changelog actualizado
  </Accordion>
  
  <Accordion title="âœ… 4. Secrets externalizados">
    - Nunca commitear secrets en Git
    - Usar Sealed Secrets o External Secrets
    - Secrets solo en valores cifrados
  </Accordion>
  
  <Accordion title="âœ… 5. ValidaciÃ³n automÃ¡tica">
    - CI valida manifiestos antes del merge
    - kubectl dry-run
    - Tests unitarios de estructura
  </Accordion>
</AccordionGroup>

## MÃ©tricas GitOps

<CardGroup cols={2}>
  <Card title="Tiempo a ProducciÃ³n" icon="rocket">
    **8-12 minutos**
    
    Desde commit hasta producciÃ³n
  </Card>
  
  <Card title="Frecuencia de Deploy" icon="calendar">
    **10-15 deploys/dÃ­a**
    
    Promedio entre todos los servicios
  </Card>
  
  <Card title="Tasa de Rollback" icon="rotate-left">
    **< 5%**
    
    Pocos deploys necesitan revertirse
  </Card>
  
  <Card title="MTTR" icon="clock">
    **< 5 minutos**
    
    Mean Time To Recovery
  </Card>
</CardGroup>

## PrÃ³ximos Pasos

<CardGroup cols={2}>
  <Card title="GitHub Actions" icon="github" href="/cicd/github-actions">
    ConfiguraciÃ³n de workflows
  </Card>
  
  <Card title="CI/CD Overview" icon="rocket" href="/cicd/overview">
    VisiÃ³n general del pipeline
  </Card>
  
  <Card title="Monitoreo" icon="chart-line" href="/infrastructure/monitoring">
    Observabilidad del sistema
  </Card>
  
  <Card title="Servicios" icon="cubes" href="/services/auth-service">
    DocumentaciÃ³n de microservicios
  </Card>
</CardGroup>
