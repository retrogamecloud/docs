---
title: Testing y QA
description: 'Estrategia completa de testing para RetroGameCloud: unitarios, integración, E2E y proceso de QA'
icon: flask-vial
---

# Testing y QA

RetroGameCloud implementa una estrategia de testing integral que abarca desde pruebas unitarias hasta tests end-to-end, garantizando la calidad y fiabilidad de la plataforma de juegos retro.

## Estrategia de Testing

### Pirámide de Testing

```mermaid
graph TD
    A[Tests E2E - Playwright] --> B[Tests Integración - Supertest]
    B --> C[Tests Unitarios - Jest]
    C --> D[Tests de Carga - k6]

    style A fill:#ff6b6b
    style B fill:#4ecdc4
    style C fill:#45b7d1
    style D fill:#96ceb4
```

## Tests Unitarios

### Configuración con Jest

Los tests unitarios se ejecutan con **Jest** y deben mantener un **coverage superior al 80%**.

<Tabs>
  <Tab title="package.json">
    ```json
    {
      "scripts": {
        "test": "jest",
        "test:watch": "jest --watch",
        "test:coverage": "jest --coverage",
        "test:ci": "jest --coverage --watchAll=false"
      },
      "jest": {
        "testEnvironment": "node",
        "collectCoverageFrom": [
          "src/**/*.{js,ts}",
          "!src/**/*.test.{js,ts}",
          "!src/config/**"
        ],
        "coverageThreshold": {
          "global": {
            "branches": 80,
            "functions": 80,
            "lines": 80,
            "statements": 80
          }
        }
      }
    }
    ```
  </Tab>

  <Tab title="jest.config.js">
    ```javascript
    module.exports = {
      preset: 'ts-jest',
      testEnvironment: 'node',
      roots: ['<rootDir>/src'],
      testMatch: ['**/__tests__/**/*.test.(ts|js)'],
      collectCoverageFrom: [
        'src/**/*.{ts,js}',
        '!src/**/*.d.ts',
        '!src/types/**',
        '!src/config/**'
      ],
      setupFilesAfterEnv: ['<rootDir>/src/test/setup.ts']
    };
    ```
  </Tab>
</Tabs>

### Ejemplo de Test Unitario

```javascript
// src/services/__tests__/authService.test.ts
import { AuthService } from '../authService';
import { UserRepository } from '../../repositories/userRepository';
import { JWTService } from '../jwtService';

describe('AuthService', () => {
  let authService: AuthService;
  let mockUserRepository: jest.Mocked<UserRepository>;
  let mockJWTService: jest.Mocked<JWTService>;

  beforeEach(() => {
    mockUserRepository = createMockUserRepository();
    mockJWTService = createMockJWTService();
    authService = new AuthService(mockUserRepository, mockJWTService);
  });

  describe('authenticateUser', () => {
    it('should return JWT token for valid credentials', async () => {
      // Given
      const credentials = { email: 'test@example.com', password: 'password123' };
      const mockUser = { id: '1', email: 'test@example.com', hashedPassword: 'hashed' };
      
      mockUserRepository.findByEmail.mockResolvedValue(mockUser);
      mockJWTService.generateToken.mockReturnValue('jwt-token');

      // When
      const result = await authService.authenticateUser(credentials);

      // Then
      expect(result.token).toBe('jwt-token');
      expect(mockUserRepository.findByEmail).toHaveBeenCalledWith('test@example.com');
    });
  });
});
```

## Tests de Integración

### Configuración con Supertest

Los tests de integración validan la interacción entre componentes y endpoints de API.

```javascript
// src/integration/__tests__/auth.integration.test.ts
import request from 'supertest';
import { app } from '../../app';
import { setupTestDatabase, teardownTestDatabase } from '../helpers/database';

describe('Authentication Integration', () => {
  beforeAll(async () => {
    await setupTestDatabase();
  });

  afterAll(async () => {
    await teardownTestDatabase();
  });

  describe('POST /api/auth/login', () => {
    it('should authenticate user and return JWT', async () => {
      // Given
      const userData = {
        email: 'player@retrogame.com',
        password: 'SecurePass123!'
      };

      // When
      const response = await request(app)
        .post('/api/auth/login')
        .send(userData)
        .expect(200);

      // Then
      expect(response.body).toHaveProperty('token');
      expect(response.body).toHaveProperty('user');
      expect(response.body.user.email).toBe(userData.email);
    });
  });
});
```

# Tests End-to-End

## Herramientas

### Playwright para Tests de Interfaz

Playwright nos permite ejecutar tests E2E en múltiples navegadores con alta confiabilidad.

### Newman para Tests de API

Newman ejecuta collections de Postman para validar la API de forma automatizada.

<Tabs>
  <Tab title="playwright.config.ts">
    ```typescript
    import { defineConfig, devices } from '@playwright/test';

    export default defineConfig({
      testDir: './e2e',
      fullyParallel: true,
      forbidOnly: !!process.env.CI,
      retries: process.env.CI ? 2 : 0,
      workers: process.env.CI ? 1 : undefined,
      reporter: 'html',
      use: {
        baseURL: 'http://localhost:3000',
        trace: 'on-first-retry',
      },
      projects: [
        {
          name: 'chromium',
          use: { ...devices['Desktop Chrome'] },
        },
        {
          name: 'firefox',
          use: { ...devices['Desktop Firefox'] },
        },
      ],
      webServer: {
        command: 'npm run dev',
        url: 'http://localhost:3000',
        reuseExistingServer: !process.env.CI,
      },
    });
    ```
  </Tab>

  <Tab title="newman-config.json">
    ```json
    {
      "collection": "./postman/RetroGameCloud-API.json",
      "environment": "./postman/environments/test.json",
      "reporters": ["cli", "junit"],
      "reporter": {
        "junit": {
          "export": "./test-results/newman-results.xml"
        }
      },
      "bail": true,
      "color": "on"
    }
    ```
  </Tab>
</Tabs>

## Escenarios Críticos

### E2E-001: Flujo Completo de Jugador

<Callout type="info">
**Test crítico para validar la experiencia completa del usuario**
</Callout>

```typescript
// e2e/complete-player-flow.spec.ts
import { test, expect } from '@playwright/test';

test('E2E-001: Complete Player Journey', async ({ page }) => {
  // 1. Registro de usuario nuevo
  await page.goto('/register');
  await page.fill('[data-testid="email"]', 'newplayer@test.com');
  await page.fill('[data-testid="password"]', 'SecurePass123!');
  await page.fill('[data-testid="username"]', 'RetroGamer2024');
  await page.click('[data-testid="register-button"]');
  
  await expect(page.locator('[data-testid="success-message"]')).toBeVisible();

  // 2. Login y obtención de JWT
  await page.goto('/login');
  await page.fill('[data-testid="email"]', 'newplayer@test.com');
  await page.fill('[data-testid="password"]', 'SecurePass123!');
  await page.click('[data-testid="login-button"]');
  
  await expect(page.locator('[data-testid="user-menu"]')).toBeVisible();

  // 3. Listar catálogo de juegos
  await page.goto('/games');
  await expect(page.locator('[data-testid="games-grid"]')).toBeVisible();
  
  const gameCount = await page.locator('[data-testid="game-card"]').count();
  expect(gameCount).toBeGreaterThan(0);

  // 4. Cargar juego con js-dos
  await page.click('[data-testid="game-card"]:first-child');
  await expect(page.locator('[data-testid="dosbox-canvas"]')).toBeVisible();
  
  // Wait for game to load
  await page.waitForSelector('[data-testid="game-loaded"]', { timeout: 30000 });

  // 5. Guardar puntuación
  await page.click('[data-testid="submit-score"]');
  await page.fill('[data-testid="score-input"]', '15000');
  await page.click('[data-testid="save-score-button"]');
  
  await expect(page.locator('[data-testid="score-saved"]')).toBeVisible();

  // 6. Verificar aparición en ranking
  await page.goto('/leaderboard');
  const playerScore = page.locator(`[data-testid="score-entry-RetroGamer2024"]`);
  await expect(playerScore).toBeVisible();
  await expect(playerScore.locator('[data-testid="score"]')).toContainText('15000');
});
```

### E2E-002: Flujo de Autenticación OAuth2

```typescript
// e2e/oauth-authentication.spec.ts
import { test, expect } from '@playwright/test';

test('E2E-002: OAuth2 Authentication Flow', async ({ page, context }) => {
  // 1. Inicio de sesión con Google
  await page.goto('/login');
  
  // Mock Google OAuth for testing
  await context.route('**/auth/google', route => {
    route.fulfill({
      status: 302,
      headers: {
        'Location': '/auth/google/callback?code=mock_auth_code&state=mock_state'
      }
    });
  });

  await page.click('[data-testid="google-login-button"]');

  // 2. Callback y generación de JWT
  await expect(page).toHaveURL(/.*\/dashboard/);
  
  // Verify JWT token is stored
  const token = await page.evaluate(() => localStorage.getItem('auth_token'));
  expect(token).toBeTruthy();

  // 3. Acceso a recursos protegidos
  await page.goto('/profile');
  await expect(page.locator('[data-testid="user-profile"]')).toBeVisible();
  
  // Verify API calls include JWT
  const [request] = await Promise.all([
    page.waitForRequest('**/api/user/profile'),
    page.reload()
  ]);
  
  expect(request.headers().authorization).toContain('Bearer');
});
```

### E2E-003: Validación de Rendimiento de Juegos

```typescript
// e2e/game-performance.spec.ts
import { test, expect } from '@playwright/test';

test('E2E-003: Game Performance Validation', async ({ page }) => {
  await page.goto('/games/pac-man');
  
  // Start performance monitoring
  await page.coverage.startJSCoverage();
  const startTime = Date.now();
  
  // Wait for game initialization
  await page.waitForSelector('[data-testid="dosbox-canvas"]');
  await page.waitForSelector('[data-testid="game-loaded"]', { timeout: 15000 });
  
  const loadTime = Date.now() - startTime;
  
  // Verify game loads within acceptable time
  expect(loadTime).toBeLessThan(10000); // 10 seconds max
  
  // Check memory usage
  const metrics = await page.evaluate(() => {
    return {
      memory: (performance as any).memory?.usedJSHeapSize || 0,
      timing: performance.timing.loadEventEnd - performance.timing.navigationStart
    };
  });
  
  expect(metrics.memory).toBeLessThan(100 * 1024 * 1024); // Less than 100MB
});
```

## Ejecución en CI

Los tests E2E se ejecutan en GitHub Actions contra un cluster efímero de Kubernetes con servicios mock.

<Tabs>
  <Tab title="github-actions-e2e.yml">
    ```yaml
    name: E2E Tests

    on:
      pull_request:
        branches: [main, develop]
      push:
        branches: [main]

    jobs:
      e2e-tests:
        runs-on: ubuntu-latest
        
        services:
          redis:
            image: redis:7
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
          
          postgres:
            image: postgres:15
            env:
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: retrogame_test
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5

        steps:
          - uses: actions/checkout@v4
          
          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: '18'
              cache: 'npm'
          
          - name: Install dependencies
            run: npm ci
          
          - name: Setup test database
            run: |
              npm run db:migrate:test
              npm run db:seed:test
            env:
              DATABASE_URL: postgresql://postgres:postgres@localhost:5432/retrogame_test
          
          - name: Install Playwright
            run: npx playwright install --with-deps
          
          - name: Start application
            run: |
              npm run build
              npm start &
              sleep 10
            env:
              NODE_ENV: test
              DATABASE_URL: postgresql://postgres:postgres@localhost:5432/retrogame_test
              REDIS_URL: redis://localhost:6379
          
          - name: Run E2E tests
            run: npx playwright test
          
          - name: Run API tests with Newman
            run: npx newman run ./postman/RetroGameCloud-API.json -e ./postman/environments/ci.json
          
          - name: Upload test results
            uses: actions/upload-artifact@v4
            if: always()
            with:
              name: e2e-results
              path: |
                playwright-report/
                test-results/
                newman-results.xml
    ```
  </Tab>

  <Tab title="docker-compose.test.yml">
    ```yaml
    version: '3.8'
    
    services:
      app-test:
        build:
          context: .
          dockerfile: Dockerfile.test
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=test
          - DATABASE_URL=postgresql://postgres:postgres@db-test:5432/retrogame_test
          - REDIS_URL=redis://redis-test:6379
        depends_on:
          - db-test
          - redis-test
        volumes:
          - ./test-results:/app/test-results
      
      db-test:
        image: postgres:15
        environment:
          POSTGRES_DB: retrogame_test
          POSTGRES_PASSWORD: postgres
        ports:
          - "5432:5432"
    ```
  </Tab>
</Tabs>