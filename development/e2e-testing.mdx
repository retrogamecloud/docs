---
title: 8.2. Tests End-to-End
description: Estrategia completa de testing E2E para validar flujos críticos de usuario
  en RetroGameCloud
icon: play
---

# Tests End-to-End

Los tests End-to-End (E2E) validan los flujos completos de usuario en RetroGameCloud, asegurando que todos los microservicios funcionen correctamente en conjunto desde la perspectiva del usuario final.

<Note>
Los tests E2E son ejecutados automáticamente en cada pull request y deployment, proporcionando confianza en la estabilidad del sistema completo.
</Note>

## Herramientas Utilizadas

<Tabs>
<Tab title="Playwright">

* *Playwright** es nuestra herramienta principal para tests de interfaz de usuario:

- Tests en múltiples navegadores (Chrome, Firefox, Safari)

- Paralelización automática

- Screenshots y videos en caso de fallos

- API robusta para interacciones complejas

```bash
npm install @playwright/test
npx playwright install

```

### Configuración Playwright

```javascript
// playwright.config.js
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['junit', { outputFile: 'test-results/junit.xml' }],
    ['allure-playwright']
  ],
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});

```

</Tab>
<Tab title="Cypress">

* *Cypress** como alternativa para casos específicos:

- Debugging visual interactivo

- Time travel debugging

- Network stubbing avanzado

```bash
npm install cypress --save-dev
npx cypress open

```

### Configuración Cypress

```javascript
// cypress.config.js
import { defineConfig } from 'cypress'

export default defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3000',
    supportFile: 'cypress/support/e2e.js',
    specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',
    viewportWidth: 1280,
    viewportHeight: 720,
    video: true,
    screenshotOnRunFailure: true,
    setupNodeEvents(on, config) {
      // Plugins aquí
    },
    env: {
      API_URL: 'http://localhost:8080/api',
      AUTH0_DOMAIN: 'retrogame-dev.auth0.com',
    }
  },
})

```

</Tab>
<Tab title="Newman">

* *Newman** ejecuta nuestras colecciones de Postman para validar APIs:

- Validación de contratos de API

- Tests de integración entre servicios

- Verificación de flujos OAuth2

```bash
npm install -g newman
newman run postman-collection.json -e environment.json

```

</Tab>
</Tabs>

## Escenarios Críticos

### E2E-001: Flujo Completo de Jugador

<Card title="Flujo de Usuario Nuevo" icon="user-plus">
Este test valida el ciclo completo desde el registro hasta la aparición en el ranking.
</Card>

#### Pasos del Test

1. **Registro de Usuario Nuevo**
   ```javascript
   await page.goto('/register');
   await page.fill('[data-testid="username"]', 'testuser');
   await page.fill('[data-testid="email"]', 'test@example.com');
   await page.fill('[data-testid="password"]', 'SecurePass123!');
   await page.click('[data-testid="register-button"]');
   ```

2. **Login y Obtención de JWT**
   ```javascript
   await page.goto('/login');
   await page.fill('[data-testid="email"]', 'test@example.com');
   await page.fill('[data-testid="password"]', 'SecurePass123!');
   await page.click('[data-testid="login-button"]');

   // Verificar redirección exitosa
   await expect(page).toHaveURL('/dashboard');
   ```

3. **Navegación al Catálogo**
   ```javascript
   await page.click('[data-testid="games-menu"]');
   await page.waitForSelector('[data-testid="game-card"]');

   // Verificar carga de juegos
   const gameCount = await page.locator('[data-testid="game-card"]').count();
   expect(gameCount).toBeGreaterThan(0);
   ```

4. **Iniciar Juego**
   ```javascript
   await page.click('[data-testid="game-card"]:first-child');
   await page.click('[data-testid="play-button"]');

   // Esperar carga del emulador
   await page.waitForSelector('[data-testid="emulator-canvas"]');
   ```

5. **Completar Nivel y Verificar Score**
   ```javascript
   // Simular gameplay (usando eventos de teclado)
   await page.keyboard.press('ArrowRight');
   await page.keyboard.press('Space');

   // Esperar actualización de score
   await page.waitForFunction(() => {
     const scoreElement = document.querySelector('[data-testid="score"]');
     return scoreElement && parseInt(scoreElement.textContent) > 0;
   });
   ```

### E2E-002: Sistema de Pagos

<Card title="Compra de Créditos" icon="credit-card">
Valida el flujo completo de compra desde la selección hasta la confirmación.
</Card>

```javascript
test('flujo completo de compra', async ({ page }) => {
  // Setup: Usuario logueado
  await loginUser(page, 'buyer@test.com', 'password');

  // Navegar a tienda
  await page.click('[data-testid="store-menu"]');

  // Seleccionar paquete de créditos
  await page.click('[data-testid="credits-package-100"]');
  await page.click('[data-testid="buy-now-button"]');

  // Completar información de pago
  await page.fill('[data-testid="card-number"]', '4242424242424242');
  await page.fill('[data-testid="expiry"]', '12/25');
  await page.fill('[data-testid="cvc"]', '123');

  // Procesar pago
  await page.click('[data-testid="pay-button"]');

  // Verificar confirmación
  await expect(page.locator('[data-testid="payment-success"]')).toBeVisible();

  // Verificar actualización de créditos
  const creditsBalance = await page.locator('[data-testid="credits-balance"]').textContent();
  expect(parseInt(creditsBalance)).toBeGreaterThanOrEqual(100);
});

```

### E2E-003: Sistema de Ranking

<Card title="Actualización de Rankings" icon="trophy">
Verifica que los scores se reflejen correctamente en los rankings globales.
</Card>

```javascript
test('actualización de ranking tras nuevo score', async ({ page }) => {
  // Obtener ranking inicial
  await page.goto('/rankings');
  const initialRanking = await page.locator('[data-testid="ranking-position"]').first().textContent();

  // Jugar y conseguir nuevo high score
  await playGameAndAchieveScore(page, 'pac-man', 15000);

  // Verificar actualización en tiempo real
  await page.goto('/rankings');
  await page.waitForFunction((expectedScore) => {
    const topScore = document.querySelector('[data-testid="top-score"]');
    return topScore && parseInt(topScore.textContent) >= expectedScore;
  }, 15000);

  // Verificar notificación de nuevo record
  await expect(page.locator('[data-testid="new-record-notification"]')).toBeVisible();
});

```

## Tests por Microservicio

### User Service Tests

<Tabs>
<Tab title="Registro y Autenticación">

```javascript
// tests/services/user-service.e2e.js
describe('User Service E2E', () => {
  test('registro completo con validaciones', async ({ page }) => {
    await page.goto('/register');

    // Test validaciones frontend
    await page.click('[data-testid="register-button"]');
    await expect(page.locator('[data-testid="username-error"]')).toContainText('Username is required');

    // Test usuario duplicado
    await fillRegistrationForm(page, {
      username: 'existinguser',
      email: 'existing@test.com',
      password: 'Password123!'
    });

    await expect(page.locator('[data-testid="error-message"]')).toContainText('User already exists');

    // Test registro exitoso
    await fillRegistrationForm(page, {
      username: 'newuser' + Date.now(),
      email: `new${Date.now()}@test.com`,
      password: 'Password123!'
    });

    await expect(page).toHaveURL('/dashboard');
  });

  test('flujo de recuperación de contraseña', async ({ page }) => {
    await page.goto('/forgot-password');
    await page.fill('[data-testid="email"]', 'test@example.com');
    await page.click('[data-testid="send-reset-button"]');

    await expect(page.locator('[data-testid="success-message"]')).toContainText('Reset link sent');

    // Verificar email enviado (usando mail service mock)
    const emailSent = await checkEmailSent('test@example.com', 'Password Reset');
    expect(emailSent).toBe(true);
  });
});

```

</Tab>
<Tab title="Gestión de Perfiles">

```javascript
test('actualización de perfil completa', async ({ page }) => {
  await loginUser(page, 'testuser@test.com');

  await page.goto('/profile');

  // Actualizar información básica
  await page.fill('[data-testid="display-name"]', 'New Display Name');
  await page.fill('[data-testid="bio"]', 'Updated bio information');

  // Cambiar avatar
  await page.setInputFiles('[data-testid="avatar-upload"]', 'test-assets/avatar.png');
  await page.waitForSelector('[data-testid="avatar-preview"]');

  // Guardar cambios
  await page.click('[data-testid="save-profile-button"]');

  // Verificar persistencia
  await page.reload();
  await expect(page.locator('[data-testid="display-name"]')).toHaveValue('New Display Name');
});

```

</Tab>
</Tabs>

### Game Service Tests

<Tabs>
<Tab title="Catálogo y Búsqueda">

```javascript
describe('Game Service E2E', () => {
  test('navegación y filtrado de catálogo', async ({ page }) => {
    await page.goto('/games');

    // Verificar carga inicial
    await page.waitForSelector('[data-testid="game-grid"]');
    const initialGameCount = await page.locator('[data-testid="game-card"]').count();
    expect(initialGameCount).toBeGreaterThan(0);

    // Test filtro por plataforma
    await page.click('[data-testid="platform-filter"]');
    await page.click('[data-testid="platform-nes"]');

    await page.waitForFunction(() => {
      const games = document.querySelectorAll('[data-testid="game-platform"]');
      return Array.from(games).every(game => game.textContent === 'NES');
    });

    // Test búsqueda
    await page.fill('[data-testid="search-input"]', 'Mario');
    await page.keyboard.press('Enter');

    await page.waitForSelector('[data-testid="search-results"]');
    const searchResults = await page.locator('[data-testid="game-title"]').allTextContents();
    searchResults.forEach(title => {
      expect(title.toLowerCase()).toContain('mario');
    });
  });

  test('carga y configuración de juego', async ({ page }) => {
    await loginUser(page, 'gamer@test.com');

    await page.goto('/games/super-mario-bros');

    // Verificar información del juego
    await expect(page.locator('[data-testid="game-title"]')).toContainText('Super Mario Bros');
    await expect(page.locator('[data-testid="game-platform"]')).toContainText('NES');

    // Configurar controles
    await page.click('[data-testid="controls-settings"]');
    await page.click('[data-testid="key-mapping-jump"]');
    await page.keyboard.press('Space');
    await page.click('[data-testid="save-controls"]');

    // Iniciar juego
    await page.click('[data-testid="play-button"]');

    // Verificar carga del emulador
    await page.waitForSelector('[data-testid="emulator-canvas"]', { timeout: 10000 });
    await page.waitForFunction(() => {
      const canvas = document.querySelector('[data-testid="emulator-canvas"]');
      return canvas && canvas.width > 0 && canvas.height > 0;
    });
  });
});

```

</Tab>
<Tab title="Sistema de Guardado">

```javascript
test('guardado y carga de partidas', async ({ page }) => {
  await loginUser(page, 'gamer@test.com');

  // Iniciar juego
  await page.goto('/games/zelda');
  await page.click('[data-testid="play-button"]');
  await page.waitForSelector('[data-testid="emulator-canvas"]');

  // Simular progreso en el juego
  await simulateGameplay(page, 30000); // 30 segundos de juego

  // Guardar partida
  await page.keyboard.press('Escape');
  await page.click('[data-testid="save-game-button"]');
  await page.fill('[data-testid="save-name"]', 'Test Save 1');
  await page.click('[data-testid="confirm-save"]');

  await expect(page.locator('[data-testid="save-success"]')).toBeVisible();

  // Verificar guardado en lista
  await page.goto('/saves');
  await expect(page.locator('[data-testid="save-item"]')).toContainText('Test Save 1');

  // Cargar partida
  await page.click('[data-testid="load-
</Tab>
</Tab>
</Tab>
</Tabs>

```
