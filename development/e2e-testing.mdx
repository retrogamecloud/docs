---
title: 8.2. Tests End-to-End
description: Estrategia completa de testing E2E para validar flujos cr铆ticos de usuario en RetroGameCloud
icon: play
---

# Tests End-to-End

Los tests End-to-End (E2E) validan los flujos completos de usuario en RetroGameCloud, asegurando que todos los microservicios funcionen correctamente en conjunto desde la perspectiva del usuario final.

<Note>
Los tests E2E son ejecutados autom谩ticamente en cada pull request y deployment, proporcionando confianza en la estabilidad del sistema completo.
</Note>

## Estrategia Global de Testing

### Pir谩mide de Testing

<Tabs>
<Tab title="Distribuci贸n">
```
       E2E (10%)
     吼 Integration (20%)
   吼吼吼 Unit Tests (70%)
```

- **70% Tests Unitarios**: L贸gica de negocio, funciones puras
- **20% Tests de Integraci贸n**: APIs, base de datos, servicios
- **10% Tests E2E**: Flujos cr铆ticos de usuario
</Tab>

<Tab title="Cobertura Objetivo">
```javascript
// jest.config.js
module.exports = {
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    },
    './src/services/': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  }
}
```
</Tab>
</Tabs>

## Stack Tecnol贸gico

<CardGroup cols={3}>
<Card title="Playwright" icon="browser">
Tests E2E multiplataforma
Capturas autom谩ticas
Paralelizaci贸n
</Card>

<Card title="Jest + Supertest" icon="gear">
Tests unitarios backend
Tests de API
Mocking avanzado
</Card>

<Card title="Cypress" icon="eye">
Tests E2E interactivos
Time travel debugging
Grabaci贸n visual
</Card>
</CardGroup>

## Herramientas y Configuraci贸n

<Tabs>
<Tab title="Playwright">
**Playwright** es nuestra herramienta principal para tests de interfaz de usuario:

- Tests en m煤ltiples navegadores (Chrome, Firefox, Safari)
- Paralelizaci贸n autom谩tica
- Screenshots y videos en caso de fallos
- API robusta para interacciones complejas

```javascript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  timeout: 30 * 1000,
  expect: { timeout: 5000 },
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [['html'], ['json', { outputFile: 'test-results.json' }]],
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    trace: 'on-first-retry',
    video: 'retain-on-failure',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
});
```
</Tab>

<Tab title="Newman/Postman">
**Newman** ejecuta nuestras colecciones de Postman para validar APIs:

- Validaci贸n de contratos de API
- Tests de integraci贸n entre servicios
- Verificaci贸n de flujos OAuth2

```bash
# Instalaci贸n
npm install -g newman newman-reporter-htmlextra

# Ejecuci贸n con reporte
newman run collections/retrogamecloud.postman_collection.json \
  -e environments/staging.postman_environment.json \
  --reporters cli,htmlextra \
  --reporter-htmlextra-export reports/newman-report.html
```

```javascript
// Ejemplo de test en Postman
pm.test("User registration creates valid JWT", function () {
    const responseJson = pm.response.json();
    pm.expect(responseJson).to.have.property('token');
    pm.expect(responseJson.token).to.match(/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/);
    pm.globals.set("auth_token", responseJson.token);
});
```
</Tab>

<Tab title="k6 Performance">
**k6** para tests de carga y performance:

```javascript
// load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  vus: 10, // 10 virtual users
  duration: '30s',
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95% bajo 500ms
    http_req_failed: ['rate<0.1'], // Error rate bajo 10%
  },
};

export default function() {
  const response = http.get('https://api.retrogamecloud.com/health');
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  sleep(1);
}
```
</Tab>
</Tabs>

## Escenarios Cr铆ticos

### E2E-001: Flujo Completo de Jugador

<Card title="Flujo de Usuario Nuevo" icon="user-plus">
Este test valida el ciclo completo desde el registro hasta la aparici贸n en el ranking.
</Card>

#### Configuraci贸n de Datos de Prueba

```javascript
// fixtures/user-data.js
export const testUsers = {
  newPlayer: {
    username: `testuser_${Date.now()}`,
    email: `test_${Date.now()}@example.com`,
    password: 'SecurePass123!',
    profile: {
      preferredGenre: 'platformer',
      region: 'EU'
    }
  },
  premiumPlayer: {
    username: 'premium_user',
    email: 'premium@example.com',
    password: 'Premium123!',
    subscription: 'premium'
  }
};

export const testGames = {
  marioBros: {
    id: 'mario-bros-1985',
    title: 'Super Mario Bros',
    platform: 'nes',
    category: 'platformer'
  }
};
```

#### Pasos del Test

<Tabs>
<Tab title="1. Registro">
```javascript
// e2e/user-journey.spec.ts
import { test, expect } from '@playwright/test';
import { testUsers } from '../fixtures/user-data';

test('Complete player journey', async ({ page, context }) => {
  // Setup: Clear any existing data
  await context.clearCookies();
  
  // 1. Register new user
  await page.goto('/register');
  
  await page.fill('[data-testid="username"]', testUsers.newPlayer.username);
  await page.fill('[data-testid="email"]', testUsers.newPlayer.email);
  await page.fill('[data-testid="password"]', testUsers.newPlayer.password);
  await page.selectOption('[data-testid="region"]', testUsers.newPlayer.profile.region);
  
  await page.click('[data-testid="register-button"]');
  
  // Verify registration success
  await expect(page.locator('[data-testid="welcome-message"]')).toBeVisible();
  await expect(page.locator('[data-testid="user-profile"]')).toContainText(testUsers.newPlayer.username);
});
```
</Tab>

<Tab title="2. Login y JWT">
```javascript
test('Login and JWT validation', async ({ page }) => {
  await page.goto('/login');
  
  await page.fill('[data-testid="email"]', testUsers.newPlayer.email);
  await page.fill('[data-testid="password"]', testUsers.newPlayer.password);
  await page.click('[data-testid="login-button"]');
  
  // Wait for redirect to dashboard
  await page.waitForURL('/dashboard');
  
  // Verify JWT token in localStorage
  const token = await page.evaluate(() => localStorage.getItem('auth_token'));
  expect(token).toBeTruthy();
  
  // Verify token structure (JWT format)
  expect(token).toMatch(/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/);
  
  // Verify authenticated state
  await expect(page.locator('[data-testid="user-menu"]')).toBeVisible();
});
```
</Tab>

<Tab title="3. Gameplay">
```javascript
test('Game launch and score submission', async ({ page }) => {
  // Navigate to game library
  await page.goto('/games');
  
  // Search and select game
  await page.fill('[data-testid="game-search"]', 'Super Mario Bros');
  await page.click(`[data-testid="game-card-${testGames.marioBros.id}"]`);
  
  // Launch game
  await page.click('[data-testid="play-button"]');
  
  // Wait for game to load
  await expect(page.locator('[data-testid="game-canvas"]')).toBeVisible();
  await page.waitForTimeout(2000); // Game loading time
  
  // Simulate gameplay (mock score)
  await page.evaluate(() => {
    // Mock game completion
    window.gameEngine.submitScore(15500, { level: 3, lives: 2 });
  });
  
  // Verify score submission
  await expect(page.locator('[data-testid="score-popup"]')).toBeVisible();
  await expect(page.locator('[data-testid="final-score"]')).toContainText('15,500');
});
```
</Tab>

<Tab title="4. Ranking">
```javascript
test('Score appears in ranking', async ({ page }) => {
  // Navigate to leaderboards
  await page.goto('/leaderboards');
  
  // Filter by game
  await page.selectOption('[data-testid="game-filter"]', testGames.marioBros.id);
  
  // Wait for leaderboard to update
  await page.waitForResponse('**/api/leaderboards/**');
  
  // Verify user appears in ranking
  const userRankingEntry = page.locator(`[data-testid="ranking-entry-${testUsers.newPlayer.username}"]`);
  await expect(userRankingEntry).toBeVisible();
  await expect(userRankingEntry.locator('[data-testid="score"]')).toContainText('15,500');
  
  // Verify ranking position
  const position = await userRankingEntry.locator('[data-testid="position"]').textContent();
  expect(parseInt(position)).toBeGreaterThan(0);
});
```
</Tab>
</Tabs>

### E2E-002: Flujo de Suscripci贸n Premium

<Card title="Premium Upgrade" icon="star">
Valida la actualizaci贸n a premium y acceso a contenido exclusivo.
</Card>

```javascript
test('Premium subscription flow', async ({ page }) => {
  // Login as regular user
  await loginAsUser(page, testUsers.newPlayer);
  
  // Navigate to premium page
  await page.goto('/premium');
  
  // Select premium plan
  await page.click('[data-testid="premium-plan-monthly"]');
  
  // Fill payment information (using test card)
  await page.fill('[data-testid="card-number"]', '4242424242424242');
  await page.fill('[data-testid="card-expiry"]', '12/25');
  await page.fill('[data-testid="card-cvc"]', '123');
  
  // Submit payment
  await page.click('[data-testid="subscribe-button"]');
  
  // Wait for payment processing
  await page.waitForURL('/premium/success');
  
  // Verify premium status
  await expect(page.locator('[data-testid="premium-badge"]')).toBeVisible();
  
  // Test premium feature access
  await page.goto('/games/premium');
  await expect(page.locator('[data-testid="premium-games"]')).toBeVisible();
  
  // Verify no paywall
  await expect(page.locator('[data-testid="paywall"]')).not.toBeVisible();
});
```

## Estrategias de Testing

### Mocking y Datos de Prueba

<Tabs>
<Tab title="API Mocking">
```javascript
// utils/api-mocks.ts
import { Page } from '@playwright/test';

export async function mockExternalAPIs(page: Page) {
  // Mock payment gateway
  await page.route('**/api/payments/**', async (route) => {
    if (route.request().method() === 'POST') {
      await route.fulfill({
        status: 200,
        contentType: 'application/json',
        body: JSON.stringify({
          success: true,
          transactionId: 'test_tx_123',
          status: 'completed'
        })
      });
    }
  });
  
  // Mock game analytics
  await page.route('**/api/analytics/**', async (route) => {
    await route.fulfill({
      status: 200,
      contentType: 'application/json',
      body: JSON.stringify({ received: true })
    });
  });
}
```
</Tab>

<Tab title="Database Fixtures">
```javascript
// fixtures/database-setup.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export async function setupTestDatabase() {
  // Clean existing test data
  await prisma.score.deleteMany({ where: { user: { email: { contains: 'test' } } } });
  await prisma.user.deleteMany({ where: { email: { contains: 'test' } } });
  
  // Create test games
  await prisma.game.createMany({
    data: [
      {
        id: 'mario-bros-1985',
        title: 'Super Mario Bros',
        platform: 'nes',
        category: 'platformer',
        available: true
      },
      {
        id: 'tetris-1984',
        title: 'Tetris',
        platform: 'gameboy',
        category: 'puzzle',
        available: true,
        premiumOnly: true
      }
    ],
    skipDuplicates: true
  });
}

export async function teardownTestDatabase() {
  await prisma.score.deleteMany({ where: { user: { email: { contains: 'test' } } } });
  await prisma.user.deleteMany({ where: { email: { contains: 'test' } } });
}
```
</Tab>
</Tabs>

### Tests de Contrato

```javascript
// contract-tests/user-service.pact.js
import { Pact } from '@pact-foundation/pact';
import { like, eachLike } from '@pact-foundation/pact/dsl';

const provider = new Pact({
  consumer: 'web-frontend',
  provider: 'user-service',
  port: 1234,
  log: path.resolve(process.cwd(), 'logs', 'pact.log'),
  dir: path.resolve(process.cwd(), 'pacts'),
  logLevel: 'INFO',
});

describe
```