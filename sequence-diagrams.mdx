---
title: 2.2. Diagramas de Secuencia
description: Diagramas de flujo detallados de los procesos clave del sistema
icon: file-lines
---

# üîÑ Diagramas de Secuencia

Diagramas detallados que muestran el flujo de datos entre componentes para los procesos m√°s importantes de Retro Game Hub.

---

## üîê Flujo de Autenticaci√≥n

### Registro de Usuario

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant AuthService
    participant DB
    participant Redis

    Usuario->>Frontend: Completa formulario registro
    Frontend->>Frontend: Validaci√≥n cliente<br/>(username 3-20 chars,<br/>email v√°lido, password 6+)

    Frontend->>Kong: POST /auth/register<br/>{username, email, password}

    Kong->>Kong: Rate Limiting<br/>(5 req/hora)

    Kong->>AuthService: Forward request

    AuthService->>AuthService: Validaci√≥n servidor

    AuthService->>DB: SELECT username, email<br/>FROM users<br/>WHERE username=? OR email=?

    alt Usuario ya existe
        DB-->>AuthService: Usuario encontrado
        AuthService-->>Kong: 409 Conflict
        Kong-->>Frontend: Error: Usuario existe
        Frontend-->>Usuario: Mostrar mensaje error
    else Usuario nuevo
        DB-->>AuthService: No encontrado

        AuthService->>AuthService: Hash password<br/>(bcrypt, 10 rounds)

        AuthService->>DB: INSERT INTO users<br/>(username, email, password)
        DB-->>AuthService: userId generado

        AuthService->>AuthService: Generar JWT Token<br/>(userId, username, email)<br/>Expira: 24h

        AuthService->>Redis: SET session:userId<br/>TTL: 24h
        Redis-->>AuthService: OK

        AuthService-->>Kong: 201 Created<br/>{token, user}
        Kong-->>Frontend: Success response

        Frontend->>Frontend: Guardar token en localStorage
        Frontend-->>Usuario: Redirigir a /games.html
    end
```

### Login de Usuario

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant AuthService
    participant DB
    participant Redis

    Usuario->>Frontend: Completa formulario login
    Frontend->>Frontend: Validaci√≥n b√°sica<br/>(campos requeridos)

    Frontend->>Kong: POST /auth/login<br/>{email, password}

    Kong->>Kong: Rate Limiting<br/>(10 req/min)

    Kong->>AuthService: Forward request

    AuthService->>DB: SELECT id, username, password<br/>FROM users<br/>WHERE email=?

    alt Usuario no existe
        DB-->>AuthService: No encontrado
        AuthService-->>Kong: 401 Unauthorized
        Kong-->>Frontend: Error: Credenciales inv√°lidas
        Frontend-->>Usuario: Mostrar error
    else Usuario existe
        DB-->>AuthService: Datos usuario

        AuthService->>AuthService: Verificar password<br/>(bcrypt.compare)

        alt Password incorrecto
            AuthService-->>Kong: 401 Unauthorized
            Kong-->>Frontend: Error: Credenciales inv√°lidas
            Frontend-->>Usuario: Mostrar error
        else Password correcto
            AuthService->>AuthService: Generar JWT Token<br/>(userId, username, email)<br/>Expira: 24h

            AuthService->>Redis: SET session:userId<br/>TTL: 24h
            Redis-->>AuthService: OK

            AuthService-->>Kong: 200 OK<br/>{token, user}
            Kong-->>Frontend: Success response

            Frontend->>Frontend: Guardar token en localStorage
            Frontend-->>Usuario: Redirigir a /games.html
        end
    end
```

---

## üéÆ Flujo de Juegos

### Listado de Juegos

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant GameService
    participant DB
    participant Redis

    Usuario->>Frontend: Accede a /games.html

    Frontend->>Kong: GET /games?limit=20&offset=0

    Kong->>Kong: Rate Limiting<br/>(100 req/min)

    Kong->>GameService: Forward request

    GameService->>Redis: GET games:page:0
    
    alt Cache Hit
        Redis-->>GameService: Datos cacheados
        GameService-->>Kong: 200 OK<br/>{games, total}
    else Cache Miss
        Redis-->>GameService: null

        GameService->>DB: SELECT id, title, genre,<br/>release_year, rating<br/>FROM games<br/>LIMIT 20 OFFSET 0

        DB-->>GameService: Lista de juegos

        GameService->>Redis: SET games:page:0<br/>TTL: 1h
        Redis-->>GameService: OK

        GameService-->>Kong: 200 OK<br/>{games, total}
    end

    Kong-->>Frontend: Games data
    Frontend-->>Usuario: Mostrar grid de juegos
```

### Detalles de Juego

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant GameService
    participant DB
    participant Redis

    Usuario->>Frontend: Click en juego
    Frontend->>Kong: GET /games/{gameId}

    Kong->>GameService: Forward request

    GameService->>Redis: GET game:{gameId}

    alt Cache Hit
        Redis-->>GameService: Detalles cacheados
        GameService-->>Kong: 200 OK<br/>{game details}
    else Cache Miss
        Redis-->>GameService: null

        GameService->>DB: SELECT * FROM games<br/>WHERE id = ?

        alt Juego no existe
            DB-->>GameService: No encontrado
            GameService-->>Kong: 404 Not Found
            Kong-->>Frontend: Error
            Frontend-->>Usuario: Mostrar error 404
        else Juego existe
            DB-->>GameService: Detalles completos

            GameService->>Redis: SET game:{gameId}<br/>TTL: 2h
            Redis-->>GameService: OK

            GameService-->>Kong: 200 OK<br/>{game details}
        end
    end

    Kong-->>Frontend: Game details
    Frontend-->>Usuario: Mostrar p√°gina detalle
```

---

## ‚≠ê Flujo de Reviews

### Crear Review

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant ReviewService
    participant GameService
    participant DB
    participant Redis

    Usuario->>Frontend: Completa formulario review<br/>(rating 1-5, comment)

    Frontend->>Frontend: Validar token JWT<br/>y datos formulario

    Frontend->>Kong: POST /reviews<br/>{gameId, rating, comment}<br/>Header: Authorization

    Kong->>Kong: JWT Validation<br/>Rate Limit: 5/hour

    Kong->>ReviewService: Forward request

    ReviewService->>DB: SELECT id FROM reviews<br/>WHERE userId=? AND gameId=?

    alt Review ya existe
        DB-->>ReviewService: Review encontrada
        ReviewService-->>Kong: 409 Conflict
        Kong-->>Frontend: Error: Ya has reviewado
        Frontend-->>Usuario: Mostrar mensaje
    else Primera review
        DB-->>ReviewService: No encontrada

        ReviewService->>GameService: GET /games/{gameId}<br/>(verificar que existe)

        alt Juego no existe
            GameService-->>ReviewService: 404 Not Found
            ReviewService-->>Kong: 404 Not Found
            Kong-->>Frontend: Error: Juego no existe
            Frontend-->>Usuario: Mostrar error
        else Juego existe
            GameService-->>ReviewService: Game data

            ReviewService->>DB: INSERT INTO reviews<br/>(userId, gameId, rating, comment)
            DB-->>ReviewService: reviewId generado

            ReviewService->>DB: UPDATE games SET<br/>avg_rating = (SELECT AVG(rating)<br/>FROM reviews WHERE gameId=?)
            DB-->>ReviewService: Rating actualizado

            ReviewService->>Redis: DEL game:{gameId}<br/>(invalidar cache)
            Redis-->>ReviewService: OK

            ReviewService-->>Kong: 201 Created<br/>{reviewId, message}
            Kong-->>Frontend: Success response
            Frontend-->>Usuario: Mostrar confirmaci√≥n
        end
    end
```

---

## üîç Flujo de B√∫squeda

### B√∫squeda de Juegos

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant GameService
    participant DB
    participant Redis

    Usuario->>Frontend: Escribe en barra b√∫squeda
    
    Frontend->>Frontend: Debounce 300ms<br/>Validar query (min 2 chars)

    Frontend->>Kong: GET /games/search?q=mario&genre=platform

    Kong->>GameService: Forward request

    GameService->>Redis: GET search:{hash(query)}

    alt Cache Hit (< 30 min)
        Redis-->>GameService: Resultados cacheados
        GameService-->>Kong: 200 OK<br/>{games, total}
    else Cache Miss
        Redis-->>GameService: null

        GameService->>DB: SELECT * FROM games<br/>WHERE title ILIKE '%mario%'<br/>AND genre = 'platform'<br/>ORDER BY rating DESC

        DB-->>GameService: Resultados b√∫squeda

        GameService->>Redis: SET search:{hash}<br/>TTL: 30min
        Redis-->>GameService: OK

        GameService-->>Kong: 200 OK<br/>{games, total}
    end

    Kong-->>Frontend: Search results
    Frontend-->>Usuario: Mostrar resultados
```

---

## üö® Flujo de Manejo de Errores

### Error de Servicio No Disponible

```mermaid
sequenceDiagram
    actor Usuario
    participant Frontend
    participant Kong
    participant GameService
    participant DB

    Usuario->>Frontend: Solicita lista juegos
    Frontend->>Kong: GET /games

    Kong->>GameService: Forward request

    GameService->>DB: Query games
    
    DB-->>GameService: Connection timeout

    GameService->>GameService: Log error<br/>Return 503 Service Unavailable

    GameService-->>Kong: 503 Error<br/>{error, message}

    Kong->>Kong: Log request<br/>Apply circuit breaker

    Kong-->>Frontend: 503 Service Unavailable

    Frontend->>Frontend: Mostrar fallback UI<br/>"Servicio temporalmente<br/>no disponible"

    Frontend-->>Usuario: P√°gina con mensaje error<br/>y bot√≥n "Reintentar"
```

---

## üìä Notas de Performance

<div className="bg-blue-50 p-4 rounded-lg">
  <h4 className="text-blue-800 font-semibold mb-2">üí° Optimizaciones Implementadas</h4>
  <ul className="text-blue-700 space-y-1">
    <li>‚Ä¢ <strong>Caching en Redis:</strong> TTL diferenciado seg√∫n tipo de datos</li>
    <li>‚Ä¢ <strong>Rate Limiting:</strong> Protecci√≥n contra abuso por endpoint</li>
    <li>‚Ä¢ <strong>JWT con TTL:</strong> Sesiones autom√°ticamente expiradas</li>
    <li>‚Ä¢ <strong>Debouncing:</strong> Reducci√≥n de requests en b√∫squeda</li>
    <li>‚Ä¢ <strong>Circuit Breaker:</strong> Manejo resiliente de fallos</li>
  </ul>
</div>