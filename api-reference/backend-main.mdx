---
title: "Backend - Repositorio Principal"
description: "Estructura y configuración del monorepo de microservicios backend"
icon: "server"
---

## Visión General

El repositorio **backend** contiene todos los microservicios de Retro Game Hub organizados en un monorepo. Cada servicio es independiente pero comparte configuración común y convenciones de código.

## Estructura del Proyecto

```
backend/
├── auth-service/              # Autenticación y autorización
│   ├── src/
│   │   ├── index.js
│   │   ├── controllers/
│   │   ├── services/
│   │   ├── repositories/
│   │   ├── middleware/
│   │   └── routes/
│   ├── tests/
│   ├── Dockerfile
│   └── package.json
│
├── user-service/              # Gestión de usuarios y perfiles
│   ├── src/
│   ├── tests/
│   ├── Dockerfile
│   └── package.json
│
├── game-catalog-service/      # Catálogo de juegos
│   ├── src/
│   ├── Dockerfile
│   └── package.json
│
├── score-service/             # Puntuaciones y sesiones
│   ├── src/
│   ├── tests/
│   ├── Dockerfile
│   └── package.json
│
├── ranking-service/           # Rankings y leaderboards
│   ├── src/
│   ├── tests/
│   ├── Dockerfile
│   └── package.json
│
├── docker-compose.yml         # Desarrollo local
├── .env.example               # Variables de entorno template
├── .gitignore
└── README.md
```

## Convenciones de Código

### Arquitectura por Capas

Todos los servicios siguen la misma arquitectura:

<Steps>
  <Step title="Routes">
    **Responsabilidad**: Definir endpoints HTTP y validación de entrada
    
    ```javascript
    // routes/authRoutes.js
    const express = require('express');
    const router = express.Router();
    const authController = require('../controllers/authController');
    const { validateLogin } = require('../middleware/validation');

    router.post('/login', validateLogin, authController.login);
    router.post('/register', authController.register);
    router.post('/verify', authController.verify);

    module.exports = router;
    ```
  </Step>
  
  <Step title="Controllers">
    **Responsabilidad**: Manejar requests HTTP, parsear input, devolver responses
    
    ```javascript
    // controllers/authController.js
    const authService = require('../services/authService');

    exports.login = async (req, res) => {
      try {
        const { username, password } = req.body;
        const result = await authService.authenticate(username, password);
        res.json(result);
      } catch (error) {
        res.status(401).json({ error: error.message });
      }
    };
    ```
  </Step>
  
  <Step title="Services">
    **Responsabilidad**: Lógica de negocio, orquestación de operaciones
    
    ```javascript
    // services/authService.js
    const authRepository = require('../repositories/authRepository');
    const bcrypt = require('bcryptjs');
    const jwt = require('jsonwebtoken');

    exports.authenticate = async (username, password) => {
      const user = await authRepository.findByUsername(username);
      if (!user) throw new Error('Invalid credentials');
      
      const valid = await bcrypt.compare(password, user.password_hash);
      if (!valid) throw new Error('Invalid credentials');
      
      const token = jwt.sign({ userId: user.id }, process.env.JWT_SECRET);
      return { token, user };
    };
    ```
  </Step>
  
  <Step title="Repositories">
    **Responsabilidad**: Acceso a base de datos, queries SQL
    
    ```javascript
    // repositories/authRepository.js
    const pool = require('../config/database');

    exports.findByUsername = async (username) => {
      const result = await pool.query(
        'SELECT * FROM users WHERE username = $1',
        [username]
      );
      return result.rows[0];
    };

    exports.create = async (userData) => {
      const result = await pool.query(
        'INSERT INTO users (username, email, password_hash) VALUES ($1, $2, $3) RETURNING *',
        [userData.username, userData.email, userData.password_hash]
      );
      return result.rows[0];
    };
    ```
  </Step>
</Steps>

## Dependencias Comunes

Todos los servicios comparten estas dependencias:

<Table>
  <thead>
    <tr>
      <th>Paquete</th>
      <th>Versión</th>
      <th>Propósito</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>**express**</td>
      <td>^4.18.0</td>
      <td>Framework HTTP</td>
    </tr>
    <tr>
      <td>**pg**</td>
      <td>^8.11.0</td>
      <td>Cliente PostgreSQL</td>
    </tr>
    <tr>
      <td>**redis**</td>
      <td>^4.6.0</td>
      <td>Cliente Redis (caché)</td>
    </tr>
    <tr>
      <td>**amqplib**</td>
      <td>^0.10.0</td>
      <td>Cliente RabbitMQ (eventos)</td>
    </tr>
    <tr>
      <td>**jsonwebtoken**</td>
      <td>^9.0.0</td>
      <td>Generación/validación JWT</td>
    </tr>
    <tr>
      <td>**joi**</td>
      <td>^17.9.0</td>
      <td>Validación de schemas</td>
    </tr>
    <tr>
      <td>**winston**</td>
      <td>^3.10.0</td>
      <td>Logging estructurado</td>
    </tr>
    <tr>
      <td>**prom-client**</td>
      <td>^14.2.0</td>
      <td>Métricas Prometheus</td>
    </tr>
    <tr>
      <td>**jest**</td>
      <td>^29.5.0</td>
      <td>Testing (dev)</td>
    </tr>
    <tr>
      <td>**supertest**</td>
      <td>^6.3.0</td>
      <td>Testing HTTP (dev)</td>
    </tr>
  </tbody>
</Table>

## Variables de Entorno

### Archivo .env.example

```bash
# Database (PostgreSQL)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=retrogamedb
DB_USER=postgres
DB_PASSWORD=yourpassword

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# RabbitMQ
RABBITMQ_URL=amqp://localhost:5672

# JWT
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d

# Service Ports
AUTH_SERVICE_PORT=3001
USER_SERVICE_PORT=3002
GAME_CATALOG_PORT=3003
SCORE_SERVICE_PORT=3004
RANKING_SERVICE_PORT=3005

# External Services
CDN_URL=http://localhost:8086

# Logging
LOG_LEVEL=info
NODE_ENV=development
```

## Docker Compose (Desarrollo Local)

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: retrogamedb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  auth-service:
    build: ./auth-service
    ports:
      - "3001:3001"
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - RABBITMQ_URL=amqp://rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq

  user-service:
    build: ./user-service
    ports:
      - "3002:3002"
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  game-catalog-service:
    build: ./game-catalog-service
    ports:
      - "3003:3003"
    environment:
      - DB_HOST=postgres
    depends_on:
      - postgres

  score-service:
    build: ./score-service
    ports:
      - "3004:3004"
    environment:
      - DB_HOST=postgres
      - RABBITMQ_URL=amqp://rabbitmq:5672
    depends_on:
      - postgres
      - rabbitmq

  ranking-service:
    build: ./ranking-service
    ports:
      - "3005:3005"
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - RABBITMQ_URL=amqp://rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq

volumes:
  postgres_data:
```

## Comandos de Desarrollo

### Iniciar todos los servicios

```bash
# Iniciar infraestructura (DB, Redis, RabbitMQ)
docker-compose up -d postgres redis rabbitmq

# Esperar a que estén listos
sleep 10

# Iniciar servicios en modo desarrollo
cd auth-service && npm run dev &
cd user-service && npm run dev &
cd game-catalog-service && npm run dev &
cd score-service && npm run dev &
cd ranking-service && npm run dev &
```

### Instalar dependencias en todos los servicios

```bash
for service in auth-service user-service game-catalog-service score-service ranking-service; do
  echo "Installing dependencies in $service..."
  cd $service && npm install && cd ..
done
```

### Ejecutar tests

```bash
# Test de un servicio específico
cd auth-service && npm test

# Test de todos los servicios
for service in auth-service user-service score-service ranking-service; do
  echo "Testing $service..."
  cd $service && npm test && cd ..
done
```

### Build de imágenes Docker

```bash
# Build de un servicio específico
docker build -t retrogame/auth-service:latest ./auth-service

# Build de todos los servicios
for service in auth-service user-service game-catalog-service score-service ranking-service; do
  echo "Building $service..."
  docker build -t retrogame/$service:latest ./$service
done
```

## Dockerfile Estándar

Todos los servicios usan un Dockerfile similar:

```dockerfile
FROM node:18-alpine

WORKDIR /app

# Copiar package files
COPY package*.json ./

# Instalar dependencias
RUN npm ci --only=production

# Copiar código fuente
COPY src/ ./src/

# Exponer puerto
EXPOSE 3001

# Usuario no-root
USER node

# Comando de inicio
CMD ["node", "src/index.js"]
```

## Scripts NPM Comunes

Todos los `package.json` incluyen estos scripts:

```json
{
  "scripts": {
    "start": "node src/index.js",
    "dev": "nodemon src/index.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/",
    "lint:fix": "eslint src/ --fix"
  }
}
```

## Inicialización de Base de Datos

### Script de migración común

```sql
-- migrations/001_initial_schema.sql

-- Tabla de usuarios (compartida)
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Índices
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);

-- Trigger de updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### Ejecutar migraciones

```bash
# Conexión a PostgreSQL
export PGPASSWORD=postgres
psql -h localhost -U postgres -d retrogamedb -f migrations/001_initial_schema.sql
```

## Logging

### Configuración de Winston

```javascript
// config/logger.js
const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: process.env.SERVICE_NAME },
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    })
  ]
});

module.exports = logger;
```

### Uso en servicios

```javascript
const logger = require('./config/logger');

logger.info('Service started', { port: 3001 });
logger.error('Database connection failed', { error: err.message });
logger.warn('High memory usage detected', { usage: '85%' });
```

## Métricas Prometheus

### Configuración común

```javascript
// config/metrics.js
const promClient = require('prom-client');

const register = new promClient.Registry();
promClient.collectDefaultMetrics({ register });

const httpRequestDuration = new promClient.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 5]
});

register.registerMetric(httpRequestDuration);

module.exports = { register, httpRequestDuration };
```

## Health Checks

### Endpoint estándar

```javascript
// routes/health.js
const express = require('express');
const router = express.Router();
const pool = require('../config/database');
const redis = require('../config/redis');

router.get('/health', async (req, res) => {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    checks: {}
  };

  // Check database
  try {
    await pool.query('SELECT 1');
    health.checks.database = 'ok';
  } catch (error) {
    health.checks.database = 'error';
    health.status = 'degraded';
  }

  // Check Redis (si aplica)
  try {
    await redis.ping();
    health.checks.redis = 'ok';
  } catch (error) {
    health.checks.redis = 'error';
    health.status = 'degraded';
  }

  res.status(health.status === 'ok' ? 200 : 503).json(health);
});

module.exports = router;
```

## Testing

### Configuración Jest

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/index.js'
  ],
  testMatch: ['**/tests/**/*.test.js'],
  setupFilesAfterEnv: ['<rootDir>/tests/setup.js']
};
```

### Test de ejemplo

```javascript
// tests/auth.test.js
const request = require('supertest');
const app = require('../src/app');
const pool = require('../src/config/database');

describe('Auth Service', () => {
  afterAll(async () => {
    await pool.end();
  });

  describe('POST /auth/login', () => {
    it('should return token for valid credentials', async () => {
      const response = await request(app)
        .post('/auth/login')
        .send({
          username: 'testuser',
          password: 'password123'
        });

      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty('token');
    });

    it('should return 401 for invalid credentials', async () => {
      const response = await request(app)
        .post('/auth/login')
        .send({
          username: 'testuser',
          password: 'wrongpassword'
        });

      expect(response.status).toBe(401);
    });
  });
});
```

## Documentación de Servicios

Para documentación detallada de cada servicio, consulta:

<CardGroup cols={2}>
  <Card title="Auth Service" icon="lock" href="/api-reference/auth-service">
    Autenticación y autorización
  </Card>
  <Card title="User Service" icon="user" href="/api-reference/user-service">
    Gestión de usuarios y perfiles
  </Card>
  <Card title="Game Catalog" icon="gamepad" href="/api-reference/game-catalog-service">
    Catálogo de juegos retro
  </Card>
  <Card title="Score Service" icon="trophy" href="/api-reference/score-service">
    Puntuaciones con anti-cheat
  </Card>
  <Card title="Ranking Service" icon="ranking-star" href="/api-reference/ranking-service">
    Leaderboards y rankings
  </Card>
</CardGroup>

## CI/CD

### GitHub Actions Workflow

```yaml
# .github/workflows/backend.yml
name: Backend CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, user-service, score-service, ranking-service]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd ${{ matrix.service }}
          npm ci
      
      - name: Run tests
        run: |
          cd ${{ matrix.service }}
          npm test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./${{ matrix.service }}/coverage/lcov.info
          flags: ${{ matrix.service }}

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Build and push Docker images
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          for service in auth-service user-service game-catalog-service score-service ranking-service; do
            docker build -t retrogame/$service:latest ./$service
            docker push retrogame/$service:latest
          done
```

## Próximos Pasos

<CardGroup cols={2}>
  <Card title="Frontend" icon="desktop" href="/api-reference/frontend">
    Aplicación web con js-dos
  </Card>
  <Card title="Kong Gateway" icon="route" href="/api-reference/kong-config">
    Configuración del API Gateway
  </Card>
  <Card title="Kubernetes" icon="dharmachakra" href="/api-reference/kubernetes-manifests">
    Manifests de despliegue
  </Card>
  <Card title="Infrastructure" icon="server" href="/api-reference/infrastructure-docs">
    Terraform y AWS
  </Card>
</CardGroup>
