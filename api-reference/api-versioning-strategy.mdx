---
title: "4.5. Versionado de APIs y Compatibilidad"
description: "Estrategia completa de versionado para APIs REST, manejo de breaking changes y garantÃ­a de compatibilidad hacia atrÃ¡s"
icon: "code-branch"
---

# 4.5. Versionado de APIs y Compatibilidad

Esta guÃ­a documenta la estrategia completa de versionado de APIs REST para los microservicios de RetroGameCloud, incluyendo polÃ­ticas de deprecaciÃ³n, manejo de breaking changes y compatibilidad hacia atrÃ¡s.

## Estrategia de Versionado

### Formato de Versionado

<Tabs>
<Tab title="URL Path Versioning">
```bash
# Estructura recomendada
https://api.retrogamecloud.com/v1/auth/login
https://api.retrogamecloud.com/v1/games
https://api.retrogamecloud.com/v2/user/profile
https://api.retrogamecloud.com/v2/ranking

# ConfiguraciÃ³n Kong
curl -X POST http://kong-admin:8001/services \
  --data name=game-catalog-v1 \
  --data url=http://game-catalog:3000/v1

curl -X POST http://kong-admin:8001/routes \
  --data service.name=game-catalog-v1 \
  --data paths[]=/v1/games
```
</Tab>
<Tab title="Header Versioning">
```bash
# Header de versiÃ³n
curl -H "API-Version: v2" \
     -H "Accept: application/vnd.retrogamecloud.v2+json" \
     https://api.retrogamecloud.com/games

# ImplementaciÃ³n en microservicio
app.use((req, res, next) => {
  const version = req.headers['api-version'] || 'v1';
  req.apiVersion = version;
  next();
});
```
</Tab>
<Tab title="Content Negotiation">
```bash
# Accept header con versiÃ³n
curl -H "Accept: application/vnd.retrogamecloud.v2+json" \
     https://api.retrogamecloud.com/games

# Respuesta con versiÃ³n
HTTP/1.1 200 OK
Content-Type: application/vnd.retrogamecloud.v2+json
API-Version: v2
```
</Tab>
</Tabs>

### Esquema de NumeraciÃ³n

<Note>
RetroGameCloud utiliza **versionado semÃ¡ntico simplificado** con formato `vX` donde X es un nÃºmero entero incremental.
</Note>

```yaml
# Incremento de versiones
v1: VersiÃ³n inicial estable
v2: Breaking changes mayores
v3: ReestructuraciÃ³n significativa

# Criterios para nueva versiÃ³n mayor
- Cambios en estructura de respuesta
- EliminaciÃ³n de campos existentes
- ModificaciÃ³n de tipos de datos
- Cambios en autenticaciÃ³n/autorizaciÃ³n
```

## PolÃ­tica de DeprecaciÃ³n

### Ciclo de Vida de Versiones

<Tabs>
<Tab title="Fases del Ciclo">
```mermaid
graph LR
    A[Desarrollo] --> B[Beta]
    B --> C[Estable]
    C --> D[Deprecada]
    D --> E[Descontinuada]
    
    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#e8f5e8
    style D fill:#fff8e1
    style E fill:#ffebee
```
</Tab>
<Tab title="Tiempos de Soporte">
```yaml
# PolÃ­tica de soporte temporal
VersiÃ³n Estable: Soporte completo indefinido
VersiÃ³n Deprecada: 12 meses de soporte
VersiÃ³n Descontinuada: 6 meses adicionales (solo bugs crÃ­ticos)

# ComunicaciÃ³n de cambios
- 6 meses antes: Anuncio de deprecaciÃ³n
- 3 meses antes: Notificaciones por email
- 1 mes antes: Headers de advertencia en respuestas
```
</Tab>
<Tab title="Headers de DeprecaciÃ³n">
```bash
# Headers automÃ¡ticos en versiones deprecadas
HTTP/1.1 200 OK
Warning: 299 - "This API version is deprecated"
Deprecation: true
Sunset: Sat, 31 Dec 2024 23:59:59 GMT
Link: <https://api.retrogamecloud.com/v2/games>; rel="successor-version"
```
</Tab>
</Tabs>

## Manejo de Breaking Changes

### Proceso de IntroducciÃ³n

<Warning>
Los breaking changes requieren **nueva versiÃ³n mayor** y seguimiento del proceso establecido.
</Warning>

<Tabs>
<Tab title="Proceso Completo">
```mermaid
flowchart TD
    A[Identificar Breaking Change] --> B[Planificar Nueva VersiÃ³n]
    B --> C[Desarrollar en Paralelo]
    C --> D[Testing Exhaustivo]
    D --> E[Documentar Cambios]
    E --> F[Comunicar a Consumidores]
    F --> G[Desplegar Nueva VersiÃ³n]
    G --> H[Monitorear AdopciÃ³n]
    H --> I[Deprecar VersiÃ³n Anterior]
```
</Tab>
<Tab title="Checklist de ValidaciÃ³n">
```yaml
Breaking Changes Checklist:
  â–¡ Nueva versiÃ³n mayor creada
  â–¡ DocumentaciÃ³n actualizada
  â–¡ Tests de compatibilidad ejecutados
  â–¡ GuÃ­a de migraciÃ³n creada
  â–¡ ComunicaciÃ³n enviada (email/Slack)
  â–¡ Kong configurado para enrutamiento
  â–¡ Monitoreo configurado
  â–¡ Plan de rollback preparado
```
</Tab>
<Tab title="ImplementaciÃ³n Gradual">
```javascript
// Middleware para A/B testing de versiones
const versionMiddleware = (req, res, next) => {
  const clientVersion = req.headers['api-version'] || 'v1';
  const rolloutPercentage = process.env.V2_ROLLOUT_PERCENTAGE || 0;
  
  // Gradual rollout para nuevos usuarios
  if (clientVersion === 'v1' && Math.random() * 100 < rolloutPercentage) {
    req.forceVersion = 'v2';
    res.set('API-Version-Override', 'v2');
  }
  
  next();
};
```
</Tab>
</Tabs>

## Versionado de Contratos OpenAPI

### Estructura de DocumentaciÃ³n

<Tabs>
<Tab title="OrganizaciÃ³n de Archivos">
```bash
docs/
â”œâ”€â”€ openapi/
â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”œâ”€â”€ auth-service.yaml
â”‚   â”‚   â”œâ”€â”€ game-catalog.yaml
â”‚   â”‚   â”œâ”€â”€ user-service.yaml
â”‚   â”‚   â””â”€â”€ score-service.yaml
â”‚   â”œâ”€â”€ v2/
â”‚   â”‚   â”œâ”€â”€ auth-service.yaml
â”‚   â”‚   â”œâ”€â”€ game-catalog.yaml
â”‚   â”‚   â””â”€â”€ user-service.yaml
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ components.yaml
â”‚       â””â”€â”€ security-schemes.yaml
```
</Tab>
<Tab title="Metadatos de VersiÃ³n">
```yaml
# openapi/v2/game-catalog.yaml
openapi: 3.0.3
info:
  title: Game Catalog API
  version: 2.0.0
  description: |
    Servicio de catÃ¡logo de juegos retro - VersiÃ³n 2
    
    **Cambios principales desde v1:**
    - Nuevo campo `tags` en respuesta de juegos
    - Eliminado campo `deprecated_categories`
    - PaginaciÃ³n mejorada con cursors
  contact:
    name: RetroGameCloud API Team
    email: api-support@retrogamecloud.com
  x-api-lifecycle: stable
  x-predecessor-version: "1.0.0"
  x-sunset-date: "2025-12-31"
```
</Tab>
<Tab title="GeneraciÃ³n AutomÃ¡tica">
```yaml
# .github/workflows/openapi-docs.yml
name: Generate OpenAPI Docs
on:
  push:
    paths: ['src/routes/**', 'docs/openapi/**']

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Generate OpenAPI specs
        run: |
          # Generar desde cÃ³digo fuente
          swagger-jsdoc -d docs/openapi/v2/base.yaml src/routes/v2/*.js > docs/openapi/v2/game-catalog.yaml
          
          # Validar especificaciones
          swagger-codegen validate -i docs/openapi/v2/game-catalog.yaml
          
          # Generar documentaciÃ³n estÃ¡tica
          redoc-cli build docs/openapi/v2/game-catalog.yaml --output public/docs/v2/game-catalog.html
```
</Tab>
</Tabs>

## Compatibilidad hacia AtrÃ¡s

### Estrategias de Mantenimiento

<Tabs>
<Tab title="Adaptadores de Respuesta">
```javascript
// middleware/version-adapter.js
const responseAdapters = {
  'v1': {
    adaptGameResponse: (gameData) => {
      // Convertir v2 response a formato v1
      return {
        id: gameData.id,
        title: gameData.title,
        category: gameData.categories[0], // v1 solo soporta una categorÃ­a
        year: gameData.releaseYear,
        // Omitir campos nuevos como 'tags', 'metadata'
      };
    }
  }
};

app.get('/games/:id', (req, res) => {
  const version = req.apiVersion || 'v2';
  const gameData = await gameService.getGame(req.params.id);
  
  if (version === 'v1') {
    const adaptedData = responseAdapters.v1.adaptGameResponse(gameData);
    res.json(adaptedData);
  } else {
    res.json(gameData);
  }
});
```
</Tab>
<Tab title="Campos Opcionales">
```javascript
// Manejo de campos opcionales para compatibilidad
const gameSchema = {
  v1: {
    required: ['id', 'title', 'category'],
    optional: ['description', 'year']
  },
  v2: {
    required: ['id', 'title', 'categories'], 
    optional: ['description', 'releaseYear', 'tags', 'metadata']
  }
};

// ValidaciÃ³n por versiÃ³n
const validateGameData = (data, version) => {
  const schema = gameSchema[version];
  // Implementar validaciÃ³n especÃ­fica por versiÃ³n
};
```
</Tab>
<Tab title="Base de Datos AgnÃ³stica">
```sql
-- DiseÃ±o de esquema compatible con mÃºltiples versiones
CREATE TABLE games (
  id UUID PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  
  -- Campos v1 (legacy)
  category VARCHAR(100),          -- deprecated, usar game_categories
  year INTEGER,                   -- deprecated, usar release_year
  
  -- Campos v2+
  release_year INTEGER,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- Metadatos extensibles
  metadata JSONB DEFAULT '{}'::jsonb
);

-- Tabla de categorÃ­as (v2+)
CREATE TABLE game_categories (
  game_id UUID REFERENCES games(id),
  category_name VARCHAR(100),
  PRIMARY KEY (game_id, category_name)
);
```
</Tab>
</Tabs>

## Estrategia de ComunicaciÃ³n

### Canales de NotificaciÃ³n

<Tabs>
<Tab title="ComunicaciÃ³n Automatizada">
```javascript
// services/api-communication.js
const notificationService = {
  async notifyDeprecation(version, sunsetDate) {
    const consumers = await getAPIConsumers(version);
    
    for (const consumer of consumers) {
      // Email notification
      await emailService.send({
        to: consumer.email,
        template: 'api-deprecation',
        data: {
          version,
          sunsetDate: sunsetDate.toISOString(),
          migrationGuide: `https://docs.retrogamecloud.com/migration/${version}`
        }
      });
      
      // Slack notification para equipos internos
      if (consumer.isInternal) {
        await slackService.postMessage({
          channel: consumer.slackChannel,
          text: `ðŸš¨ API v${version} serÃ¡ deprecada el ${sunsetDate.toLocaleDateString()}`
        });
      }
    }
  }
};
```
</Tab>
<Tab title="Dashboard de Versiones">
```yaml
# MÃ©tricas en Grafana dashboard
API Version Usage:
  - Requests por versiÃ³n (Ãºltimos 30 dÃ­as)
  - DistribuciÃ³n de consumers por versiÃ³n
  - Tiempo promedio de migraciÃ³n
  - Errores por versiÃ³n deprecated

Alertas Configuradas:
  - Usage de versiÃ³n deprecated > 10%
  - Nuevos consumers usando versiÃ³n deprecated
  - Fallos en migraciÃ³n > 5%
```
</Tab>
<Tab title="DocumentaciÃ³n Centralizada">
```markdown
# Portal de desarrolladores
## Estado de Versiones API

| VersiÃ³n | Estado | Sunset Date | DocumentaciÃ³n | MigraciÃ³n |
|---------|--------|-------------|---------------|-----------|
| v1      | ðŸŸ¡ Deprecated | 2024-12-31 | [Docs v1] | [GuÃ­a v1â†’v2] |
| v2      | ðŸŸ¢ Stable | - | [Docs v2] | - |
| v3      | ðŸ”µ Beta | - | [Docs v3 Beta] | [Preview v2â†’v3] |

## Changelog Detallado
- **v2.1.0** (2024-01-15): Nuevos campos metadata en respuesta de juegos
- **v2.0.0** (2023-11-01): Breaking change - reestructuraciÃ³n de categorÃ­as
```
</Tab>
</Tabs>

## Ejemplos de MigraciÃ³n

### MigraciÃ³n v1 â†’ v2

<Tabs>
<Tab title="Cambios en Game Catalog">
```javascript
// v1 - Estructura antigua
{
  "id": "game-123",
  "title": "Pac-Man",
  "category": "arcade",      // String Ãºnico
  "year": 1980,              // Campo year
  "description": "Classic arcade game"
}

// v2 - Nueva estructura  
{
  "id": "game-123",
  "title": "Pac-Man",
  "categories": ["arcade", "classic"],  // Array de categorÃ­as
  "releaseYear": 1980,                  // Campo renombrado
  "tags": ["maze", "ghosts"],           // Nuevo campo
  "metadata": {                         // Metadatos extensibles
    "difficulty": "medium",
    "players": "1"
  },
  "description": "Classic arcade game"
}
```
</Tab>
<Tab title="CÃ³digo de Cliente - Antes">
```javascript
// Cliente v1 - CÃ³digo existente
async function getGameInfo(gameId) {
  const response = await fetch(`/v1/games/${gameId}`);
  const game = await response.json();
  
  return {
    name: game.title,
    type: game.category,        // Una sola categorÃ­a
    releaseYear: game.year,
    info: game.description
  };
}

// Mostrar en UI
const gameInfo = await getGameInfo('pac-man');
console.log(`${gameInfo.name} (${gameInfo.type})`);
```
</Tab>
<Tab title="CÃ³digo de Cliente - DespuÃ©s">
```javascript
// Cliente v2 - CÃ³digo actualizado
async function getGameInfo(gameId) {
  const response = await fetch(`/v2/games/${gameId}`);
  const
</Tab>
</Tabs>
```