---
title: "Score Service"
description: "API para gestionar puntuaciones de jugadores"
icon: "trophy"
---

## Base URL

```
Production:  https://api.retrogamehub.games/scores
Development: http://localhost:3003
```

<Warning>
  Todos los endpoints requieren autenticación JWT.
</Warning>

## Endpoints

### POST /scores

Envía una nueva puntuación para un juego.

**Headers:**
```
Authorization: Bearer <token>
Content-Type: application/json
```

**Request Body:**

```json
{
  "game_slug": "doom",
  "score": 125000,
  "session_id": "abc-123-xyz",
  "metadata": {
    "level": 8,
    "time_played": 3600,
    "deaths": 5
  }
}
```

**Response 200:**

```json
{
  "message": "¡Nuevo récord personal!",
  "score": 125000,
  "is_highscore": true,
  "rank": 42,
  "total_players": 1547,
  "previous_score": 98000
}
```

**Lógica:**
- Solo guarda el score si es mayor que el anterior del jugador
- Calcula el ranking actualizado en tiempo real
- Publica evento para invalidar caché de rankings
- Valida que el score esté en rangos válidos

---

### GET /scores/user/:userId

Obtiene todas las puntuaciones de un usuario.

```bash
curl https://api.retrogamehub.games/scores/user/123 \
  -H "Authorization: Bearer <token>"
```

**Response 200:**

```json
{
  "user_id": 123,
  "username": "player1",
  "scores": [
    {
      "game_id": 1,
      "game_name": "DOOM",
      "game_slug": "doom",
      "score": 125000,
      "rank": 42,
      "total_players": 1547,
      "submitted_at": "2025-11-19T15:30:00Z"
    },
    {
      "game_id": 2,
      "game_name": "Duke Nukem 3D",
      "game_slug": "duke3d",
      "score": 87500,
      "rank": 156,
      "total_players": 892,
      "submitted_at": "2025-11-18T10:00:00Z"
    }
  ],
  "total_games_played": 2,
  "total_score": 212500,
  "average_rank": 99
}
```

---

### GET /scores/game/:slug

Obtiene el top 100 de puntuaciones para un juego.

```bash
curl "https://api.retrogamehub.games/scores/game/doom?limit=10"
```

**Query Parameters:**

| Parámetro | Tipo | Default | Descripción |
|-----------|------|---------|-------------|
| limit | number | 100 | Máximo 100 |
| offset | number | 0 | Para paginación |

**Response 200:**

```json
{
  "game_slug": "doom",
  "game_name": "DOOM",
  "scores": [
    {
      "rank": 1,
      "user_id": 42,
      "username": "progamer",
      "display_name": "Pro Gamer",
      "score": 250000,
      "submitted_at": "2025-11-15T20:00:00Z"
    },
    {
      "rank": 2,
      "user_id": 89,
      "username": "speedrunner",
      "display_name": "Speed Runner",
      "score": 198500,
      "submitted_at": "2025-11-18T14:30:00Z"
    }
  ],
  "total_players": 1547,
  "limit": 100,
  "offset": 0
}
```

---

### GET /scores/game/:slug/user/:userId

Obtiene la puntuación de un usuario específico en un juego.

```bash
curl https://api.retrogamehub.games/scores/game/doom/user/123 \
  -H "Authorization: Bearer <token>"
```

**Response 200:**

```json
{
  "game_slug": "doom",
  "user_id": 123,
  "username": "player1",
  "score": 125000,
  "rank": 42,
  "total_players": 1547,
  "percentile": 97.3,
  "submitted_at": "2025-11-19T15:30:00Z",
  "metadata": {
    "level": 8,
    "time_played": 3600,
    "deaths": 5
  }
}
```

**Response 404:**

```json
{
  "error": "Usuario no ha jugado este juego"
}
```

---

### DELETE /scores/user/:userId/game/:slug (Admin)

Elimina la puntuación de un usuario en un juego específico.

<Warning>
  Solo administradores. Útil para eliminar scores fraudulentos.
</Warning>

**Response 200:**

```json
{
  "message": "Puntuación eliminada",
  "deleted": {
    "user_id": 123,
    "game_slug": "doom",
    "score": 125000
  }
}
```

---

## Anti-Cheat

### Session ID

Cada sesión de juego genera un ID único que se valida:

```javascript
function generateSessionId() {
  const userId = getCurrentUserId();
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 9);
  
  return `${userId}-${timestamp}-${random}`;
}
```

### Validación de Rangos

Cada juego tiene rangos válidos de puntuación:

```javascript
const scoreRanges = {
  'doom': { min: 0, max: 999999 },
  'tetris': { min: 0, max: 999999 },
  'duke3d': { min: 0, max: 9999999 }
};

function validateScore(gameSlug, score) {
  const range = scoreRanges[gameSlug];
  return score >= range.min && score <= range.max;
}
```

### Rate Limiting Estricto

```
- 1 score cada 30 segundos por usuario/juego
- Máximo 20 scores por hora por usuario
- Bloqueo automático si se detecta patrón sospechoso
```

---

## Eventos Publicados

Cuando se guarda un highscore, se publica un evento RabbitMQ:

```json
{
  "event": "score.highscore",
  "timestamp": "2025-11-19T15:30:00Z",
  "data": {
    "user_id": 123,
    "game_slug": "doom",
    "score": 125000,
    "rank": 42,
    "previous_score": 98000
  }
}
```

**Consumidores:**
- `ranking-service`: Invalida caché de rankings
- `notification-service` (futuro): Envía notificaciones
- `achievement-service` (futuro): Verifica logros

---

## Base de Datos

### Esquema `scores`

```sql
CREATE TABLE scores (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  game_id INTEGER NOT NULL REFERENCES games(id) ON DELETE CASCADE,
  score BIGINT NOT NULL CHECK (score >= 0),
  session_id VARCHAR(100),
  metadata JSONB,
  submitted_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(user_id, game_id)
);

CREATE INDEX idx_scores_game ON scores(game_id, score DESC);
CREATE INDEX idx_scores_user ON scores(user_id);
CREATE INDEX idx_scores_session ON scores(session_id);
```

### Queries Optimizadas

```sql
-- Top 100 de un juego
SELECT 
  u.id as user_id,
  u.username,
  u.display_name,
  s.score,
  s.submitted_at,
  RANK() OVER (ORDER BY s.score DESC) as rank
FROM scores s
JOIN users u ON u.id = s.user_id
WHERE s.game_id = $1
ORDER BY s.score DESC
LIMIT 100;

-- Ranking de un usuario en un juego
WITH ranked_scores AS (
  SELECT 
    user_id,
    score,
    RANK() OVER (ORDER BY score DESC) as rank
  FROM scores
  WHERE game_id = $1
)
SELECT * FROM ranked_scores
WHERE user_id = $2;
```

---

## Ejemplo de Implementación Completa

```javascript
class ScoreTracker {
  constructor(gameSlug, userId, token) {
    this.gameSlug = gameSlug;
    this.userId = userId;
    this.token = token;
    this.currentScore = 0;
    this.lastSubmitted = 0;
    this.sessionId = this.generateSessionId();
    this.pollingInterval = null;
  }
  
  start(dosInstance) {
    // Detectar score cada 5 segundos
    this.pollingInterval = setInterval(() => {
      this.detectScore(dosInstance);
    }, 5000);
  }
  
  stop() {
    if (this.pollingInterval) {
      clearInterval(this.pollingInterval);
    }
  }
  
  async detectScore(dosInstance) {
    const memory = await dosInstance.getMemory();
    const addresses = this.getScoreAddresses(this.gameSlug);
    
    for (const addr of addresses) {
      const value = memory.readUint32(addr);
      
      if (value > this.currentScore && value < 10000000) {
        this.currentScore = value;
        await this.maybeSubmitScore(value);
        break;
      }
    }
  }
  
  async maybeSubmitScore(score) {
    const now = Date.now();
    const timeSinceLastSubmit = now - this.lastSubmitted;
    
    // Solo enviar cada 30 segundos mínimo
    if (timeSinceLastSubmit < 30000) {
      return;
    }
    
    try {
      const response = await fetch(
        'https://api.retrogamehub.games/scores',
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${this.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            game_slug: this.gameSlug,
            score: score,
            session_id: this.sessionId,
            metadata: {
              timestamp: now,
              user_agent: navigator.userAgent
            }
          })
        }
      );
      
      const data = await response.json();
      
      if (data.is_highscore) {
        this.showNotification(
          `¡Nuevo récord! Posición #${data.rank}`
        );
      }
      
      this.lastSubmitted = now;
      
    } catch (error) {
      console.error('Error submitting score:', error);
    }
  }
  
  generateSessionId() {
    return `${this.userId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
  
  getScoreAddresses(gameSlug) {
    const addresses = {
      'doom': [0x10000, 0x20000],
      'tetris': [0x5000, 0x6000],
      'duke3d': [0x15000, 0x25000]
    };
    
    return addresses[gameSlug] || [];
  }
  
  showNotification(message) {
    const notif = document.createElement('div');
    notif.className = 'score-notification';
    notif.textContent = message;
    document.body.appendChild(notif);
    
    setTimeout(() => notif.remove(), 5000);
  }
}

// Uso
const tracker = new ScoreTracker('doom', userId, token);
tracker.start(dosInstance);

window.addEventListener('beforeunload', () => {
  tracker.stop();
});
```

---

## Variables de Entorno

```bash
# Score Service
PORT=3003
DB_HOST=postgres
DB_PORT=5432
DB_NAME=retrogame_scores
DB_USER=postgres
DB_PASSWORD=secure_password

# RabbitMQ
RABBITMQ_URL=amqp://rabbitmq:5672
RABBITMQ_EXCHANGE=retrogame_events
RABBITMQ_QUEUE=score_events

# Anti-Cheat
SCORE_SUBMIT_COOLDOWN=30000  # 30 segundos
MAX_SCORES_PER_HOUR=20
```

---

## Próximos Pasos

<CardGroup cols={2}>
  <Card title="Rankings" icon="ranking-star" href="/api-reference/ranking-service">
    Consulta rankings globales
  </Card>
  <Card title="User Profiles" icon="user" href="/api-reference/user-service">
    Gestiona perfiles de usuario
  </Card>
</CardGroup>
