---
title: Backend Unificado
sidebarTitle: 2.1. Backend Unificado
description: Servicio backend consolidado con autenticaciÃ³n, usuarios, puntuaciones y rankings
icon: server
---

## DescripciÃ³n

Servicio backend **unificado** para RetroGameCloud que consolida toda la lÃ³gica de negocio en una Ãºnica aplicaciÃ³n Node.js/Express. Este servicio reemplaza la arquitectura de microservicios anterior, proporcionando autenticaciÃ³n JWT, gestiÃ³n de usuarios, catÃ¡logo de juegos, puntuaciones y rankings desde una sola base de datos PostgreSQL.

<CardGroup cols={3}>
  <Card title="API Unificada" icon="code">
    Todos los endpoints en un solo servicio
  </Card>
  <Card title="PostgreSQL Ãšnico" icon="database">
    Una sola base de datos para todo
  </Card>
  <Card title="JWT Bearer" icon="shield">
    AutenticaciÃ³n con tokens seguros
  </Card>
</CardGroup>

## Arquitectura del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND                              â”‚
â”‚                    (Puerto 8081)                             â”‚
â”‚         HTML/CSS/JS + localStorage para tokens               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ HTTP/REST
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KONG API GATEWAY                          â”‚
â”‚                      (Puerto 8000)                           â”‚
â”‚         Enrutamiento + CORS + Rate Limiting                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ /api/auth/*
                   â”‚ /api/scores/*
                   â”‚ /api/rankings/*
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BACKEND SERVICE (Puerto 3000)                   â”‚
â”‚                    Node.js + Express                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ AutenticaciÃ³n (JWT + bcrypt)                    â”‚    â”‚
â”‚  â”‚  â€¢ GestiÃ³n de Usuarios                             â”‚    â”‚
â”‚  â”‚  â€¢ Registro de Puntuaciones                        â”‚    â”‚
â”‚  â”‚  â€¢ Rankings y EstadÃ­sticas                         â”‚    â”‚
â”‚  â”‚  â€¢ CatÃ¡logo de Juegos                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ PostgreSQL Protocol
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              POSTGRESQL DATABASE                             â”‚
â”‚                   (Puerto 5432)                              â”‚
â”‚                                                              â”‚
â”‚  Tablas:                                                     â”‚
â”‚  â”œâ”€â”€ users (autenticaciÃ³n y perfiles)                       â”‚
â”‚  â”œâ”€â”€ games (catÃ¡logo de juegos)                             â”‚
â”‚  â”œâ”€â”€ scores (puntuaciones actuales)                         â”‚
â”‚  â”œâ”€â”€ score_history (historial de cambios)                   â”‚
â”‚  â”œâ”€â”€ user_stats (estadÃ­sticas agregadas)                    â”‚
â”‚  â””â”€â”€ refresh_tokens (gestiÃ³n de sesiones)                   â”‚
â”‚                                                              â”‚
â”‚  ğŸ”§ Auto-inicializaciÃ³n de esquema al primer arranque       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Stack TecnolÃ³gico

| Componente | VersiÃ³n | DescripciÃ³n |
|-----------|---------|-------------|
| **Node.js** | 20 LTS Alpine | Runtime JavaScript |
| **Express** | 4.18+ | Framework web |
| **PostgreSQL** | 15 | Base de datos Ãºnica |
| **jsonwebtoken** | 9.0+ | JWT para autenticaciÃ³n |
| **bcrypt** | 5.1+ | Hashing de contraseÃ±as |
| **pg** | 8.11+ | Cliente PostgreSQL |

## ConsolidaciÃ³n de Microservicios

Este servicio **consolida** lo que antes eran 5 microservicios separados:

| Antes (Microservicio) | Ahora (MÃ³dulo) |
|-------|-------|
| `auth-service` :3001 | `/src/services/authService.js` |
| `user-service` :3002 | `/src/services/userService.js` |
| `game-catalog-service` :3003 | `/src/services/gameService.js` |
| `score-service` :3004 | `/src/services/scoreService.js` |
| `ranking-service` :3005 | `/src/services/rankingService.js` |

### Ventajas de la ConsolidaciÃ³n

<AccordionGroup>
  <Accordion title="âœ… Menor Complejidad Operacional">
    - Un solo servicio para desplegar
    - Sin orquestaciÃ³n compleja de microservicios
    - Deployment simplificado
    - Menos configuraciÃ³n de red
  </Accordion>

  <Accordion title="âœ… Transacciones ACID">
    - Operaciones atÃ³micas entre tablas
    - Consistencia garantizada
    - Sin eventual consistency
    - Rollbacks completos
  </Accordion>

  <Accordion title="âœ… ReducciÃ³n de Latencia">
    - Sin llamadas HTTP entre servicios
    - Todo en memoria (misma aplicaciÃ³n)
    - Queries directos a PostgreSQL
    - Menor overhead de red
  </Accordion>

  <Accordion title="âœ… Base de Datos Ãšnica">
    - Esquema coherente
    - Foreign keys reales
    - Joins eficientes
    - Sin sincronizaciÃ³n de datos
  </Accordion>
</AccordionGroup>

## Estructura del Proyecto

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js              # Entry point del servidor
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ database.js       # ConexiÃ³n PostgreSQL
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ authController.js    # LÃ³gica de autenticaciÃ³n
â”‚   â”‚   â”œâ”€â”€ scoreController.js   # LÃ³gica de puntuaciones
â”‚   â”‚   â””â”€â”€ rankingController.js # LÃ³gica de rankings
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ authMiddleware.js    # VerificaciÃ³n de JWT
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ authRepository.js    # DB queries para users
â”‚   â”‚   â””â”€â”€ scoreRepository.js   # DB queries para scores
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ authService.js       # LÃ³gica de negocio auth
â”‚   â”‚   â”œâ”€â”€ userService.js       # LÃ³gica de negocio users
â”‚   â”‚   â”œâ”€â”€ scoreService.js      # LÃ³gica de negocio scores
â”‚   â”‚   â””â”€â”€ rankingService.js    # LÃ³gica de negocio rankings
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ authRoutes.js        # DefiniciÃ³n de rutas API
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ auth.test.js
â”‚   â”œâ”€â”€ score.test.js
â”‚   â””â”€â”€ ranking.test.js
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ package.json
â””â”€â”€ .env.example
```

## Variables de Entorno

```bash
# Puerto del servicio
PORT=3000

# Base de datos PostgreSQL
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/retrogamedb

# JWT Configuration
JWT_SECRET=your-super-secret-key-change-in-production
JWT_EXPIRATION=24h

# Bcrypt
BCRYPT_SALT_ROUNDS=10

# Entorno
NODE_ENV=production
```

## Endpoints Principales

### AutenticaciÃ³n
```
POST   /api/auth/register     # Registro de usuario
POST   /api/auth/login        # Login y obtenciÃ³n de JWT
GET    /api/auth/verify       # Verificar token vÃ¡lido
```

### Usuarios
```
GET    /api/users/:id         # Obtener perfil de usuario
PUT    /api/users/:id         # Actualizar perfil
GET    /api/users/:id/stats   # EstadÃ­sticas de usuario
```

### Juegos
```
GET    /api/games             # Listar todos los juegos
GET    /api/games/:id         # Detalles de un juego
```

### Puntuaciones
```
POST   /api/scores            # Guardar puntuaciÃ³n (requiere JWT)
GET    /api/scores/user/:id   # Puntuaciones de un usuario
GET    /api/scores/game/:id   # Puntuaciones de un juego
```

### Rankings
```
GET    /api/rankings/global   # Ranking global
GET    /api/rankings/game/:id # Ranking por juego
```

## Despliegue

### Docker Compose

```yaml
services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: retrogamedb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD}@postgres:5432/retrogamedb
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3000
    depends_on:
      - postgres

volumes:
  postgres_data:
```

### Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: ghcr.io/retrogamecloud/backend:latest
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: backend-secrets
              key: database-url
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: backend-secrets
              key: jwt-secret
```

## PrÃ³ximos Pasos

<CardGroup cols={2}>
  <Card title="Esquema de Base de Datos" icon="database" href="/backend/database-schema">
    Tablas, relaciones y migrations
  </Card>
  <Card title="API Endpoints" icon="code" href="/backend/api-endpoints">
    DocumentaciÃ³n completa de la API
  </Card>
  <Card title="Frontend" icon="browser" href="/frontend/overview">
    CÃ³mo consumir la API desde el frontend
  </Card>
  <Card title="Kong Gateway" icon="shield" href="/kong/overview">
    ConfiguraciÃ³n del API Gateway
  </Card>
</CardGroup>
